<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Workflow Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        ocean: {
                            50: "#e6f7fb",
                            100: "#bfecf6",
                            200: "#87dde9",
                            300: "#4ac9da",
                            400: "#1fb1c7",
                            500: "#11607d",
                            600: "#0e4d63",
                            700: "#0c3d4e",
                            800: "#072833",
                            900: "#03161d",
                        },
                        aqua: {
                            50: "#f2ffff",
                            100: "#ccffff",
                            200: "#99ffff",
                            300: "#66ffff",
                            400: "#33ffff",
                            500: "#00ffff",
                            600: "#00cccc",
                            700: "#009999",
                            800: "#007373",
                            900: "#004d4d",
                        },
                        graystone: {
                            50: "#f7f7f7",
                            100: "#eeeeee",
                            200: "#dcdcdc",
                            300: "#c2c2c2",
                            400: "#b9b9b9",
                            500: "#8f8f8f",
                            600: "#6d6d6d",
                            700: "#4f4f4f",
                            800: "#323232",
                            900: "#1a1a1a",
                        },
                    },
                },
            },
        };
    </script>
    <style>
        body {
            background: #cfebf8;
            color: #1a1a1a;
            min-height: 100vh;
            font-family: "Neue Haas Grotesk Display Pro", "Helvetica Neue", Arial, sans-serif;
            letter-spacing: -0.01em;
            word-break: normal;
            overflow-wrap: break-word;
            hyphens: auto;
            overflow-x: hidden;
        }

        h1,
        h2,
        h3,
        h4,
        h5,
        h6,
        .heading,
        .card-title,
        .font-heading,
        .heading-font {
            font-family: "Impact", "Anton", "Arial Black", "Neue Plak Condensed", "Neue Plak", "Helvetica Neue", Arial, sans-serif;
            letter-spacing: -0.02em;
            text-transform: uppercase;
            font-weight: 900;
        }

        .dropdown-font {
            font-family: "Neue Haas Grotesk Display Pro", "Helvetica Neue", Arial, sans-serif;
            font-weight: 400;
            letter-spacing: 0.01em;
            text-transform: none;
        }

        .line-clamp-2 {
            display: -webkit-box;
            -webkit-box-orient: vertical;
            -webkit-line-clamp: 2;
            line-clamp: 2;
            overflow: hidden;
        }

        .select-control {
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            background-color: #ffffff;
            padding-right: 2rem;
            background-image: url("data:image/svg+xml,%3Csvg width='10' height='6' viewBox='0 0 12 7' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1.5L6 5.5L11 1.5' stroke='%2311607d' stroke-width='1.4' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 0.6rem;
        }

        .select-control:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(17, 96, 125, 0.2);
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 12px;
            height: 12px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: #4ac9da;
            /* Turquoise circle color */
            border-radius: 10px;
            border: 3px solid #f1f5f9;
            /* Creates the "floating" circle effect */
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #1fb1c7;
        }
    </style>
</head>

<body class="antialiased text-ocean-900 p-8">
    <div id="root"></div>

    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Clerk Authentication SDK -->
    <script
        async
        crossorigin="anonymous"
        data-clerk-publishable-key="pk_test_cmVmaW5lZC13YWhvby00NC5jbGVyay5hY2NvdW50cy5kZXYk"
        src="https://cdn.jsdelivr.net/npm/@clerk/clerk-js@latest/dist/clerk.browser.js"
    ></script>
    <!-- PDF Export Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // ============================================
        // AUTHENTICATION CONFIGURATION
        // ============================================
        const AUTH_CONFIG = {
            // Clerk publishable key from https://dashboard.clerk.com
            CLERK_PUBLISHABLE_KEY: "pk_test_cmVmaW5lZC13YWhvby00NC5jbGVyay5hY2NvdW50cy5kZXYk",
            // Set to true to enable authentication (set false for development)
            AUTH_ENABLED: true,
        };

        // ============================================
        // USER ROLES & PRE-SEEDED PROFILES
        // ============================================
        // This configuration is stored in the HTML file and can be modified by admins
        // In a production app, this would be stored in a database/SharePoint list
        const USERS_CONFIG = {
            // Admins can access Admin Console and manage other users
            admins: [
                "daniel.davis@populationmatters.org"
            ],

            // Managers can access Manager Hub
            managers: [
                "daniel.davis@populationmatters.org",
                "jameen.kaur@populationmatters.org"
            ],

            // Pre-seeded user profiles - when users sign up with these emails,
            // they'll be matched to these profiles automatically
            profiles: [
                {
                    email: "daniel.davis@populationmatters.org",
                    name: "Dan Davis",
                    team: "Advocacy & Influence",
                    role: "admin"
                },
                {
                    email: "jameen.kaur@populationmatters.org",
                    name: "Jameen Kaur",
                    team: "Advocacy & Influence",
                    role: "manager"
                },
                {
                    email: "emma.lewendon-strutt@populationmatters.org",
                    name: "Emma Lewendon-Strutt",
                    team: "Research",
                    role: "member"
                },
                {
                    email: "josh.hill@populationmatters.org",
                    name: "Josh Hill",
                    team: "Research",
                    role: "member"
                },
                {
                    email: "francesca.harrison@populationmatters.org",
                    name: "Francesca Harrison",
                    team: "Advocacy & Influence",
                    role: "member"
                },
                {
                    email: "madeleine.hewitt@populationmatters.org",
                    name: "Madeleine Hewitt",
                    team: "Advocacy & Influence",
                    role: "member"
                },
                {
                    email: "shweta.shirodkar@populationmatters.org",
                    name: "Shweta Shirodkar",
                    team: "Advocacy & Influence",
                    role: "member"
                }
            ]
        };

        // Helper functions for role checking
        const isAdmin = (email) => {
            if (!email) return false;
            return USERS_CONFIG.admins.some(e => e.toLowerCase() === email.toLowerCase());
        };

        const isManager = (email) => {
            if (!email) return false;
            return USERS_CONFIG.managers.some(e => e.toLowerCase() === email.toLowerCase());
        };

        const getPreseededProfile = (email) => {
            if (!email) return null;
            return USERS_CONFIG.profiles.find(p => p.email.toLowerCase() === email.toLowerCase());
        };

        // Functions to modify roles (called from AdminConsole)
        const addAdmin = (email) => {
            const normalized = email.toLowerCase().trim();
            if (!USERS_CONFIG.admins.some(e => e.toLowerCase() === normalized)) {
                USERS_CONFIG.admins.push(normalized);
            }
            // Also add to managers if not already there
            if (!USERS_CONFIG.managers.some(e => e.toLowerCase() === normalized)) {
                USERS_CONFIG.managers.push(normalized);
            }
        };

        const removeAdmin = (email) => {
            const normalized = email.toLowerCase().trim();
            USERS_CONFIG.admins = USERS_CONFIG.admins.filter(e => e.toLowerCase() !== normalized);
        };

        const addManager = (email) => {
            const normalized = email.toLowerCase().trim();
            if (!USERS_CONFIG.managers.some(e => e.toLowerCase() === normalized)) {
                USERS_CONFIG.managers.push(normalized);
            }
        };

        const removeManager = (email) => {
            const normalized = email.toLowerCase().trim();
            USERS_CONFIG.managers = USERS_CONFIG.managers.filter(e => e.toLowerCase() !== normalized);
        };

        const addProfile = (profile) => {
            const existing = USERS_CONFIG.profiles.findIndex(p =>
                p.email.toLowerCase() === profile.email.toLowerCase()
            );
            if (existing >= 0) {
                USERS_CONFIG.profiles[existing] = { ...USERS_CONFIG.profiles[existing], ...profile };
            } else {
                USERS_CONFIG.profiles.push(profile);
            }
        };

        // ============================================
        // PDF EXPORT UTILITY
        // ============================================
        const exportToPDF = async (elementId, filename, title) => {
            const { jsPDF } = window.jspdf;
            const element = document.getElementById(elementId);

            if (!element) {
                console.error('Export element not found:', elementId);
                return false;
            }

            try {
                // Show loading state
                const loadingOverlay = document.createElement('div');
                loadingOverlay.id = 'pdf-export-loading';
                loadingOverlay.innerHTML = `
                    <div style="position:fixed;inset:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:9999">
                        <div style="background:white;padding:24px 48px;border-radius:12px;text-align:center">
                            <div style="font-size:18px;font-weight:600;color:#0c4a6e;margin-bottom:8px">Generating PDF...</div>
                            <div style="font-size:14px;color:#64748b">Please wait</div>
                        </div>
                    </div>
                `;
                document.body.appendChild(loadingOverlay);

                // Capture the element
                const canvas = await html2canvas(element, {
                    scale: 2,
                    useCORS: true,
                    logging: false,
                    backgroundColor: '#f8fafc'
                });

                const imgData = canvas.toDataURL('image/png');
                const imgWidth = canvas.width;
                const imgHeight = canvas.height;

                // Calculate PDF dimensions (A4 landscape for wider content)
                const pdfWidth = 297; // A4 landscape width in mm
                const pdfHeight = 210; // A4 landscape height in mm
                const margin = 10;
                const contentWidth = pdfWidth - (margin * 2);

                // Scale image to fit width
                const ratio = contentWidth / (imgWidth / 2); // Divide by scale factor
                const scaledHeight = (imgHeight / 2) * ratio;

                // Create PDF
                const pdf = new jsPDF({
                    orientation: scaledHeight > pdfHeight ? 'portrait' : 'landscape',
                    unit: 'mm',
                    format: 'a4'
                });

                // Add title
                pdf.setFontSize(16);
                pdf.setTextColor(12, 74, 110); // ocean-900
                pdf.text(title || 'Export', margin, 15);

                // Add date
                pdf.setFontSize(10);
                pdf.setTextColor(100, 116, 139); // graystone-500
                pdf.text(`Generated: ${new Date().toLocaleDateString('en-GB', {
                    day: 'numeric',
                    month: 'long',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                })}`, margin, 22);

                // Calculate how many pages we need
                const pageContentHeight = (pdf.internal.pageSize.getHeight() - 30); // Leave space for header
                const totalPages = Math.ceil(scaledHeight / pageContentHeight);

                // Add image (may span multiple pages)
                if (totalPages === 1) {
                    pdf.addImage(imgData, 'PNG', margin, 28, contentWidth, scaledHeight);
                } else {
                    // Multi-page export
                    let yOffset = 0;
                    for (let page = 0; page < totalPages; page++) {
                        if (page > 0) {
                            pdf.addPage();
                        }

                        const sourceY = (page * pageContentHeight / ratio) * 2; // Convert back to canvas coords
                        const sourceHeight = Math.min((pageContentHeight / ratio) * 2, imgHeight - sourceY);

                        // Create a temporary canvas for this page section
                        const pageCanvas = document.createElement('canvas');
                        pageCanvas.width = imgWidth;
                        pageCanvas.height = sourceHeight;
                        const ctx = pageCanvas.getContext('2d');
                        ctx.drawImage(canvas, 0, sourceY, imgWidth, sourceHeight, 0, 0, imgWidth, sourceHeight);

                        const pageImgData = pageCanvas.toDataURL('image/png');
                        const pageScaledHeight = (sourceHeight / 2) * ratio;

                        pdf.addImage(pageImgData, 'PNG', margin, page === 0 ? 28 : 10, contentWidth, pageScaledHeight);
                    }
                }

                // Save the PDF
                pdf.save(`${filename || 'export'}_${new Date().toISOString().slice(0,10)}.pdf`);

                // Remove loading overlay
                document.body.removeChild(loadingOverlay);
                return true;

            } catch (error) {
                console.error('PDF export error:', error);
                const overlay = document.getElementById('pdf-export-loading');
                if (overlay) document.body.removeChild(overlay);
                return false;
            }
        };

        // --- SHAREPOINT API CONNECTOR ---
        const SP_API = {
            // 1. Get Security Token (Needed to save data)
            getDigest: async () => {
                try {
                    const r = await fetch("/_api/contextinfo", { method: "POST", headers: { "Accept": "application/json;odata=verbose" }});
                    const d = await r.json();
                    return d.d.GetContextWebInformation.FormDigestValue;
                } catch (e) { return ""; }
            },
            // 2. Get Real Logged-In User
            getCurrentUser: async () => {
                try {
                    const r = await fetch("/_api/web/currentuser", { headers: { "Accept": "application/json;odata=verbose" }});
                    const d = await r.json();
                    return d.d.Title; 
                } catch (e) { return "Guest"; }
            },
            // 3. Fetch Data
            fetchList: async (listName) => {
                const r = await fetch(`/_api/web/lists/getbytitle('${listName}')/items?$top=5000&$select=*,owner/Title,owner/EMail,collaborators/Title,collaborators/EMail&$expand=owner,collaborators`, { 
                    headers: { "Accept": "application/json;odata=verbose" }
                });
                const d = await r.json();
                return d.d.results;
            },
            // 4. Save New Item
            saveItem: async (listName, payload) => {
                const digest = await SP_API.getDigest();
                await fetch(`/_api/web/lists/getbytitle('${listName}')/items`, {
                    method: "POST",
                    body: JSON.stringify(payload),
                    headers: {
                        "Accept": "application/json;odata=verbose",
                        "Content-Type": "application/json;odata=verbose",
                        "X-RequestDigest": digest
                    }
                });
            },
            // 5. Update Existing Item
            updateItem: async (listName, id, payload) => {
                const digest = await SP_API.getDigest();
                await fetch(`/_api/web/lists/getbytitle('${listName}')/items(${id})`, {
                    method: "POST",
                    body: JSON.stringify(payload),
                    headers: {
                        "Accept": "application/json;odata=verbose",
                        "Content-Type": "application/json;odata=verbose",
                        "X-RequestDigest": digest,
                        "X-HTTP-Method": "MERGE",
                        "IF-MATCH": "*"
                    }
                });
            },
            // 6. Fetch Managers list (Title, Email, Team, Reports)
            fetchManagers: async () => {
                const r = await fetch(`/_api/web/lists/getbytitle('Managers')/items?$top=500&$select=Title,Email,Team,Reports/Title,Reports/EMail&$expand=Reports`, {
                    headers: { "Accept": "application/json;odata=verbose" }
                });
                const d = await r.json();
                return d.d?.results || [];
            }
        };

        // ============================================
        // CLERK AUTHENTICATION HELPER
        // ============================================
        let clerkInstance = null;

        const initClerk = async () => {
            if (!AUTH_CONFIG.AUTH_ENABLED) return null;
            if (clerkInstance) return clerkInstance;

            // Check if we're running on file:// protocol (local testing)
            if (window.location.protocol === 'file:') {
                console.warn("Clerk auth disabled: Running on file:// protocol. Deploy to a web server for authentication.");
                return null;
            }

            // Wait for Clerk to be ready (loaded via data-clerk-publishable-key attribute)
            // Clerk auto-initializes when loaded this way
            try {
                // Wait up to 5 seconds for Clerk to load
                let attempts = 0;
                while (!window.Clerk && attempts < 50) {
                    await new Promise(resolve => setTimeout(resolve, 100));
                    attempts++;
                }

                if (!window.Clerk) {
                    console.warn("Clerk SDK not loaded. Authentication will be disabled.");
                    return null;
                }

                // If Clerk is already loaded (as an object, not constructor), use it directly
                if (typeof window.Clerk === 'object' && window.Clerk.load) {
                    clerkInstance = window.Clerk;
                    if (!clerkInstance.loaded) {
                        await clerkInstance.load();
                    }
                    return clerkInstance;
                }

                // Fallback: Clerk might be a constructor (older versions)
                if (typeof window.Clerk === 'function') {
                    clerkInstance = new window.Clerk(AUTH_CONFIG.CLERK_PUBLISHABLE_KEY);
                    await clerkInstance.load();
                    return clerkInstance;
                }

                console.warn("Clerk SDK format not recognized.");
                return null;
            } catch (e) {
                console.error("Failed to initialize Clerk:", e);
                return null;
            }
        };

        // ============================================
        // LOGIN SCREEN COMPONENT
        // ============================================
        function LoginScreen({ onAuthChange }) {
            const [mode, setMode] = useState('signin'); // 'signin' or 'signup'
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');
            const [loading, setLoading] = useState(false);
            const [clerk, setClerk] = useState(null);

            useEffect(() => {
                initClerk().then(setClerk);
            }, []);

            const handleSignIn = async (e) => {
                e.preventDefault();
                if (!clerk) return;
                setLoading(true);
                setError('');

                try {
                    const result = await clerk.client.signIn.create({
                        identifier: email,
                        password: password,
                    });

                    if (result.status === 'complete') {
                        await clerk.setActive({ session: result.createdSessionId });
                        onAuthChange(clerk.user);
                    } else {
                        setError('Sign in incomplete. Please try again.');
                    }
                } catch (err) {
                    setError(err.errors?.[0]?.message || 'Sign in failed. Please check your credentials.');
                } finally {
                    setLoading(false);
                }
            };

            const handleSignUp = async (e) => {
                e.preventDefault();
                if (!clerk) return;
                setLoading(true);
                setError('');

                try {
                    const result = await clerk.client.signUp.create({
                        emailAddress: email,
                        password: password,
                    });

                    if (result.status === 'complete') {
                        await clerk.setActive({ session: result.createdSessionId });
                        onAuthChange(clerk.user);
                    } else if (result.status === 'missing_requirements') {
                        // Email verification required
                        await result.prepareEmailAddressVerification();
                        setError('Please check your email for a verification link.');
                    }
                } catch (err) {
                    setError(err.errors?.[0]?.message || 'Sign up failed. Please try again.');
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="min-h-screen flex items-center justify-center" style={{ backgroundColor: '#cfebf8' }}>
                    <div className="bg-white rounded-2xl shadow-xl p-8 w-full max-w-md">
                        <div className="text-center mb-8">
                            <h1 className="text-3xl font-bold text-ocean-900 mb-2">Workflow Manager</h1>
                            <p className="text-graystone-600">
                                {mode === 'signin' ? 'Sign in to your account' : 'Create your account'}
                            </p>
                        </div>

                        {error && (
                            <div className="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg mb-4 text-sm">
                                {error}
                            </div>
                        )}

                        <form onSubmit={mode === 'signin' ? handleSignIn : handleSignUp} className="space-y-4">
                            <div>
                                <label className="block text-sm font-medium text-graystone-700 mb-1">Email</label>
                                <input
                                    type="email"
                                    value={email}
                                    onChange={(e) => setEmail(e.target.value)}
                                    className="w-full px-4 py-3 border border-graystone-300 rounded-xl focus:ring-2 focus:ring-ocean-500 focus:border-ocean-500 outline-none transition"
                                    placeholder="you@example.com"
                                    required
                                />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-graystone-700 mb-1">Password</label>
                                <input
                                    type="password"
                                    value={password}
                                    onChange={(e) => setPassword(e.target.value)}
                                    className="w-full px-4 py-3 border border-graystone-300 rounded-xl focus:ring-2 focus:ring-ocean-500 focus:border-ocean-500 outline-none transition"
                                    placeholder="••••••••"
                                    required
                                    minLength={8}
                                />
                            </div>
                            <button
                                type="submit"
                                disabled={loading || !clerk}
                                className="w-full bg-ocean-500 text-white py-3 rounded-xl font-semibold hover:bg-ocean-600 disabled:opacity-50 disabled:cursor-not-allowed transition"
                            >
                                {loading ? 'Please wait...' : (mode === 'signin' ? 'Sign In' : 'Create Account')}
                            </button>
                        </form>

                        <div className="mt-6 text-center">
                            {mode === 'signin' ? (
                                <p className="text-sm text-graystone-600">
                                    Don't have an account?{' '}
                                    <button
                                        onClick={() => { setMode('signup'); setError(''); }}
                                        className="text-ocean-600 font-semibold hover:underline"
                                    >
                                        Sign up
                                    </button>
                                </p>
                            ) : (
                                <p className="text-sm text-graystone-600">
                                    Already have an account?{' '}
                                    <button
                                        onClick={() => { setMode('signin'); setError(''); }}
                                        className="text-ocean-600 font-semibold hover:underline"
                                    >
                                        Sign in
                                    </button>
                                </p>
                            )}
                        </div>

                        {!clerk && AUTH_CONFIG.AUTH_ENABLED && (
                            <div className="mt-4 text-center text-sm text-amber-600">
                                Loading authentication...
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        // ============================================
        // ADMIN CONSOLE COMPONENT
        // ============================================
        function AdminConsole({ onBack, currentUserEmail, onConfigChange }) {
            const [activeTab, setActiveTab] = useState('invites'); // 'invites', 'admins', 'managers', 'profiles'
            const [inviteEmail, setInviteEmail] = useState('');
            const [invites, setInvites] = useState([]);
            const [sending, setSending] = useState(false);
            const [message, setMessage] = useState({ type: '', text: '' });
            const [clerk, setClerk] = useState(null);

            // For adding new admins/managers
            const [newAdminEmail, setNewAdminEmail] = useState('');
            const [newManagerEmail, setNewManagerEmail] = useState('');

            // For adding new profiles
            const [newProfile, setNewProfile] = useState({ email: '', name: '', team: TEAMS[0], role: 'member' });

            // Force re-render when config changes
            const [, forceUpdate] = useState(0);

            useEffect(() => {
                initClerk().then(setClerk);
            }, []);

            const handleSendInvite = async (e) => {
                e.preventDefault();
                if (!inviteEmail.trim()) return;

                setSending(true);
                setMessage({ type: '', text: '' });

                try {
                    // Add to pre-seeded profiles if not exists
                    if (!getPreseededProfile(inviteEmail)) {
                        addProfile({
                            email: inviteEmail.toLowerCase().trim(),
                            name: inviteEmail.split('@')[0].replace(/[._]/g, ' ').replace(/\b\w/g, c => c.toUpperCase()),
                            team: TEAMS[0],
                            role: 'member'
                        });
                    }

                    setInvites(prev => [...prev, {
                        email: inviteEmail,
                        sentAt: new Date().toISOString(),
                        status: 'pending'
                    }]);

                    setMessage({ type: 'success', text: `Invitation recorded for ${inviteEmail}. Add user in Clerk Dashboard to complete.` });
                    setInviteEmail('');
                    forceUpdate(n => n + 1);
                } finally {
                    setSending(false);
                }
            };

            const handleAddAdmin = (e) => {
                e.preventDefault();
                if (!newAdminEmail.trim()) return;
                addAdmin(newAdminEmail);
                setMessage({ type: 'success', text: `${newAdminEmail} added as admin` });
                setNewAdminEmail('');
                forceUpdate(n => n + 1);
            };

            const handleRemoveAdmin = (email) => {
                if (email.toLowerCase() === currentUserEmail.toLowerCase()) {
                    setMessage({ type: 'error', text: "You cannot remove yourself as admin" });
                    return;
                }
                removeAdmin(email);
                setMessage({ type: 'success', text: `${email} removed from admins` });
                forceUpdate(n => n + 1);
            };

            const handleAddManager = (e) => {
                e.preventDefault();
                if (!newManagerEmail.trim()) return;
                addManager(newManagerEmail);
                setMessage({ type: 'success', text: `${newManagerEmail} added as manager` });
                setNewManagerEmail('');
                forceUpdate(n => n + 1);
            };

            const handleRemoveManager = (email) => {
                removeManager(email);
                setMessage({ type: 'success', text: `${email} removed from managers` });
                forceUpdate(n => n + 1);
            };

            const handleAddProfile = (e) => {
                e.preventDefault();
                if (!newProfile.email.trim() || !newProfile.name.trim()) return;
                addProfile(newProfile);
                setMessage({ type: 'success', text: `Profile created for ${newProfile.name}` });
                setNewProfile({ email: '', name: '', team: TEAMS[0], role: 'member' });
                forceUpdate(n => n + 1);
            };

            if (!isAdmin(currentUserEmail)) {
                return (
                    <div className="max-w-2xl mx-auto text-center py-12">
                        <div className="bg-red-50 border border-red-200 rounded-2xl p-8">
                            <i data-lucide="shield-x" className="w-16 h-16 text-red-400 mx-auto mb-4"></i>
                            <h2 className="text-2xl font-bold text-red-700 mb-2">Access Denied</h2>
                            <p className="text-red-600 mb-4">You don't have permission to access the admin console.</p>
                            <button
                                onClick={onBack}
                                className="px-6 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition"
                            >
                                Go Back
                            </button>
                        </div>
                    </div>
                );
            }

            const tabs = [
                { id: 'invites', label: 'Invitations', icon: 'mail-plus' },
                { id: 'admins', label: 'Admins', icon: 'shield' },
                { id: 'managers', label: 'Managers', icon: 'briefcase' },
                { id: 'profiles', label: 'User Profiles', icon: 'users' },
            ];

            return (
                <div className="max-w-5xl mx-auto">
                    <div className="bg-white rounded-2xl shadow-sm border border-ocean-100 overflow-hidden">
                        {/* Header */}
                        <div className="bg-gradient-to-r from-ocean-500 to-ocean-600 p-6 text-white">
                            <div className="flex items-center justify-between">
                                <div>
                                    <h1 className="text-2xl font-bold mb-1">Admin Console</h1>
                                    <p className="text-ocean-100 text-sm">Manage users, roles, and permissions</p>
                                </div>
                                <button
                                    onClick={onBack}
                                    className="px-4 py-2 bg-white/20 hover:bg-white/30 rounded-lg transition flex items-center gap-2"
                                >
                                    <i data-lucide="arrow-left" className="w-4 h-4"></i>
                                    Back
                                </button>
                            </div>
                        </div>

                        {/* Tabs */}
                        <div className="border-b border-graystone-200">
                            <div className="flex gap-1 p-2">
                                {tabs.map(tab => (
                                    <button
                                        key={tab.id}
                                        onClick={() => { setActiveTab(tab.id); setMessage({ type: '', text: '' }); }}
                                        className={cx(
                                            "flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-medium transition",
                                            activeTab === tab.id
                                                ? "bg-ocean-500 text-white"
                                                : "text-graystone-600 hover:bg-graystone-100"
                                        )}
                                    >
                                        <i data-lucide={tab.icon} className="w-4 h-4"></i>
                                        {tab.label}
                                    </button>
                                ))}
                            </div>
                        </div>

                        <div className="p-6">
                            {/* Message */}
                            {message.text && (
                                <div className={`mb-4 px-4 py-3 rounded-lg text-sm ${
                                    message.type === 'success'
                                        ? 'bg-green-50 border border-green-200 text-green-700'
                                        : 'bg-red-50 border border-red-200 text-red-700'
                                }`}>
                                    {message.text}
                                </div>
                            )}

                            {/* Invitations Tab */}
                            {activeTab === 'invites' && (
                                <div className="space-y-6">
                                    <div>
                                        <h2 className="text-lg font-bold text-ocean-900 mb-4">Send Invitation</h2>
                                        <form onSubmit={handleSendInvite} className="flex gap-3">
                                            <input
                                                type="email"
                                                value={inviteEmail}
                                                onChange={(e) => setInviteEmail(e.target.value)}
                                                placeholder="colleague@populationmatters.org"
                                                className="flex-1 px-4 py-3 border border-graystone-300 rounded-xl focus:ring-2 focus:ring-ocean-500 focus:border-ocean-500 outline-none transition"
                                                required
                                            />
                                            <button
                                                type="submit"
                                                disabled={sending || !inviteEmail.trim()}
                                                className="px-6 py-3 bg-ocean-500 text-white rounded-xl font-semibold hover:bg-ocean-600 disabled:opacity-50 disabled:cursor-not-allowed transition flex items-center gap-2"
                                            >
                                                <i data-lucide="send" className="w-4 h-4"></i>
                                                Send Invite
                                            </button>
                                        </form>
                                        <p className="text-xs text-graystone-500 mt-2">
                                            This will create a pre-seeded profile. Add the user in Clerk Dashboard to send the actual invitation email.
                                        </p>
                                    </div>

                                    <div>
                                        <h3 className="font-semibold text-ocean-900 mb-3">Recent Invitations</h3>
                                        {invites.length === 0 ? (
                                            <div className="text-center py-8 bg-graystone-50 rounded-xl border border-graystone-200">
                                                <p className="text-graystone-500 text-sm">No invitations sent yet</p>
                                            </div>
                                        ) : (
                                            <div className="space-y-2">
                                                {invites.map((invite, idx) => (
                                                    <div key={idx} className="flex items-center justify-between p-3 bg-graystone-50 rounded-lg border border-graystone-200">
                                                        <span className="text-sm">{invite.email}</span>
                                                        <span className="px-2 py-1 bg-amber-100 text-amber-700 rounded text-xs">{invite.status}</span>
                                                    </div>
                                                ))}
                                            </div>
                                        )}
                                    </div>

                                    <div className="bg-ocean-50 rounded-xl p-4 border border-ocean-100">
                                        <a
                                            href="https://dashboard.clerk.com"
                                            target="_blank"
                                            rel="noopener noreferrer"
                                            className="inline-flex items-center gap-2 text-sm font-medium text-ocean-600 hover:text-ocean-800"
                                        >
                                            <i data-lucide="external-link" className="w-4 h-4"></i>
                                            Open Clerk Dashboard for full user management
                                        </a>
                                    </div>
                                </div>
                            )}

                            {/* Admins Tab */}
                            {activeTab === 'admins' && (
                                <div className="space-y-6">
                                    <div>
                                        <h2 className="text-lg font-bold text-ocean-900 mb-2">Administrators</h2>
                                        <p className="text-sm text-graystone-600 mb-4">Admins have full access to the Admin Console and can manage all users.</p>

                                        <form onSubmit={handleAddAdmin} className="flex gap-3 mb-4">
                                            <input
                                                type="email"
                                                value={newAdminEmail}
                                                onChange={(e) => setNewAdminEmail(e.target.value)}
                                                placeholder="new-admin@populationmatters.org"
                                                className="flex-1 px-4 py-3 border border-graystone-300 rounded-xl focus:ring-2 focus:ring-ocean-500 focus:border-ocean-500 outline-none transition"
                                                required
                                            />
                                            <button
                                                type="submit"
                                                disabled={!newAdminEmail.trim()}
                                                className="px-6 py-3 bg-amber-500 text-white rounded-xl font-semibold hover:bg-amber-600 disabled:opacity-50 transition flex items-center gap-2"
                                            >
                                                <i data-lucide="user-plus" className="w-4 h-4"></i>
                                                Add Admin
                                            </button>
                                        </form>

                                        <div className="space-y-2">
                                            {USERS_CONFIG.admins.map((email, idx) => (
                                                <div key={idx} className="flex items-center justify-between p-4 bg-amber-50 rounded-xl border border-amber-200">
                                                    <div className="flex items-center gap-3">
                                                        <div className="w-10 h-10 rounded-full bg-amber-500 text-white flex items-center justify-center font-bold">
                                                            <i data-lucide="shield" className="w-5 h-5"></i>
                                                        </div>
                                                        <div>
                                                            <div className="font-medium text-ocean-900">{email}</div>
                                                            <div className="text-xs text-graystone-500">
                                                                {email.toLowerCase() === currentUserEmail.toLowerCase() ? '(You)' : 'Administrator'}
                                                            </div>
                                                        </div>
                                                    </div>
                                                    {email.toLowerCase() !== currentUserEmail.toLowerCase() && (
                                                        <button
                                                            onClick={() => handleRemoveAdmin(email)}
                                                            className="px-3 py-1 text-red-600 hover:bg-red-50 rounded-lg transition text-sm"
                                                        >
                                                            Remove
                                                        </button>
                                                    )}
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                </div>
                            )}

                            {/* Managers Tab */}
                            {activeTab === 'managers' && (
                                <div className="space-y-6">
                                    <div>
                                        <h2 className="text-lg font-bold text-ocean-900 mb-2">Manager Hub Access</h2>
                                        <p className="text-sm text-graystone-600 mb-4">Users with manager access can view the Manager Hub and see team workloads.</p>

                                        <form onSubmit={handleAddManager} className="flex gap-3 mb-4">
                                            <input
                                                type="email"
                                                value={newManagerEmail}
                                                onChange={(e) => setNewManagerEmail(e.target.value)}
                                                placeholder="manager@populationmatters.org"
                                                className="flex-1 px-4 py-3 border border-graystone-300 rounded-xl focus:ring-2 focus:ring-ocean-500 focus:border-ocean-500 outline-none transition"
                                                required
                                            />
                                            <button
                                                type="submit"
                                                disabled={!newManagerEmail.trim()}
                                                className="px-6 py-3 bg-ocean-500 text-white rounded-xl font-semibold hover:bg-ocean-600 disabled:opacity-50 transition flex items-center gap-2"
                                            >
                                                <i data-lucide="user-plus" className="w-4 h-4"></i>
                                                Add Manager
                                            </button>
                                        </form>

                                        <div className="space-y-2">
                                            {USERS_CONFIG.managers.map((email, idx) => (
                                                <div key={idx} className="flex items-center justify-between p-4 bg-ocean-50 rounded-xl border border-ocean-100">
                                                    <div className="flex items-center gap-3">
                                                        <div className="w-10 h-10 rounded-full bg-ocean-500 text-white flex items-center justify-center font-bold">
                                                            <i data-lucide="briefcase" className="w-5 h-5"></i>
                                                        </div>
                                                        <div>
                                                            <div className="font-medium text-ocean-900">{email}</div>
                                                            <div className="text-xs text-graystone-500">
                                                                {isAdmin(email) ? 'Admin + Manager' : 'Manager'}
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <button
                                                        onClick={() => handleRemoveManager(email)}
                                                        className="px-3 py-1 text-red-600 hover:bg-red-50 rounded-lg transition text-sm"
                                                    >
                                                        Remove
                                                    </button>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                </div>
                            )}

                            {/* Profiles Tab */}
                            {activeTab === 'profiles' && (
                                <div className="space-y-6">
                                    <div>
                                        <h2 className="text-lg font-bold text-ocean-900 mb-2">Pre-seeded User Profiles</h2>
                                        <p className="text-sm text-graystone-600 mb-4">
                                            When users sign up with these emails, they'll automatically be matched to these profiles.
                                        </p>

                                        <form onSubmit={handleAddProfile} className="bg-graystone-50 rounded-xl p-4 border border-graystone-200 mb-4">
                                            <div className="grid grid-cols-2 gap-4 mb-4">
                                                <div>
                                                    <label className="block text-sm font-medium text-graystone-700 mb-1">Email</label>
                                                    <input
                                                        type="email"
                                                        value={newProfile.email}
                                                        onChange={(e) => setNewProfile({ ...newProfile, email: e.target.value })}
                                                        placeholder="user@populationmatters.org"
                                                        className="w-full px-3 py-2 border border-graystone-300 rounded-lg focus:ring-2 focus:ring-ocean-500 focus:border-ocean-500 outline-none transition"
                                                        required
                                                    />
                                                </div>
                                                <div>
                                                    <label className="block text-sm font-medium text-graystone-700 mb-1">Display Name</label>
                                                    <input
                                                        type="text"
                                                        value={newProfile.name}
                                                        onChange={(e) => setNewProfile({ ...newProfile, name: e.target.value })}
                                                        placeholder="Jane Smith"
                                                        className="w-full px-3 py-2 border border-graystone-300 rounded-lg focus:ring-2 focus:ring-ocean-500 focus:border-ocean-500 outline-none transition"
                                                        required
                                                    />
                                                </div>
                                                <div>
                                                    <label className="block text-sm font-medium text-graystone-700 mb-1">Team</label>
                                                    <select
                                                        value={newProfile.team}
                                                        onChange={(e) => setNewProfile({ ...newProfile, team: e.target.value })}
                                                        className="w-full px-3 py-2 border border-graystone-300 rounded-lg focus:ring-2 focus:ring-ocean-500 focus:border-ocean-500 outline-none transition"
                                                    >
                                                        {TEAMS.map(t => <option key={t} value={t}>{t}</option>)}
                                                    </select>
                                                </div>
                                                <div>
                                                    <label className="block text-sm font-medium text-graystone-700 mb-1">Role</label>
                                                    <select
                                                        value={newProfile.role}
                                                        onChange={(e) => setNewProfile({ ...newProfile, role: e.target.value })}
                                                        className="w-full px-3 py-2 border border-graystone-300 rounded-lg focus:ring-2 focus:ring-ocean-500 focus:border-ocean-500 outline-none transition"
                                                    >
                                                        <option value="member">Member</option>
                                                        <option value="manager">Manager</option>
                                                        <option value="admin">Admin</option>
                                                    </select>
                                                </div>
                                            </div>
                                            <button
                                                type="submit"
                                                className="px-4 py-2 bg-ocean-500 text-white rounded-lg font-medium hover:bg-ocean-600 transition flex items-center gap-2"
                                            >
                                                <i data-lucide="user-plus" className="w-4 h-4"></i>
                                                Add Profile
                                            </button>
                                        </form>

                                        <div className="space-y-2">
                                            {USERS_CONFIG.profiles.map((profile, idx) => (
                                                <div key={idx} className="flex items-center justify-between p-4 bg-white rounded-xl border border-graystone-200">
                                                    <div className="flex items-center gap-3">
                                                        <div className="w-10 h-10 rounded-full bg-ocean-100 text-ocean-700 flex items-center justify-center font-bold text-sm">
                                                            {profile.name.split(' ').map(n => n[0]).join('')}
                                                        </div>
                                                        <div>
                                                            <div className="font-medium text-ocean-900">{profile.name}</div>
                                                            <div className="text-xs text-graystone-500">{profile.email}</div>
                                                        </div>
                                                    </div>
                                                    <div className="flex items-center gap-3">
                                                        <span className="px-2 py-1 bg-graystone-100 text-graystone-600 rounded text-xs">{profile.team}</span>
                                                        <span className={cx(
                                                            "px-2 py-1 rounded text-xs",
                                                            profile.role === 'admin' ? "bg-amber-100 text-amber-700" :
                                                            profile.role === 'manager' ? "bg-ocean-100 text-ocean-700" :
                                                            "bg-graystone-100 text-graystone-600"
                                                        )}>
                                                            {profile.role}
                                                        </span>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        }

        // Utility
        const cx = (...xs) => xs.filter(Boolean).join(" ");
        const uuid = () => Math.random().toString(36).slice(2) + Date.now().toString(36);

        // Constants
        const KANBAN_STATUSES = [
            "Idea",
            "Discovery",
            "Preparation",
            "In Delivery",
            "Delivered",
            "Impact Assessment",
            "Done",
        ];

        const TEAMS = ["Research", "Advocacy & Influence", "Fundraising"];
        const USERS = ["Dan Davis", "Jameen Kaur", "Emma Lewendon-Strutt", "Josh Hill", "Francesca Harrison", "Madeleine Hewitt", "Shweta Shirodkar"];
        const MANAGERS = [
            {
                name: "Jameen Kaur",
                email: "jameen.kaur@populationmatters.org",
                team: "Advocacy & Influence",
                reports: ["Dan Davis", "Francesca Harrison", "Madeleine Hewitt", "Shweta Shirodkar"]
            },
            {
                name: "Dan Davis",
                email: "daniel.davis@populationmatters.org",
                team: "Advocacy & Influence",
                reports: ["Francesca Harrison"]
            }
        ];
        const TIMELINE_TYPES = [
            { value: "date", label: "Specific Date" },
            { value: "month", label: "Month" },
            { value: "quarter", label: "Quarter" },
            { value: "year", label: "Year" },
        ];

        const selectBaseClasses =
            "dropdown-font rounded-full border border-black bg-white px-4 py-2 text-sm font-normal text-black shadow-[0_0_20px_rgba(15,157,222,0.2)] transition hover:bg-black hover:text-white focus:border-black focus:outline-none focus:ring-4 focus:ring-[#0F9DDE]/40 focus:ring-offset-2 focus:ring-offset-[#CFEBF8] disabled:cursor-not-allowed disabled:opacity-60";

        const inputBaseClasses =
            "w-full rounded-lg border border-graystone-300 bg-white px-3 py-2 text-sm shadow-sm focus:border-ocean-500 focus:outline-none focus:ring-2 focus:ring-aqua-200";

        function ManagerHub({ managers = [], teams = [], entries = [], currentUser, openStatsModal, onOpen, onUpdateStatus, openSubtaskModal }) {
            const normalizedTeams = teams.length ? teams : TEAMS;
            const [selectedManager, setSelectedManager] = useState(managers[0] || null);
            const [selectedReport, setSelectedReport] = useState("all");
            const [selectedMembers, setSelectedMembers] = useState(managers[0]?.reports || []);
            const [includeCollaborations, setIncludeCollaborations] = useState(false);
            const [managerViewMode, setManagerViewMode] = useState('kanban');

            // Timeline At-a-Glance state
            const [timelineFilter, setTimelineFilter] = useState('quarter');
            const [groupBy, setGroupBy] = useState('member');
            const [memberFilter, setMemberFilter] = useState('all');

            // Helper: Get current period value based on timeline type
            const getCurrentPeriod = (type) => {
                const now = new Date();
                const year = now.getFullYear();
                const month = now.getMonth();
                if (type === 'month') return `${year}-${String(month + 1).padStart(2, '0')}`;
                if (type === 'quarter') return `${year}-Q${Math.floor(month / 3) + 1}`;
                if (type === 'year') return String(year);
                return '';
            };

            const [timelineValue, setTimelineValue] = useState(() => getCurrentPeriod('quarter'));

            // Helper: Get options for timeline selector
            const getTimelineOptions = (type) => {
                const currentYear = new Date().getFullYear();
                if (type === 'month') {
                    const months = [];
                    for (let y = currentYear - 1; y <= currentYear + 1; y++) {
                        for (let m = 1; m <= 12; m++) {
                            const val = `${y}-${String(m).padStart(2, '0')}`;
                            const label = new Date(y, m - 1).toLocaleString('default', { month: 'short', year: 'numeric' });
                            months.push({ value: val, label });
                        }
                    }
                    return months;
                }
                if (type === 'quarter') {
                    const quarters = [];
                    for (let y = currentYear - 1; y <= currentYear + 1; y++) {
                        for (let q = 1; q <= 4; q++) {
                            quarters.push({ value: `${y}-Q${q}`, label: `Q${q} ${y}` });
                        }
                    }
                    return quarters;
                }
                if (type === 'year') {
                    return [currentYear - 1, currentYear, currentYear + 1, currentYear + 2].map(y => ({
                        value: String(y), label: String(y)
                    }));
                }
                return [];
            };

            // Helper: Filter entries by timeline
            const filterByTimeline = (items, type, value) => {
                if (!value) return items;
                return items.filter(entry => {
                    const tv = entry.timelineValue || '';
                    const d = entry.date || '';
                    if (type === 'year') {
                        return tv.startsWith(value) || d.startsWith(value);
                    }
                    if (type === 'quarter') {
                        // Match exact quarter OR infer from date
                        if (tv === value) return true;
                        if (d) {
                            const date = new Date(d);
                            const entryYear = date.getFullYear();
                            const entryQ = Math.floor(date.getMonth() / 3) + 1;
                            return value === `${entryYear}-Q${entryQ}`;
                        }
                        return false;
                    }
                    if (type === 'month') {
                        // Match exact month OR infer from date
                        if (tv === value) return true;
                        if (d) return d.startsWith(value);
                        return false;
                    }
                    return true;
                });
            };

            // Helper: Navigate timeline (prev/next)
            const navigateTimeline = (direction) => {
                const options = getTimelineOptions(timelineFilter);
                const currentIdx = options.findIndex(o => o.value === timelineValue);
                const newIdx = currentIdx + direction;
                if (newIdx >= 0 && newIdx < options.length) {
                    setTimelineValue(options[newIdx].value);
                }
            };

            const getTeamEntries = (mgr) => {
                if (!mgr) return [];
                const reports = Array.isArray(mgr.reports) ? mgr.reports : [];
                const reportSet = new Set(reports.length ? reports : []);
                return entries.filter((entry) => {
                    const ownerMatch = reportSet.has(entry.owner);
                    const collabMatch = Array.isArray(entry.collaborators) && entry.collaborators.some((c) => reportSet.has(c));
                    return ownerMatch || collabMatch;
                });
            };

            const computeBottleneck = (items) => {
                if (!items.length) return { status: "None", count: 0 };
                const counts = items.reduce((acc, item) => {
                    const key = item.workflowStatus || "Unknown";
                    acc[key] = (acc[key] || 0) + 1;
                    return acc;
                }, {});
                const sorted = Object.entries(counts)
                    .filter(([k]) => k.toLowerCase() !== "done")
                    .sort((a, b) => b[1] - a[1]);
                const top = sorted[0] || ["None", 0];
                return { status: top[0], count: top[1] };
            };

            const computeImminent = (items) => {
                const now = new Date();
                const horizon = new Date(now.getTime() + 14 * 24 * 60 * 60 * 1000);
                const withDates = items
                    .map((item) => {
                        const rawDate = item.date || item.timelineValue;
                        const parsed = rawDate ? new Date(rawDate) : null;
                        return { item, parsed };
                    })
                    .filter(({ parsed }) => parsed && !isNaN(parsed))
                    .filter(({ parsed }) => parsed >= now && parsed <= horizon)
                    .sort((a, b) => a.parsed - b.parsed);
                return withDates.slice(0, 5).map(({ item }) => item);
            };

            const computeOverdue = (items) => {
                const now = new Date();
                return items
                    .map((item) => {
                        const rawDate = item.date || item.timelineValue;
                        const parsed = rawDate ? new Date(rawDate) : null;
                        return { item, parsed };
                    })
                    .filter(({ parsed }) => parsed && !isNaN(parsed) && parsed < now)
                    .sort((a, b) => a.parsed - b.parsed)
                    .slice(0, 5)
                    .map(({ item }) => item);
            };

            const myManager = managers.find((mgr) => mgr.name === currentUser);
            const parseDate = (value) => {
                if (!value) return null;
                const d = new Date(value);
                return isNaN(d) ? null : d;
            };
            const now = new Date();
            const horizon = new Date(now.getTime() + 14 * 24 * 60 * 60 * 1000);

            const handleManagerChange = (email) => {
                const next = managers.find((m) => m.email === email) || managers[0] || null;
                setSelectedManager(next);
                setSelectedMembers(next?.reports || []);
            };

            const toggleMemberSelection = (member) => {
                setSelectedMembers((prev) =>
                    prev.includes(member) ? prev.filter((m) => m !== member) : [...prev, member]
                );
            };

            useEffect(() => {
                if (managers && managers.length) {
                    const next = managers[0];
                    setSelectedManager(next);
                    setSelectedMembers(next?.reports || []);
                } else {
                    setSelectedManager(null);
                    setSelectedMembers([]);
                }
            }, [managers]);

            const collectMemberItems = (memberName) => {
                const ownedProjects = entries.filter((e) => e.owner === memberName);
                const memberSubtasks = entries.flatMap((entry) =>
                    Array.isArray(entry.subtasks)
                        ? entry.subtasks
                              .filter((st) => st.assignedTo === memberName)
                              .map((st) => ({
                                  ...st,
                                  id: `${entry.id}-sub-${st.id}`,
                                  title: st.title,
                                  workflowStatus: st.completed ? "Done" : "Subtask",
                                  date: st.deadline,
                                  parentId: entry.id,
                                  parentTitle: entry.title || "Untitled",
                                  kind: "subtask",
                              }))
                        : []
                );
                const allItems = [...ownedProjects, ...memberSubtasks];

                const inProgress = allItems.filter(
                    (item) =>
                        (item.kind === "subtask" && !item.completed) ||
                        ((item.workflowStatus || "").toLowerCase() !== "done")
                );
                const dueSoon = allItems.filter((item) => {
                    const d = parseDate(item.date || item.timelineValue || item.deadline);
                    return d && d >= now && d <= horizon;
                });
                const overdue = allItems.filter((item) => {
                    const d = parseDate(item.date || item.timelineValue || item.deadline);
                    return d && d < now;
                });

                return { ownedProjects, memberSubtasks, allItems, inProgress, dueSoon, overdue };
            };

            const filteredTeamEntries = entries.filter((entry) => {
                const membersToMatch = selectedMembers.length ? selectedMembers : selectedManager?.reports || [];
                const ownerMatch = membersToMatch.includes(entry.owner);
                const collabMatch =
                    includeCollaborations &&
                    Array.isArray(entry.collaborators) &&
                    entry.collaborators.some((c) => membersToMatch.includes(c));
                return ownerMatch || collabMatch;
            });
            const managerName = (selectedManager && selectedManager.name) || currentUser;
            return (
                <div className="animate-in fade-in slide-in-from-bottom-4 duration-500 space-y-6" id="manager-hub-export-content">
                    <div className="bg-gradient-to-r from-ocean-500 to-ocean-600 rounded-2xl p-6 text-white shadow-xl">
                        <div className="flex items-center justify-between">
                            <div>
                                <h2 className="text-2xl font-bold heading-font">{managerName}'s Manager Hub</h2>
                                <p className="text-ocean-100 text-sm">See team workloads, bottlenecks, and near-term risk.</p>
                            </div>
                            <div className="flex items-center gap-4">
                                <div className="text-right">
                                    <div className="text-xs uppercase tracking-wide text-ocean-100">Team</div>
                                    <div className="text-lg font-semibold">{selectedManager?.team || teams[0] || "Team"}</div>
                                </div>
                                <button
                                    onClick={() => exportToPDF('manager-hub-export-content', `${managerName.replace(/\s+/g, '_')}_Team_Workstreams`, `${managerName}'s Team Workstreams`)}
                                    className="flex items-center gap-2 px-4 py-2 bg-white/20 hover:bg-white/30 text-white rounded-lg transition text-sm font-medium border border-white/20"
                                >
                                    <i data-lucide="download" className="w-4 h-4"></i>
                                    Export PDF
                                </button>
                            </div>
                        </div>
                    </div>
                    {managers.length > 1 && (
                        <div className="flex justify-end">
                            <select
                                value={selectedManager?.email || managers[0]?.email || ""}
                                onChange={(e) => handleManagerChange(e.target.value)}
                                className={cx(selectBaseClasses, "w-full max-w-xs")}
                            >
                                {managers.map((mgr) => (
                                    <option key={mgr.email} value={mgr.email}>{mgr.name} — {mgr.team}</option>
                                ))}
                            </select>
                        </div>
                    )}

                    {selectedManager && (() => {
                        const items = getTeamEntries(selectedManager);
                        const bottleneck = computeBottleneck(items);
                        const imminent = computeImminent(items);
                                const overdue = computeOverdue(items);
                                const inProgress = items.filter((i) => (i.workflowStatus || "").toLowerCase() !== "done");
                                const bottleneckItems = items.filter((i) => (i.workflowStatus || "Unknown") === bottleneck.status);

                                const openModal = (title, data) => {
                                    if (openStatsModal) openStatsModal(title, data);
                                };

                                return (
                                    <div className="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-5 gap-4">
                                <button
                                    type="button"
                                    onClick={() => openModal(`Items: ${selectedManager.name}`, items)}
                                    className="bg-white rounded-xl border border-ocean-100 shadow-sm p-5 text-left transition hover:shadow-md hover:-translate-y-0.5 group"
                                >
                                    <div className="text-xs font-semibold text-graystone-600 uppercase mb-1">Team items</div>
                                    <div className="relative inline-flex items-center justify-center">
                                        <div
                                            className="absolute rounded-full transition-all duration-300 scale-0 opacity-0 group-hover:scale-100 group-hover:opacity-100"
                                            style={{ backgroundColor: '#0CFFFF', width: '43px', height: '43px' }}
                                        ></div>
                                        <div className="text-3xl font-bold text-ocean-900 relative z-10">{items.length}</div>
                                    </div>
                                </button>
                                <button
                                    type="button"
                                    onClick={() => openModal("In progress", inProgress)}
                                    className="bg-white rounded-xl border border-ocean-100 shadow-sm p-5 text-left transition hover:shadow-md hover:-translate-y-0.5 group"
                                >
                                    <div className="text-xs font-semibold text-graystone-600 uppercase mb-1">In progress</div>
                                    <div className="relative inline-flex items-center justify-center">
                                    <div
                                        className="absolute rounded-full transition-all duration-300 scale-0 opacity-0 group-hover:scale-100 group-hover:opacity-100"
                                        style={{ backgroundColor: '#0CFFFF', width: '43px', height: '43px' }}
                                    ></div>
                                        <div className="text-3xl font-bold text-ocean-900 relative z-10">{inProgress.length}</div>
                                    </div>
                                </button>
                                <button
                                    type="button"
                                    onClick={() => openModal(`Bottleneck: ${bottleneck.status}`, bottleneckItems)}
                                    className="bg-white rounded-xl border border-ocean-100 shadow-sm p-5 text-left transition hover:shadow-md hover:-translate-y-0.5 group"
                                >
                                    <div className="text-xs font-semibold text-graystone-600 uppercase mb-1">Top bottleneck</div>
                                    <div className="relative inline-flex items-center justify-center">
                                        <div
                                            className="absolute rounded-full transition-all duration-300 scale-0 opacity-0 group-hover:scale-100 group-hover:opacity-100"
                                            style={{ backgroundColor: '#0CFFFF', width: '43px', height: '43px' }}
                                        ></div>
                                        <div className="text-3xl font-bold text-ocean-900 relative z-10">{bottleneck.count}</div>
                                    </div>
                                </button>
                                <button
                                    type="button"
                                    onClick={() => openModal("Imminent (14 days)", imminent)}
                                    className="bg-white rounded-xl border border-ocean-100 shadow-sm p-5 text-left transition hover:shadow-md hover:-translate-y-0.5 group"
                                >
                                    <div className="text-xs font-semibold text-graystone-600 uppercase mb-1">Imminent</div>
                                    <div className="relative inline-flex items-center justify-center">
                                        <div
                                            className="absolute rounded-full transition-all duration-300 scale-0 opacity-0 group-hover:scale-100 group-hover:opacity-100"
                                            style={{ backgroundColor: '#0CFFFF', width: '43px', height: '43px' }}
                                        ></div>
                                        <div className="text-3xl font-bold text-ocean-900 relative z-10">{imminent.length}</div>
                                    </div>
                                </button>
                                <button
                                    type="button"
                                    onClick={() => openModal("Overdue", overdue)}
                                    className="bg-white rounded-xl border border-ocean-100 shadow-sm p-5 text-left transition hover:shadow-md hover:-translate-y-0.5 group"
                                >
                                    <div className="text-xs font-semibold text-graystone-600 uppercase mb-1">Overdue</div>
                                    <div className="relative inline-flex items-center justify-center">
                                        <div
                                            className="absolute rounded-full transition-all duration-300 scale-0 opacity-0 group-hover:scale-100 group-hover:opacity-100"
                                            style={{ backgroundColor: '#0CFFFF', width: '43px', height: '43px' }}
                                        ></div>
                                        <div className="text-3xl font-bold text-ocean-900 relative z-10">{overdue.length}</div>
                                    </div>
                                </button>
                            </div>
                        );
                    })()}

                    <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                        {selectedManager?.reports && selectedManager.reports.length ? (
                            selectedManager.reports.map((rep) => {
                                const { allItems, inProgress, dueSoon, overdue: memberOverdue } = collectMemberItems(rep);

                                return (
                                    <div key={rep} className="bg-white rounded-2xl border border-ocean-100 shadow-sm p-5 space-y-4">
                                        <div className="flex items-start justify-between">
                                            <div className="flex items-center gap-3">
                                                <div className="w-10 h-10 rounded-full bg-ocean-500 text-white flex items-center justify-center font-bold">
                                                    {rep.split(" ").map((n) => n[0]).join("")}
                                                </div>
                                                <div>
                                                    <div className="text-lg font-bold text-ocean-900 heading-font">{rep}</div>
                                                    <div className="text-xs text-graystone-600">{selectedManager.team}</div>
                                                </div>
                                            </div>
                                            <button
                                                onClick={() => openModal(`${rep}: all work`, allItems)}
                                                className="relative inline-flex items-center justify-center group"
                                            >
                                                <div
                                                    className="absolute rounded-full transition-all duration-300 scale-0 opacity-0 group-hover:scale-100 group-hover:opacity-100"
                                                    style={{ backgroundColor: '#0CFFFF', width: '36px', height: '36px' }}
                                                ></div>
                                                <span className="text-2xl font-bold text-ocean-900 relative z-10">{allItems.length}</span>
                                            </button>
                                        </div>

                                        <div className="grid grid-cols-2 gap-2 text-xs">
                                            <button
                                                onClick={() => openModal(`${rep}: in progress`, inProgress)}
                                                className="p-3 rounded-xl border border-ocean-100 bg-ocean-50 hover:border-ocean-300 hover:bg-ocean-100 transition flex items-center justify-between"
                                            >
                                                <span className="text-ocean-900 font-semibold">In progress</span>
                                                <span className="font-bold text-ocean-900">{inProgress.length}</span>
                                            </button>
                                            <button
                                                onClick={() => openModal(`${rep}: upcoming`, dueSoon)}
                                                className="p-3 rounded-xl border border-ocean-100 bg-ocean-50 hover:border-ocean-300 hover:bg-ocean-100 transition flex items-center justify-between"
                                            >
                                                <span className="text-ocean-900 font-semibold">Due soon</span>
                                                <span className="font-bold text-ocean-900">{dueSoon.length}</span>
                                            </button>
                                            <button
                                                onClick={() => openModal(`${rep}: overdue`, memberOverdue)}
                                                className="p-3 rounded-xl border border-ocean-100 bg-ocean-50 hover:border-ocean-300 hover:bg-ocean-100 transition flex items-center justify-between col-span-2"
                                            >
                                                <span className="text-ocean-900 font-semibold">Overdue</span>
                                                <span className="font-bold text-ocean-900">{memberOverdue.length}</span>
                                            </button>
                                        </div>
                                    </div>
                                );
                            })
                        ) : (
                            <div className="bg-white rounded-2xl border border-ocean-100 shadow-sm p-6 text-center text-sm text-graystone-500">
                                No team members listed for this manager.
                            </div>
                        )}
                    </div>

                    {/* At-a-Glance Workstreams */}
                    <div className="bg-white rounded-xl border border-ocean-100 shadow-sm p-6 space-y-4">
                        {/* Header with Timeline Controls */}
                        <div className="flex flex-col gap-4 md:flex-row md:items-center md:justify-between">
                            <div>
                                <h3 className="font-heading text-lg text-ocean-900 tracking-wide">At-a-Glance Workstreams</h3>
                                <p className="text-xs text-graystone-600">View team workstreams by time period</p>
                            </div>
                            <div className="flex items-center gap-3">
                                {/* Timeline Type Toggle */}
                                <div className="flex bg-graystone-100 p-1 rounded-lg">
                                    {['month', 'quarter', 'year'].map((type) => (
                                        <button
                                            key={type}
                                            onClick={() => {
                                                setTimelineFilter(type);
                                                setTimelineValue(getCurrentPeriod(type));
                                            }}
                                            className={cx(
                                                "px-3 py-1.5 rounded-md text-xs font-medium transition-all capitalize",
                                                timelineFilter === type
                                                    ? "bg-white text-ocean-700 shadow-sm"
                                                    : "text-graystone-600 hover:text-ocean-700"
                                            )}
                                        >
                                            {type}
                                        </button>
                                    ))}
                                </div>
                                {/* Period Navigation */}
                                <div className="flex items-center gap-2">
                                    <button
                                        onClick={() => navigateTimeline(-1)}
                                        className="w-8 h-8 rounded-full bg-ocean-50 text-ocean-700 border border-ocean-100 hover:bg-ocean-100 flex items-center justify-center"
                                    >
                                        <i data-lucide="chevron-left" className="w-4 h-4"></i>
                                    </button>
                                    <select
                                        value={timelineValue}
                                        onChange={(e) => setTimelineValue(e.target.value)}
                                        className={cx(selectBaseClasses, "min-w-[140px] text-center")}
                                    >
                                        {getTimelineOptions(timelineFilter).map((opt) => (
                                            <option key={opt.value} value={opt.value}>{opt.label}</option>
                                        ))}
                                    </select>
                                    <button
                                        onClick={() => navigateTimeline(1)}
                                        className="w-8 h-8 rounded-full bg-ocean-50 text-ocean-700 border border-ocean-100 hover:bg-ocean-100 flex items-center justify-center"
                                    >
                                        <i data-lucide="chevron-right" className="w-4 h-4"></i>
                                    </button>
                                </div>
                            </div>
                        </div>

                        {/* Summary Stats for Period */}
                        {(() => {
                            const periodEntries = filterByTimeline(filteredTeamEntries, timelineFilter, timelineValue);
                            const inMotion = periodEntries.filter(e => (e.workflowStatus || '').toLowerCase() !== 'done');
                            const done = periodEntries.filter(e => (e.workflowStatus || '').toLowerCase() === 'done');
                            const bottleneck = computeBottleneck(periodEntries);

                            return (
                                <div className="grid grid-cols-2 sm:grid-cols-4 gap-3">
                                    <button
                                        type="button"
                                        onClick={() => openStatsModal(`${timelineValue} - All Items`, periodEntries)}
                                        className="bg-ocean-50 rounded-xl border border-ocean-100 p-4 text-left transition hover:shadow-md hover:-translate-y-0.5 group"
                                    >
                                        <div className="text-xs font-semibold text-graystone-600 uppercase mb-1">Total</div>
                                        <div className="relative inline-flex items-center justify-center">
                                            <div
                                                className="absolute rounded-full transition-all duration-300 scale-0 opacity-0 group-hover:scale-100 group-hover:opacity-100"
                                                style={{ backgroundColor: '#0CFFFF', width: '36px', height: '36px' }}
                                            ></div>
                                            <div className="text-2xl font-bold text-ocean-900 relative z-10">{periodEntries.length}</div>
                                        </div>
                                    </button>
                                    <button
                                        type="button"
                                        onClick={() => openStatsModal(`${timelineValue} - In Motion`, inMotion)}
                                        className="bg-ocean-50 rounded-xl border border-ocean-100 p-4 text-left transition hover:shadow-md hover:-translate-y-0.5 group"
                                    >
                                        <div className="text-xs font-semibold text-graystone-600 uppercase mb-1">In Motion</div>
                                        <div className="relative inline-flex items-center justify-center">
                                            <div
                                                className="absolute rounded-full transition-all duration-300 scale-0 opacity-0 group-hover:scale-100 group-hover:opacity-100"
                                                style={{ backgroundColor: '#0CFFFF', width: '36px', height: '36px' }}
                                            ></div>
                                            <div className="text-2xl font-bold text-ocean-900 relative z-10">{inMotion.length}</div>
                                        </div>
                                    </button>
                                    <button
                                        type="button"
                                        onClick={() => openStatsModal(`${timelineValue} - Done`, done)}
                                        className="bg-green-50 rounded-xl border border-green-100 p-4 text-left transition hover:shadow-md hover:-translate-y-0.5 group"
                                    >
                                        <div className="text-xs font-semibold text-graystone-600 uppercase mb-1">Done</div>
                                        <div className="relative inline-flex items-center justify-center">
                                            <div
                                                className="absolute rounded-full transition-all duration-300 scale-0 opacity-0 group-hover:scale-100 group-hover:opacity-100"
                                                style={{ backgroundColor: '#86efac', width: '36px', height: '36px' }}
                                            ></div>
                                            <div className="text-2xl font-bold text-green-700 relative z-10">{done.length}</div>
                                        </div>
                                    </button>
                                    <button
                                        type="button"
                                        onClick={() => openStatsModal(`${timelineValue} - ${bottleneck.status}`, periodEntries.filter(e => e.workflowStatus === bottleneck.status))}
                                        className="bg-amber-50 rounded-xl border border-amber-100 p-4 text-left transition hover:shadow-md hover:-translate-y-0.5 group"
                                    >
                                        <div className="text-xs font-semibold text-graystone-600 uppercase mb-1">Bottleneck</div>
                                        <div className="flex items-center gap-2">
                                            <div className="relative inline-flex items-center justify-center">
                                                <div
                                                    className="absolute rounded-full transition-all duration-300 scale-0 opacity-0 group-hover:scale-100 group-hover:opacity-100"
                                                    style={{ backgroundColor: '#fcd34d', width: '36px', height: '36px' }}
                                                ></div>
                                                <div className="text-2xl font-bold text-amber-700 relative z-10">{bottleneck.count}</div>
                                            </div>
                                            <span className="text-xs text-amber-600 truncate">{bottleneck.status}</span>
                                        </div>
                                    </button>
                                </div>
                            );
                        })()}

                        {/* Grouping Controls */}
                        <div className="flex flex-wrap items-center gap-3 pt-2 border-t border-graystone-100">
                            <div className="flex items-center gap-2">
                                <span className="text-xs font-medium text-graystone-600">Group by:</span>
                                <div className="flex bg-graystone-100 p-1 rounded-lg">
                                    {[
                                        { id: 'member', label: 'Member' },
                                        { id: 'status', label: 'Status' },
                                        { id: 'flat', label: 'Flat' }
                                    ].map((opt) => (
                                        <button
                                            key={opt.id}
                                            onClick={() => setGroupBy(opt.id)}
                                            className={cx(
                                                "px-3 py-1 rounded-md text-xs font-medium transition-all",
                                                groupBy === opt.id
                                                    ? "bg-white text-ocean-700 shadow-sm"
                                                    : "text-graystone-600 hover:text-ocean-700"
                                            )}
                                        >
                                            {opt.label}
                                        </button>
                                    ))}
                                </div>
                            </div>
                            <div className="flex items-center gap-2">
                                <span className="text-xs font-medium text-graystone-600">Filter:</span>
                                <select
                                    value={memberFilter}
                                    onChange={(e) => setMemberFilter(e.target.value)}
                                    className={cx(selectBaseClasses, "text-xs py-1.5")}
                                >
                                    <option value="all">All Members</option>
                                    {(selectedManager?.reports || []).map((rep) => (
                                        <option key={rep} value={rep}>{rep}</option>
                                    ))}
                                </select>
                            </div>
                            <label className="flex items-center gap-2 text-xs text-graystone-700 ml-auto">
                                <input
                                    type="checkbox"
                                    checked={includeCollaborations}
                                    onChange={(e) => setIncludeCollaborations(e.target.checked)}
                                    className="rounded border-graystone-300 text-ocean-600 focus:ring-ocean-500"
                                />
                                Include collaborations
                            </label>
                        </div>

                        {/* Workstream Display */}
                        <div className="bg-graystone-50 rounded-xl border border-graystone-200 p-4 min-h-[200px]">
                            {(() => {
                                let periodEntries = filterByTimeline(filteredTeamEntries, timelineFilter, timelineValue);
                                if (memberFilter !== 'all') {
                                    periodEntries = periodEntries.filter(e =>
                                        e.owner === memberFilter ||
                                        (includeCollaborations && e.collaborators?.includes(memberFilter))
                                    );
                                }

                                if (periodEntries.length === 0) {
                                    return (
                                        <div className="text-sm text-graystone-500 text-center py-10">
                                            No items for {getTimelineOptions(timelineFilter).find(o => o.value === timelineValue)?.label || timelineValue}
                                        </div>
                                    );
                                }

                                // Group by member
                                if (groupBy === 'member') {
                                    const byMember = {};
                                    periodEntries.forEach(entry => {
                                        const key = entry.owner || 'Unassigned';
                                        if (!byMember[key]) byMember[key] = [];
                                        byMember[key].push(entry);
                                    });

                                    return (
                                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                            {Object.entries(byMember).map(([member, items]) => (
                                                <div key={member} className="bg-white rounded-xl border border-ocean-100 p-4">
                                                    <div className="flex items-center gap-2 mb-3 pb-2 border-b border-graystone-100">
                                                        <div className="w-8 h-8 rounded-full bg-ocean-500 text-white flex items-center justify-center font-bold text-sm">
                                                            {member.split(' ').map(n => n[0]).join('')}
                                                        </div>
                                                        <div className="flex-1 min-w-0">
                                                            <div className="font-medium text-sm text-ocean-900 truncate">{member}</div>
                                                            <div className="text-xs text-graystone-500">{items.length} item{items.length !== 1 ? 's' : ''}</div>
                                                        </div>
                                                    </div>
                                                    <div className="space-y-2 max-h-[200px] overflow-y-auto">
                                                        {items.map(entry => (
                                                            <button
                                                                key={entry.id}
                                                                onClick={() => onOpen(entry.id)}
                                                                className="w-full text-left p-2 rounded-lg border border-graystone-100 hover:border-ocean-300 hover:bg-ocean-50 transition-all group"
                                                            >
                                                                <div className="flex items-center justify-between">
                                                                    <span className="text-sm font-medium text-ocean-900 truncate flex-1">{entry.title}</span>
                                                                    <i data-lucide="external-link" className="w-3 h-3 text-graystone-300 group-hover:text-ocean-500 ml-2"></i>
                                                                </div>
                                                                <div className="flex items-center gap-2 mt-1">
                                                                    <Badge variant={entry.workflowStatus === 'Done' ? 'success' : 'secondary'} className="text-[10px] py-0">
                                                                        {entry.workflowStatus}
                                                                    </Badge>
                                                                </div>
                                                            </button>
                                                        ))}
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    );
                                }

                                // Group by status
                                if (groupBy === 'status') {
                                    const byStatus = {};
                                    KANBAN_STATUSES.forEach(status => { byStatus[status] = []; });
                                    periodEntries.forEach(entry => {
                                        const key = entry.workflowStatus || 'Idea';
                                        if (!byStatus[key]) byStatus[key] = [];
                                        byStatus[key].push(entry);
                                    });

                                    return (
                                        <div className="flex gap-4 overflow-x-auto pb-2">
                                            {KANBAN_STATUSES.map(status => {
                                                const items = byStatus[status] || [];
                                                return (
                                                    <div key={status} className="w-64 shrink-0 bg-white rounded-xl border border-ocean-100 p-4">
                                                        <div className="flex items-center justify-between mb-3 pb-2 border-b border-graystone-100">
                                                            <span className="font-medium text-sm text-ocean-900">{status}</span>
                                                            <Badge variant="secondary" className="text-[10px]">{items.length}</Badge>
                                                        </div>
                                                        <div className="space-y-2 max-h-[250px] overflow-y-auto">
                                                            {items.length === 0 ? (
                                                                <div className="text-xs text-graystone-400 text-center py-4">No items</div>
                                                            ) : items.map(entry => (
                                                                <button
                                                                    key={entry.id}
                                                                    onClick={() => onOpen(entry.id)}
                                                                    className="w-full text-left p-2 rounded-lg border border-graystone-100 hover:border-ocean-300 hover:bg-ocean-50 transition-all group"
                                                                >
                                                                    <div className="text-sm font-medium text-ocean-900 truncate">{entry.title}</div>
                                                                    <div className="text-xs text-graystone-500 mt-1">{entry.owner}</div>
                                                                </button>
                                                            ))}
                                                        </div>
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    );
                                }

                                // Flat list
                                return (
                                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                                        {periodEntries.map(entry => (
                                            <button
                                                key={entry.id}
                                                onClick={() => onOpen(entry.id)}
                                                className="bg-white text-left p-4 rounded-xl border border-ocean-100 hover:border-ocean-300 hover:shadow-md transition-all group"
                                            >
                                                <div className="flex items-start justify-between gap-2">
                                                    <div className="flex-1 min-w-0">
                                                        <div className="font-medium text-sm text-ocean-900 truncate">{entry.title}</div>
                                                        <div className="flex items-center gap-2 mt-1 text-xs text-graystone-500">
                                                            <span>{entry.owner}</span>
                                                            <span>·</span>
                                                            <Badge variant={entry.workflowStatus === 'Done' ? 'success' : 'secondary'} className="text-[10px] py-0">
                                                                {entry.workflowStatus}
                                                            </Badge>
                                                        </div>
                                                    </div>
                                                    <i data-lucide="external-link" className="w-4 h-4 text-graystone-300 group-hover:text-ocean-500"></i>
                                                </div>
                                            </button>
                                        ))}
                                    </div>
                                );
                            })()}
                        </div>
                    </div>

                </div>
            );
        }

        // Components
        const Badge = ({ variant = 'default', className = '', children }) => {
            const styles = {
                default: 'bg-aqua-100 text-ocean-700',
                secondary: 'bg-graystone-100 text-graystone-700',
                outline: 'border border-aqua-200 text-ocean-700 bg-aqua-50',
                success: 'bg-green-100 text-green-700',
                neutral: 'bg-graystone-100 text-graystone-600',
            };
            return (
                <span className={cx('inline-flex items-center rounded-full px-2.5 py-1 text-xs font-medium', styles[variant], className)}>
                    {children}
                </span>
            );
        };

        const Button = ({
            type = "button",
            variant = "solid",
            size = "md",
            disabled = false,
            className = "",
            onClick,
            children,
        }) => {
            const base =
                "heading-font inline-flex items-center justify-center gap-2 rounded-full font-semibold transition-all focus:outline-none focus-visible:ring-4 focus-visible:ring-[#0F9DDE]/40 focus-visible:ring-offset-2 focus-visible:ring-offset-[#CFEBF8] disabled:cursor-not-allowed disabled:opacity-60";
            const variants = {
                solid:
                    "border border-black bg-black text-white shadow-[0_0_30px_rgba(15,157,222,0.35)] hover:-translate-y-0.5 hover:bg-white hover:text-black",
                outline:
                    "border border-black bg-white text-black hover:-translate-y-0.5 hover:bg-black hover:text-white",
                ghost: "text-black hover:bg-black/10",
                destructive:
                    "border border-rose-500 bg-rose-600 text-white shadow-[0_0_25px_rgba(244,63,94,0.35)] hover:-translate-y-0.5 hover:bg-rose-700",
                cta:
                    "border border-[#0F9DDE]/40 bg-white text-black shadow-[0_0_35px_rgba(15,157,222,0.3)] hover:-translate-y-0.5 hover:shadow-[0_0_45px_rgba(15,157,222,0.45)]",
            };
            const sizes = {
                sm: "px-4 py-1.5 text-xs",
                md: "px-6 py-2 text-sm",
                lg: "px-7 py-3 text-base",
                icon: "h-10 w-10",
            };
            return (
                <button
                    type={type}
                    onClick={onClick}
                    disabled={disabled}
                    className={cx(base, variants[variant] || variants.solid, sizes[size], className)}
                >
                    {children}
                </button>
            );
        };

        function KanbanBoard({ statuses, entries, onOpen, onUpdateStatus, openSubtaskModal, currentUser }) {
            const [draggedItem, setDraggedItem] = useState(null);
            const [dragOverColumn, setDragOverColumn] = useState(null);
            const scrollContainerRef = React.useRef(null);
            const scrollIntervalRef = React.useRef(null);

            const handleDragStart = (e, entry) => {
                setDraggedItem(entry);
                e.dataTransfer.effectAllowed = 'move';
                e.dataTransfer.setData('text/html', e.target);
            };

            const handleDragEnd = () => {
                setDraggedItem(null);
                setDragOverColumn(null);
                // Clear auto-scroll
                if (scrollIntervalRef.current) {
                    clearInterval(scrollIntervalRef.current);
                    scrollIntervalRef.current = null;
                }
            };

            const handleDrag = (e) => {
                if (!scrollContainerRef.current) return;

                const container = scrollContainerRef.current;
                const rect = container.getBoundingClientRect();
                const scrollThreshold = 100; // pixels from edge to trigger scroll
                const scrollSpeed = 10; // pixels per interval

                // Clear existing interval
                if (scrollIntervalRef.current) {
                    clearInterval(scrollIntervalRef.current);
                    scrollIntervalRef.current = null;
                }

                // Only process if cursor is within reasonable bounds
                if (e.clientX === 0 && e.clientY === 0) return; // Ignore invalid coordinates

                // Check if near right edge
                if (e.clientX > rect.right - scrollThreshold && e.clientX < window.innerWidth) {
                    scrollIntervalRef.current = setInterval(() => {
                        container.scrollLeft += scrollSpeed;
                    }, 16);
                }
                // Check if near left edge (removed the e.clientX > 0 check that was causing issues)
                else if (e.clientX < rect.left + scrollThreshold && container.scrollLeft > 0) {
                    scrollIntervalRef.current = setInterval(() => {
                        container.scrollLeft -= scrollSpeed;
                    }, 16);
                }
            };

            const handleDragOver = (e, status) => {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
                setDragOverColumn(status);
            };

            const handleDragLeave = () => {
                setDragOverColumn(null);
            };

            const handleDrop = (e, newStatus) => {
                e.preventDefault();
                if (draggedItem && draggedItem.workflowStatus !== newStatus) {
                    onUpdateStatus(draggedItem.id, newStatus);
                }
                setDraggedItem(null);
                setDragOverColumn(null);
            };

            return (
                <div ref={scrollContainerRef} className="flex gap-6 overflow-x-auto pb-6 max-w-full">
                    {statuses.map((status) => {
                        const cards = entries.filter(
                            (entry) => (entry.workflowStatus || statuses[0]) === status
                        );
                        const isDropZone = dragOverColumn === status;

                        return (
                            <div
                                key={status}
                                className="w-72 shrink-0"
                                onDragOver={(e) => handleDragOver(e, status)}
                                onDragLeave={handleDragLeave}
                                onDrop={(e) => handleDrop(e, status)}
                            >
                                <div className="mb-3 flex items-center justify-between">
                                    <div className="text-sm font-semibold text-ocean-700">{status}</div>
                                    <Badge variant="secondary">{cards.length}</Badge>
                                </div>
                                <div className={cx(
                                    "space-y-3 min-h-[200px] rounded-xl p-2 transition-all",
                                    isDropZone && draggedItem ? "bg-ocean-50 border-2 border-dashed border-ocean-400" : "border-2 border-transparent"
                                )}>
                                    {cards.length === 0 ? (
                                        <div className="rounded-xl border border-aqua-200 bg-aqua-50 px-3 py-4 text-xs text-graystone-500">
                                            Nothing here yet.
                                        </div>
                                    ) : (
                                        cards.map((entry) => {
                                            const isBeingDragged = draggedItem?.id === entry.id;

                                            return (
                                                <div
                                                    key={entry.id}
                                                    draggable={true}
                                                    onDragStart={(e) => handleDragStart(e, entry)}
                                                    onDrag={handleDrag}
                                                    onDragEnd={handleDragEnd}
                                                    className={cx(
                                                        "rounded-2xl border border-graystone-200 bg-white p-4 shadow-sm transition-all cursor-move hover:shadow-md hover:border-ocean-300",
                                                        isBeingDragged ? "opacity-50 scale-95" : "opacity-100"
                                                    )}
                                                >
                                                    <div className="flex items-start justify-between gap-3 mb-3">
                                                        <div className="text-sm font-semibold text-graystone-800 line-clamp-2 heading-font">
                                                            {entry.title || "Untitled"}
                                                        </div>
                                                        <button
                                                            onClick={(e) => {
                                                                e.stopPropagation();
                                                                onOpen(entry.id);
                                                            }}
                                                            className="p-1.5 rounded-full hover:bg-ocean-50 transition-colors"
                                                            title="Open"
                                                        >
                                                            <i data-lucide="external-link" className="w-4 h-4 text-ocean-700"></i>
                                                        </button>
                                                    </div>

                                                    {/* Owner and Deadline */}
                                                    <div className="flex items-center justify-between text-xs text-graystone-600">
                                                        <div className="flex items-center gap-1">
                                                            <i data-lucide="user" className="w-3 h-3"></i>
                                                            <span>{entry.owner}</span>
                                                        </div>
                                                        {entry.date && (
                                                            <div className="flex items-center gap-1">
                                                                <i data-lucide="calendar" className="w-3 h-3"></i>
                                                                <span>{entry.date}</span>
                                                            </div>
                                                        )}
                                                    </div>
                                                </div>
                                            );
                                        })
                                    )}
                                </div>
                            </div>
                        );
                    })}
                </div>
            );
        }

        function ToDoList({ todos, onAddTodo, onToggleTodo, onBack, currentUser }) {
            const [newTodoText, setNewTodoText] = useState('');
            const [newTodoDate, setNewTodoDate] = useState('');
            const [showScheduleModal, setShowScheduleModal] = useState(false);
            const [showCalendar, setShowCalendar] = useState(false);
            const todoOwner = currentUser || 'Guest';

            const handleAdd = () => {
                if (!newTodoText.trim()) return;
                onAddTodo({
                    text: newTodoText,
                    date: newTodoDate || '',
                    completed: false,
                    user: todoOwner
                });
                setNewTodoText('');
                setNewTodoDate('');
            };

            // Group todos by date
            const todosByDate = todos.reduce((acc, todo) => {
                const date = todo.date || 'No Date';
                if (!acc[date]) acc[date] = [];
                acc[date].push(todo);
                return acc;
            }, {});

            const sortedDates = Object.keys(todosByDate).sort((a, b) => {
                if (a === 'No Date') return 1;
                if (b === 'No Date') return -1;
                return new Date(a) - new Date(b);
            });

            const [currentMonth, setCurrentMonth] = useState(() => {
                const d = new Date();
                d.setDate(1);
                return d;
            });

            const startOfMonth = new Date(currentMonth);
            startOfMonth.setDate(1);
            const daysInMonth = new Date(startOfMonth.getFullYear(), startOfMonth.getMonth() + 1, 0).getDate();
            const firstDay = startOfMonth.getDay();
            const weeks = [];
            let currentDay = 1 - firstDay;
            while (currentDay <= daysInMonth) {
                const week = [];
                for (let i = 0; i < 7; i++) {
                    week.push(currentDay);
                    currentDay++;
                }
                weeks.push(week);
            }

            const getDateString = (day) => {
                const d = new Date(startOfMonth);
                d.setDate(day);
                return d.toISOString().slice(0, 10);
            };

            const tasksByDate = todos.reduce((acc, todo) => {
                const key = todo.date || 'No Date';
                acc[key] = acc[key] || [];
                acc[key].push(todo);
                return acc;
            }, {});
            const noDateTasks = tasksByDate['No Date'] || [];

            const renderDayCell = (day, compact = false) => {
                const inMonth = day >= 1 && day <= daysInMonth;
                const dateKey = inMonth ? getDateString(day) : null;
                const dayTasks = dateKey ? tasksByDate[dateKey] || [] : [];

                return (
                    <div
                        key={day}
                        className={cx(
                            compact ? "border border-graystone-100 rounded-lg p-2 bg-white" : "border border-graystone-100 rounded-lg p-2 min-h-[110px] bg-white",
                            inMonth ? "text-ocean-900" : "text-graystone-300"
                        )}
                    >
                        <div className="flex items-center justify-between mb-1">
                            <span className="text-xs font-semibold">{inMonth ? day : ""}</span>
                            {!compact && inMonth && (
                                <button
                                    onClick={() => {
                                        setNewTodoDate(dateKey);
                                        setShowCalendar(true);
                                    }}
                                    className="text-[10px] px-2 py-1 rounded-full bg-ocean-50 text-ocean-700 border border-ocean-100 hover:bg-ocean-100"
                                >
                                    +
                                </button>
                            )}
                        </div>
                        {compact ? (
                            <div
                                className="h-6 flex items-center gap-1 cursor-pointer"
                                onClick={() => {
                                    setShowCalendar(true);
                                    if (inMonth) setNewTodoDate(dateKey);
                                }}
                            >
                                {dayTasks.slice(0, 3).map((todo) => (
                                    <span key={todo.id} className={cx(
                                        "w-2 h-2 rounded-full",
                                        todo.completed ? "bg-graystone-300" : "bg-ocean-500"
                                    )}></span>
                                ))}
                                {dayTasks.length > 3 && (
                                    <span className="text-[10px] text-graystone-500">+{dayTasks.length - 3}</span>
                                )}
                            </div>
                        ) : (
                            <div className="space-y-1">
                                {dayTasks.map((todo) => (
                                    <div
                                        key={todo.id}
                                        className={cx(
                                            "flex items-center gap-2 p-2 rounded-lg border text-xs",
                                            todo.completed
                                                ? "bg-graystone-50 border-graystone-200 text-graystone-500 line-through"
                                                : "bg-white border-ocean-200 hover:border-ocean-300 text-graystone-900"
                                        )}
                                    >
                                        <input
                                            type="checkbox"
                                            checked={todo.completed}
                                            onChange={() => onToggleTodo(todo.id)}
                                            className={cx(
                                                "w-4 h-4 rounded border-2 cursor-pointer transition-all",
                                                todo.completed
                                                    ? "bg-ocean-600 border-ocean-600"
                                                    : "border-graystone-300 hover:border-ocean-400"
                                            )}
                                        />
                                        <span className="truncate">{todo.text}</span>
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>
                );
            };

            return (
                <div className="animate-in fade-in slide-in-from-bottom-4 duration-500">
                    {/* Header */}
                    <div className="bg-gradient-to-r from-ocean-500 to-ocean-600 rounded-2xl p-8 text-white shadow-xl mb-6">
                        <h1 className="text-3xl font-bold mb-2">My To-Do Calendar</h1>
                        <p className="text-ocean-100">Plan tasks by date and mark them done.</p>
                    </div>

                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-4">
                        {/* Left: Add Task + Calendar link */}
                        <div className="space-y-4">
                            <div className="bg-white rounded-xl border border-ocean-100 shadow-sm p-6">
                                <h3 className="text-lg font-bold text-ocean-900 mb-4">Add New Task</h3>
                                <div className="space-y-3">
                                    <input
                                        type="text"
                                        value={newTodoText}
                                        onChange={(e) => setNewTodoText(e.target.value)}
                                        placeholder="What needs to be done?"
                                        className="w-full px-4 py-2 border border-graystone-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-ocean-500 focus:border-transparent"
                                        onKeyDown={(e) => e.key === 'Enter' && handleAdd()}
                                    />
                                    <div className="flex gap-2">
                                        <button
                                            className="flex-1 px-4 py-2 rounded-xl font-semibold bg-ocean-500 text-white border border-ocean-500 shadow-md hover:bg-ocean-600 transition inline-flex items-center justify-center gap-2"
                                            onClick={handleAdd}
                                        >
                                            <i data-lucide="plus" className="w-4 h-4"></i>
                                            Add Task
                                        </button>
                                        <button
                                            className="flex-1 px-4 py-2 rounded-xl font-semibold bg-ocean-500 text-white border border-ocean-500 shadow-md hover:bg-ocean-600 transition disabled:opacity-50 disabled:cursor-not-allowed inline-flex items-center justify-center gap-2"
                                            onClick={() => {
                                                if (!newTodoText.trim()) return;
                                                setShowScheduleModal(true);
                                            }}
                                            disabled={!newTodoText.trim()}
                                        >
                                            <i data-lucide="calendar-plus" className="w-4 h-4"></i>
                                            Schedule Task
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div className="bg-white rounded-xl border border-ocean-100 shadow-sm p-5 space-y-3">
                                <div className="flex items-center justify-between">
                                    <div>
                                        <h4 className="font-heading text-base text-ocean-900">To-Do Calendar</h4>
                                        <p className="text-xs text-graystone-600">Click a day to view tasks</p>
                                    </div>
                                    <div className="flex items-center gap-2">
                                        <button
                                            onClick={() => {
                                                const prev = new Date(startOfMonth);
                                                prev.setMonth(prev.getMonth() - 1);
                                                setCurrentMonth(prev);
                                            }}
                                            className="w-8 h-8 rounded-full bg-ocean-50 text-ocean-700 border border-ocean-100 hover:bg-ocean-100 flex items-center justify-center"
                                        >
                                            <i data-lucide="chevron-left" className="w-4 h-4"></i>
                                        </button>
                                        <div className="text-sm font-semibold text-ocean-900">
                                            {startOfMonth.toLocaleString('default', { month: 'long', year: 'numeric' })}
                                        </div>
                                        <button
                                            onClick={() => {
                                                const next = new Date(startOfMonth);
                                                next.setMonth(next.getMonth() + 1);
                                                setCurrentMonth(next);
                                            }}
                                            className="w-8 h-8 rounded-full bg-ocean-50 text-ocean-700 border border-ocean-100 hover:bg-ocean-100 flex items-center justify-center"
                                        >
                                            <i data-lucide="chevron-right" className="w-4 h-4"></i>
                                        </button>
                                    </div>
                                </div>
                                <div className="grid grid-cols-7 gap-2 text-xs font-semibold text-graystone-600 mb-2">
                                    {["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"].map((d) => (
                                        <div key={d} className="text-center">{d}</div>
                                    ))}
                                </div>
                                <div className="grid grid-cols-7 gap-2">
                                    {weeks.flat().map((day, idx) => (
                                        <div key={idx} onClick={() => {
                                            if (day >=1 && day <= daysInMonth) {
                                                setNewTodoDate(getDateString(day));
                                                setShowCalendar(true);
                                            }
                                        }}>
                                            {renderDayCell(day, true)}
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>

                        {/* Right: Today's tasks */}
                        <div className="bg-white rounded-xl border border-ocean-100 shadow-sm p-6 space-y-3">
                            <div className="flex items-center justify-between">
                                <h3 className="font-heading text-lg text-ocean-900">Today's Tasks</h3>
                                <Badge variant="secondary">{(tasksByDate[new Date().toISOString().slice(0,10)] || []).length}</Badge>
                            </div>
                            <div className="space-y-2 max-h-[480px] overflow-y-auto pr-1">
                                {(tasksByDate[new Date().toISOString().slice(0,10)] || []).length ? (
                                    (tasksByDate[new Date().toISOString().slice(0,10)] || []).map((todo) => (
                                        <div
                                            key={todo.id}
                                            className={cx(
                                                "flex items-center gap-2 p-3 rounded-xl border transition-all text-sm",
                                                todo.completed
                                                    ? "bg-graystone-50 border-graystone-200 text-graystone-500 line-through"
                                                    : "bg-white border-ocean-200 hover:border-ocean-300 text-graystone-900"
                                            )}
                                        >
                                            <input
                                                type="checkbox"
                                                checked={todo.completed}
                                                onChange={() => onToggleTodo(todo.id)}
                                                className={cx(
                                                    "w-4 h-4 rounded border-2 cursor-pointer transition-all",
                                                    todo.completed
                                                        ? "bg-ocean-600 border-ocean-600"
                                                        : "border-graystone-300 hover:border-ocean-400"
                                                )}
                                            />
                                            <span className="truncate flex-1">{todo.text}</span>
                                        </div>
                                    ))
                                ) : (
                                    <div className="text-xs text-graystone-500 text-center py-10">
                                        No tasks for today.
                                    </div>
                                )}
                            </div>
                            {noDateTasks.length > 0 && (
                                <div className="pt-3 border-t border-graystone-100">
                                    <h4 className="text-xs font-semibold text-graystone-600 mb-2">No Date</h4>
                                    <div className="space-y-2 max-h-[200px] overflow-y-auto pr-1">
                                        {noDateTasks.map((todo) => (
                                            <div
                                                key={todo.id}
                                                className={cx(
                                                    "flex items-center gap-2 p-3 rounded-xl border transition-all text-sm",
                                                    todo.completed
                                                        ? "bg-graystone-50 border-graystone-200 text-graystone-500 line-through"
                                                        : "bg-white border-ocean-200 hover:border-ocean-300 text-graystone-900"
                                                )}
                                            >
                                                <input
                                                    type="checkbox"
                                                    checked={todo.completed}
                                                    onChange={() => onToggleTodo(todo.id)}
                                                    className={cx(
                                                        "w-4 h-4 rounded border-2 cursor-pointer transition-all",
                                                        todo.completed
                                                            ? "bg-ocean-600 border-ocean-600"
                                                            : "border-graystone-300 hover:border-ocean-400"
                                                    )}
                                                />
                                                <span className="truncate flex-1">{todo.text}</span>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>

                    {showCalendar && (
                        <div className="fixed inset-0 flex items-center justify-center bg-black bg-opacity-30 z-50">
                            <div className="bg-white rounded-2xl p-6 w-full max-w-3xl max-h-[80vh] overflow-hidden shadow-xl animate-in fade-in zoom-in-95 duration-200">
                                <div className="flex items-center justify-between mb-4">
                                    <div className="flex items-center gap-2">
                                        <button
                                            onClick={() => {
                                                const prev = new Date(startOfMonth);
                                                prev.setMonth(prev.getMonth() - 1);
                                                setCurrentMonth(prev);
                                            }}
                                            className="w-8 h-8 rounded-full bg-ocean-50 text-ocean-700 border border-ocean-100 hover:bg-ocean-100 flex items-center justify-center"
                                        >
                                            <i data-lucide="chevron-left" className="w-4 h-4"></i>
                                        </button>
                                        <h3 className="font-heading text-2xl text-ocean-900 tracking-wide">
                                            {startOfMonth.toLocaleString('default', { month: 'long', year: 'numeric' })}
                                        </h3>
                                        <button
                                            onClick={() => {
                                                const next = new Date(startOfMonth);
                                                next.setMonth(next.getMonth() + 1);
                                                setCurrentMonth(next);
                                            }}
                                            className="w-8 h-8 rounded-full bg-ocean-50 text-ocean-700 border border-ocean-100 hover:bg-ocean-100 flex items-center justify-center"
                                        >
                                            <i data-lucide="chevron-right" className="w-4 h-4"></i>
                                        </button>
                                    </div>
                                    <button
                                        onClick={() => setShowCalendar(false)}
                                        className="w-8 h-8 flex items-center justify-center rounded-full bg-ocean-500 hover:bg-ocean-600 transition-colors"
                                    >
                                        <i data-lucide="x" className="w-5 h-5 text-white"></i>
                                    </button>
                                </div>
                                <div className="grid grid-cols-7 gap-2 text-xs font-semibold text-graystone-600 mb-2">
                                    {["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"].map((d) => (
                                        <div key={d} className="text-center">{d}</div>
                                    ))}
                                </div>
                                <div className="grid grid-cols-7 gap-2 overflow-y-auto pr-1" style={{ maxHeight: '60vh' }}>
                                    {weeks.flat().map((day, idx) => renderDayCell(day, idx))}
                                </div>
                            </div>
                        </div>
                    )}

                    {showScheduleModal && (
                        <div className="fixed inset-0 flex items-center justify-center bg-black bg-opacity-30 z-50">
                            <div className="bg-white rounded-2xl p-6 w-full max-w-md shadow-xl animate-in fade-in zoom-in-95 duration-200">
                                <div className="flex items-center justify-between mb-3">
                                    <h3 className="text-lg font-bold text-ocean-900">Schedule Task</h3>
                                    <button
                                        onClick={() => setShowScheduleModal(false)}
                                        className="w-8 h-8 flex items-center justify-center rounded-full bg-ocean-500 hover:bg-ocean-600 transition-colors"
                                    >
                                        <i data-lucide="x" className="w-5 h-5 text-white"></i>
                                    </button>
                                </div>
                                    <div className="space-y-3">
                                        <div className="space-y-1">
                                            <label className="text-xs font-semibold text-graystone-600">Date</label>
                                            <input
                                                type="date"
                                                value={newTodoDate}
                                                onChange={(e) => setNewTodoDate(e.target.value)}
                                                className={cx(selectBaseClasses, "w-full")}
                                            />
                                        </div>
                                        <div className="flex justify-end gap-2 pt-2">
                                            <button
                                                onClick={() => setShowScheduleModal(false)}
                                                className="px-4 py-2 text-sm font-medium text-graystone-600 hover:text-graystone-800 transition-colors"
                                            >
                                                Cancel
                                            </button>
                                            <button
                                                onClick={() => {
                                                    if (!newTodoText.trim() || !newTodoDate) return;
                                                    handleAdd();
                                                    setShowScheduleModal(false);
                                                }}
                                                className="px-4 py-2 bg-ocean-600 text-white text-sm font-medium rounded-lg hover:bg-ocean-700 transition-colors shadow-sm disabled:opacity-50 disabled:cursor-not-allowed"
                                                disabled={!newTodoText.trim() || !newTodoDate}
                                            >
                                                Schedule
                                            </button>
                                        </div>
                                    </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        // Sidebar Navigation Component
        function Sidebar({ currentView, onNavigate, currentUser, userEmail, onSignOut }) {
            const userIsAdmin = isAdmin(userEmail);
            const userIsManager = isManager(userEmail);

            const menuItems = [
                { id: 'dashboard', label: 'Dashboard', icon: 'layout-dashboard' },
                { id: 'personal', label: 'Your Projects', icon: 'folder' },
                { id: 'project-explorer', label: 'Project Explorer', icon: 'compass' },
                // Manager Hub only visible to managers and admins
                ...(userIsManager || userIsAdmin ? [{ id: 'manager-hub', label: 'Manager Hub', icon: 'briefcase' }] : []),
                { id: 'todo', label: 'To-Do List', icon: 'check-square' }
            ];

            return (
                <div className="w-64 bg-white flex flex-col h-screen fixed left-0 top-0 z-10 border-r border-ocean-100 shadow-sm">
                    {/* Logo/Header */}
                    <div className="p-6 border-b border-ocean-100">
                        <h1 className="text-2xl text-ocean-900">{currentUser.split(' ')[0]}'s Project Hub</h1>
                        <p className="text-xs text-ocean-600 mt-1">Workflow Management</p>
                    </div>

                    {/* Navigation Items */}
                    <nav className="flex-1 p-4 space-y-1 overflow-y-auto">
                        {menuItems.map(item => (
                            <button
                                key={item.id}
                                onClick={() => onNavigate(item.id)}
                                className={cx(
                                    "w-full flex items-center gap-3 px-4 py-3 rounded-xl text-left transition-all group",
                                    currentView === item.id
                                        ? "bg-ocean-500 text-white shadow-lg"
                                        : "text-ocean-900 hover:bg-ocean-50"
                                )}
                            >
                                <div className="relative flex items-center justify-center">
                                    {/* Hover Circle - Behind Icon */}
                                    <div
                                        className={cx(
                                            "absolute w-10 h-10 rounded-full transition-all duration-300",
                                            currentView === item.id
                                                ? "scale-0 opacity-0"
                                                : "scale-0 opacity-0 group-hover:scale-100 group-hover:opacity-100"
                                        )}
                                        style={{ backgroundColor: '#0CFFFF' }}
                                    ></div>

                                    <i data-lucide={item.icon} className="w-5 h-5 relative z-10"></i>
                                </div>
                                <span className="font-heading text-sm tracking-wide">{item.label}</span>
                            </button>
                        ))}

                        {/* Admin Console - Only visible to admin */}
                        {userIsAdmin && (
                            <button
                                onClick={() => onNavigate('admin')}
                                className={cx(
                                    "w-full flex items-center gap-3 px-4 py-3 rounded-xl text-left transition-all group mt-4 border-t border-ocean-100 pt-4",
                                    currentView === 'admin'
                                        ? "bg-amber-500 text-white shadow-lg"
                                        : "text-amber-700 hover:bg-amber-50 bg-amber-50/50"
                                )}
                            >
                                <div className="relative flex items-center justify-center">
                                    <i data-lucide="shield" className="w-5 h-5 relative z-10"></i>
                                </div>
                                <span className="font-heading text-sm tracking-wide">Admin Console</span>
                            </button>
                        )}
                    </nav>

                    {/* Add New Item - Special Button */}
                    <div className="p-4 border-t border-ocean-100">
                        <button
                            onClick={() => onNavigate('add-item')}
                            className={cx(
                                "w-full flex items-center justify-center gap-2 px-4 py-3 rounded-xl text-left transition-all font-semibold",
                                currentView === 'add-item'
                                    ? "bg-ocean-600 text-white shadow-lg"
                                    : "bg-ocean-500 text-white hover:bg-ocean-600 shadow-md"
                            )}
                        >
                            <i data-lucide="plus-circle" className="w-5 h-5"></i>
                            <span className="font-heading text-sm tracking-wide">Add New Item</span>
                        </button>
                    </div>

                    {/* User Profile Section */}
                    <div className="p-4 border-t border-ocean-100">
                        <div className="flex items-center gap-3 p-3 rounded-xl bg-ocean-50">
                            <div className="w-10 h-10 rounded-full bg-ocean-500 flex items-center justify-center text-white font-bold">
                                {currentUser.split(' ').map(n => n[0]).join('')}
                            </div>
                            <div className="flex-1 min-w-0">
                                <div className="font-medium text-sm text-ocean-900 truncate">{currentUser}</div>
                                <div className="text-xs text-ocean-600">{userIsAdmin ? 'Administrator' : userIsManager ? 'Manager' : 'Team Member'}</div>
                            </div>
                        </div>

                        {/* Sign Out Button - Only when auth is enabled */}
                        {AUTH_CONFIG.AUTH_ENABLED && onSignOut && (
                            <button
                                onClick={onSignOut}
                                className="w-full mt-2 flex items-center justify-center gap-2 px-4 py-2 text-sm text-graystone-600 hover:text-red-600 hover:bg-red-50 rounded-lg transition"
                            >
                                <i data-lucide="log-out" className="w-4 h-4"></i>
                                Sign Out
                            </button>
                        )}
                    </div>
                </div>
            );
        }

        // Dashboard Component
        function Dashboard({ entries, currentUser, onOpenEntry }) {
            const now = new Date();
            const thirtyDaysFromNow = new Date(now.getTime() + 30 * 24 * 60 * 60 * 1000);

            // User's tasks
            const myTasks = entries.filter(e => e.owner === currentUser || (e.collaborators && e.collaborators.includes(currentUser)));
            const inProgress = myTasks.filter(e => e.workflowStatus !== 'Done' && e.workflowStatus !== 'Idea');
            const completed = myTasks.filter(e => e.workflowStatus === 'Done');

            // Upcoming deadlines
            const upcomingDeadlines = entries
                .filter(e => {
                    const deadline = new Date(e.date || e.timelineValue);
                    return deadline >= now && deadline <= thirtyDaysFromNow;
                })
                .filter(e => e.owner === currentUser || (e.collaborators && e.collaborators.includes(currentUser)))
                .sort((a, b) => new Date(a.date || a.timelineValue) - new Date(b.date || b.timelineValue))
                .slice(0, 5);

            // Recent comments (simulated - would come from real data)
            const recentComments = myTasks
                .filter(e => e.firstComment)
                .slice(0, 3)
                .map(e => ({
                    id: e.id,
                    title: e.title,
                    comment: e.firstComment,
                    user: e.owner,
                    time: 'Recently'
                }));

            // Project updates (tasks that changed recently - simulated)
            const projectUpdates = entries
                .filter(e => (e.collaborators && e.collaborators.includes(currentUser)) || e.team)
                .slice(0, 4)
                .map(e => ({
                    id: e.id,
                    title: e.title,
                    status: e.workflowStatus,
                    team: e.team,
                    owner: e.owner
                }));

            // Task List Modal State
            const [showTaskListModal, setShowTaskListModal] = useState(false);
            const [taskListType, setTaskListType] = useState(''); // 'assigned', 'inProgress', 'completed'
            const [taskListItems, setTaskListItems] = useState([]);

            const openTaskList = (type) => {
                setTaskListType(type);
                if (type === 'assigned') {
                    setTaskListItems(myTasks);
                } else if (type === 'inProgress') {
                    setTaskListItems(inProgress);
                } else if (type === 'completed') {
                    setTaskListItems(completed);
                }
                setShowTaskListModal(true);
            };

            return (
                <div className="space-y-6" id="dashboard-export-content">
                    {/* Welcome Header */}
                    <div className="bg-gradient-to-r from-ocean-500 to-ocean-600 rounded-2xl p-8 text-white shadow-xl">
                        <div className="flex items-start justify-between">
                            <div>
                                <h1 className="text-3xl font-bold mb-2">Welcome back, {currentUser.split(' ')[0]}!</h1>
                                <p className="text-ocean-100">Here's what's happening with your projects</p>
                            </div>
                            <button
                                onClick={() => exportToPDF('dashboard-export-content', `${currentUser.replace(/\s+/g, '_')}_Dashboard`, `${currentUser}'s Dashboard`)}
                                className="flex items-center gap-2 px-4 py-2 bg-white/20 hover:bg-white/30 text-white rounded-lg transition text-sm font-medium border border-white/20"
                            >
                                <i data-lucide="download" className="w-4 h-4"></i>
                                Export PDF
                            </button>
                        </div>
                    </div>

                    {/* Stats Cards */}
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div className="bg-white rounded-xl p-6 border border-ocean-100 shadow-sm hover:shadow-md transition-shadow cursor-pointer group" onClick={() => openTaskList('assigned')}>
                            <div className="flex items-center justify-between">
                                <div>
                                    <p className="font-heading text-sm text-graystone-600 mb-1 tracking-wide">Assigned Tasks</p>
                                    <div className="relative inline-flex items-center justify-center">
                                        {/* Hover Circle - Behind Number */}
                                        <div
                                            className="absolute rounded-full transition-all duration-300 scale-0 opacity-0 group-hover:scale-100 group-hover:opacity-100"
                                            style={{ backgroundColor: '#0CFFFF', width: '43px', height: '43px' }}
                                        ></div>
                                        <p className="text-3xl font-bold text-ocean-900 relative z-10">{myTasks.length}</p>
                                    </div>
                                </div>
                                <div className="w-12 h-12 bg-ocean-50 rounded-xl flex items-center justify-center">
                                    <i data-lucide="briefcase" className="w-6 h-6 text-ocean-600"></i>
                                </div>
                            </div>
                        </div>

                        <div className="bg-white rounded-xl p-6 border border-ocean-100 shadow-sm hover:shadow-md transition-shadow cursor-pointer group" onClick={() => openTaskList('inProgress')}>
                            <div className="flex items-center justify-between">
                                <div>
                                    <p className="font-heading text-sm text-graystone-600 mb-1 tracking-wide">In Progress</p>
                                    <div className="relative inline-flex items-center justify-center">
                                        {/* Hover Circle - Behind Number */}
                                        <div
                                            className="absolute rounded-full transition-all duration-300 scale-0 opacity-0 group-hover:scale-100 group-hover:opacity-100"
                                            style={{ backgroundColor: '#0CFFFF', width: '43px', height: '43px' }}
                                        ></div>
                                        <p className="text-3xl font-bold text-ocean-900 relative z-10">{inProgress.length}</p>
                                    </div>
                                </div>
                                <div className="w-12 h-12 bg-blue-50 rounded-xl flex items-center justify-center">
                                    <i data-lucide="activity" className="w-6 h-6 text-blue-600"></i>
                                </div>
                            </div>
                        </div>

                        <div className="bg-white rounded-xl p-6 border border-ocean-100 shadow-sm">
                            <div className="flex items-center justify-between">
                                <div>
                                    <p className="font-heading text-sm text-graystone-600 mb-1 tracking-wide">Completed</p>
                                    <p className="text-3xl font-bold text-ocean-900">{completed.length}</p>
                                </div>
                                <div className="w-12 h-12 bg-green-50 rounded-xl flex items-center justify-center">
                                    <i data-lucide="check-circle" className="w-6 h-6 text-green-600"></i>
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* Two Column Layout */}
                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        {/* Upcoming Deadlines */}
                        <div className="bg-white rounded-xl border border-ocean-100 shadow-sm p-6">
                            <h3 className="font-heading text-lg text-ocean-900 mb-4 flex items-center gap-2 tracking-wide">
                                <i data-lucide="clock" className="w-5 h-5"></i>
                                Upcoming Deadlines
                            </h3>
                            <div className="space-y-3">
                                {upcomingDeadlines.length > 0 ? (
                                    upcomingDeadlines.map(item => (
                                        <div key={item.id} className="flex items-center justify-between p-4 rounded-xl bg-gradient-to-r from-ocean-500 to-ocean-600 text-white shadow-md hover:shadow-lg transition-all">
                                            <div className="flex-1 min-w-0">
                                                <div className="font-medium text-sm truncate heading-font">{item.title}</div>
                                                <div className="text-xs opacity-80">{item.date || item.timelineValue}</div>
                                            </div>
                                            <div className="flex items-center gap-2">
                                                <Badge variant={item.workflowStatus === 'Done' ? 'success' : 'default'} className="text-[10px] ml-2">
                                                    {item.workflowStatus}
                                                </Badge>
                                                <button
                                                    onClick={() => onOpenEntry(item.id)}
                                                    className="p-1.5 rounded-full hover:bg-white/10 transition-colors"
                                                    title="Open"
                                                >
                                                    <i data-lucide="external-link" className="w-4 h-4 text-white"></i>
                                                </button>
                                            </div>
                                        </div>
                                    ))
                                ) : (
                                    <div className="text-center py-8 text-graystone-400 text-sm">
                                        No upcoming deadlines in the next 30 days
                                    </div>
                                )}
                            </div>
                        </div>

                        {/* Recent Comments */}
                        <div className="bg-white rounded-xl border border-ocean-100 shadow-sm p-6">
                            <h3 className="font-heading text-lg text-ocean-900 mb-4 flex items-center gap-2 tracking-wide">
                                <i data-lucide="message-square" className="w-5 h-5"></i>
                                Recent Comments
                            </h3>
                            <div className="space-y-3">
                                {recentComments.length > 0 ? (
                                    recentComments.map(comment => (
                                        <div key={comment.id} className="p-4 rounded-xl bg-gradient-to-r from-ocean-500 to-ocean-600 text-white shadow-md hover:shadow-lg transition-all">
                                            <div className="font-medium text-sm mb-1 heading-font">{comment.title}</div>
                                            <p className="text-xs opacity-90 line-clamp-2">{comment.comment}</p>
                                            <div className="text-xs opacity-70 mt-2">{comment.user} · {comment.time}</div>
                                        </div>
                                    ))
                                ) : (
                                    <div className="text-center py-8 text-graystone-400 text-sm">
                                        No recent comments
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>

                    {/* Project Updates */}
                    <div className="bg-white rounded-xl border border-ocean-100 shadow-sm p-6">
                        <h3 className="font-heading text-lg text-ocean-900 mb-4 flex items-center gap-2 tracking-wide">
                            <i data-lucide="bell" className="w-5 h-5"></i>
                            Project Updates
                        </h3>
                        <div className="space-y-2">
                            {projectUpdates.length > 0 ? (
                                projectUpdates.map(update => (
                                    <div key={update.id} className="flex items-center justify-between p-4 rounded-xl bg-gradient-to-r from-ocean-500 to-ocean-600 text-white shadow-md hover:shadow-lg transition-all">
                                        <div className="flex items-center gap-3">
                                            <div className={cx(
                                                "w-2 h-2 rounded-full",
                                                update.status === 'Done' ? "bg-white" : "bg-cyan-300"
                                            )}></div>
                                            <div>
                                                <div className="font-medium text-sm heading-font">{update.title}</div>
                                                <div className="text-xs opacity-80">{update.team} · {update.owner}</div>
                                            </div>
                                        </div>
                                        <Badge variant="neutral" className="text-[10px]">{update.status}</Badge>
                                    </div>
                                ))
                            ) : (
                                <div className="text-center py-8 text-graystone-400 text-sm">
                                    No recent updates
                                </div>
                            )}
                        </div>
                    </div>

                    {/* Task List Modal */}
                    {showTaskListModal && (
                        <div className="fixed inset-0 flex items-center justify-center bg-black bg-opacity-30 z-50">
                            <div className="bg-white rounded-2xl p-6 w-full max-w-2xl max-h-[80vh] overflow-hidden shadow-xl animate-in fade-in zoom-in-95 duration-200">
                                <div className="flex items-center justify-between mb-4">
                                    <h3 className="font-heading text-2xl text-ocean-900 tracking-wide">
                                        {taskListType === 'assigned' && 'Assigned Tasks'}
                                        {taskListType === 'inProgress' && 'In Progress'}
                                        {taskListType === 'completed' && 'Completed Tasks'}
                                    </h3>
                                    <button
                                        onClick={() => setShowTaskListModal(false)}
                                        className="w-8 h-8 flex items-center justify-center rounded-full bg-ocean-500 hover:bg-ocean-600 transition-colors"
                                    >
                                        <i data-lucide="x" className="w-5 h-5 text-white"></i>
                                    </button>
                                </div>

                                <div className="overflow-y-auto max-h-[60vh] space-y-2">
                                    {taskListItems.length > 0 ? (
                                        taskListItems.map(task => (
                                            <button
                                                key={task.id}
                                                onClick={() => {
                                                    setShowTaskListModal(false);
                                                    onOpenEntry(task.id);
                                                }}
                                                className="w-full flex items-center justify-between p-4 rounded-xl border border-ocean-100 hover:border-ocean-500 hover:bg-ocean-50 transition-all group text-left"
                                            >
                                                <div className="flex-1 min-w-0">
                                                    <div className="font-medium text-sm text-ocean-900 truncate mb-1 heading-font">{task.title}</div>
                                                    <div className="flex items-center gap-3 text-xs text-graystone-600">
                                                        <div className="flex items-center gap-1">
                                                            <i data-lucide="user" className="w-3 h-3"></i>
                                                            <span>{task.owner}</span>
                                                        </div>
                                                        {task.date && (
                                                            <div className="flex items-center gap-1">
                                                                <i data-lucide="calendar" className="w-3 h-3"></i>
                                                                <span>{task.date}</span>
                                                            </div>
                                                        )}
                                                        {task.team && (
                                                            <div className="flex items-center gap-1">
                                                                <i data-lucide="users" className="w-3 h-3"></i>
                                                                <span>{task.team}</span>
                                                            </div>
                                                        )}
                                                    </div>
                                                </div>
                                                <div className="flex items-center gap-2 ml-4">
                                                    <Badge variant={task.workflowStatus === 'Done' ? 'success' : 'default'} className="text-[10px]">
                                                        {task.workflowStatus}
                                                    </Badge>
                                                    <i data-lucide="external-link" className="w-5 h-5 text-graystone-400 group-hover:text-ocean-500"></i>
                                                </div>
                                            </button>
                                        ))
                                    ) : (
                                        <div className="text-center py-12 text-graystone-400">
                                            <i data-lucide="inbox" className="w-12 h-12 mx-auto mb-3 opacity-50"></i>
                                            <p className="text-sm">No tasks found</p>
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        // Project Explorer Component - Combines Teams, Org, and Calendar
        function ProjectExplorer({
            entries,
            onOpen,
            onUpdateStatus,
            openSubtaskModal,
            currentUser = "Guest",
            searchQuery,
            setSearchQuery,
            filterTags,
            setFilterTags,
            filterUsers,
            setFilterUsers,
            filterTeams,
            setFilterTeams,
            availableTags,
            filterEntries,
            viewMode,
            setViewMode
        }) {
            // Simplified Project Explorer - Defaults to Organisational View
            return (
                <div className="flex flex-col animate-in fade-in duration-500 space-y-6">
                    <FilterBar
                        title="Project Explorer"
                        subtitle="High-level view of all projects"
                        searchQuery={searchQuery}
                        setSearchQuery={setSearchQuery}
                        filterTags={filterTags}
                        setFilterTags={setFilterTags}
                        filterUsers={filterUsers}
                        setFilterUsers={setFilterUsers}
                        filterTeams={filterTeams}
                        setFilterTeams={setFilterTeams}
                        availableTags={availableTags}
                        viewMode={viewMode}
                        setViewMode={setViewMode}
                    />

                    {viewMode === 'calendar' ? (
                        <div className="bg-white rounded-xl border border-ocean-100 shadow-sm p-6">
                            <CalendarScreen entries={filterEntries(entries)} onBack={() => { }} openSubtaskModal={openSubtaskModal} onOpen={onOpen} isEmbedded={true} />
                        </div>
                    ) : (
                        <div className="bg-white rounded-xl border border-ocean-100 shadow-sm p-6">
                            {viewMode === 'kanban' && (
                                <KanbanBoard statuses={KANBAN_STATUSES} entries={filterEntries(entries)} onUpdateStatus={onUpdateStatus} onOpen={onOpen} openSubtaskModal={openSubtaskModal} currentUser={currentUser} />
                            )}
                            {viewMode === 'table' && (
                                <TableView entries={filterEntries(entries)} onOpen={onOpen} />
                            )}
                            {viewMode === 'list' && (
                                <ListView entries={filterEntries(entries)} onOpen={onOpen} />
                            )}
                            {viewMode === 'gantt' && (
                                <GanttView entries={filterEntries(entries)} onOpen={onOpen} />
                            )}
                        </div>
                    )}
                </div>
            );
        }

        function ItemDashboard({ entry, onBack, onToggleSubtask, onUpdateEntry, openSubtaskModal, currentUser }) {
            const getCaption = () => (entry && typeof entry.caption === 'string' ? entry.caption : "");
            const getDocuments = () => (entry && Array.isArray(entry.documents) ? entry.documents : []);

            const [descriptionModalOpen, setDescriptionModalOpen] = useState(false);
            const [documentsModalOpen, setDocumentsModalOpen] = useState(false);
            const [descriptionDraft, setDescriptionDraft] = useState(getCaption());
            const [documentsDraft, setDocumentsDraft] = useState(getDocuments());
            const [newDocInput, setNewDocInput] = useState("");
            const fileInputRef = useRef(null);
            const [activeSubtask, setActiveSubtask] = useState(null);
            const [commentText, setCommentText] = useState("");
            const [mentionQuery, setMentionQuery] = useState("");
            const [mentionOptions, setMentionOptions] = useState([]);

            useEffect(() => {
                setDescriptionDraft(getCaption());
                setDocumentsDraft(getDocuments());
                setCommentText("");
                setMentionQuery("");
                setMentionOptions([]);
            }, [entry]);

            useEffect(() => {
                if (typeof lucide !== 'undefined') {
                    lucide.createIcons();
                }
            }, [descriptionModalOpen, documentsModalOpen]);

            if (!entry) return null;

            const handleDescriptionSave = () => {
                if (onUpdateEntry) {
                    onUpdateEntry(entry.id, { caption: descriptionDraft });
                }
                setDescriptionModalOpen(false);
            };

            const handleDocumentsSave = () => {
                if (onUpdateEntry) {
                    const cleaned = documentsDraft.map((doc) => (doc || "").trim()).filter(Boolean);
                    onUpdateEntry(entry.id, { documents: cleaned });
                }
                setNewDocInput("");
                setDocumentsModalOpen(false);
            };

            const addDocumentDraft = () => {
                const trimmed = newDocInput.trim();
                if (!trimmed) return;
                setDocumentsDraft((prev) => [...prev, trimmed]);
                setNewDocInput("");
            };

            const handleFileSelect = (event) => {
                const files = Array.from(event.target.files || []);
                if (!files.length) return;
                setDocumentsDraft((prev) => [...prev, ...files.map((file) => file.name)]);
                event.target.value = "";
            };

            const triggerUpload = () => {
                if (fileInputRef.current) fileInputRef.current.click();
            };

            const removeDocumentDraft = (index) => {
                setDocumentsDraft((prev) => prev.filter((_, i) => i !== index));
            };

            const updateMentionOptions = (value) => {
                const match = value.match(/@([a-z0-9\s]*)$/i);
                if (match) {
                    const query = match[1].trim().toLowerCase();
                    setMentionQuery(query);
                    const pool = Array.from(new Set([...(entry.collaborators || []), entry.owner, ...USERS])).filter(Boolean);
                    const options = pool.filter((name) => name.toLowerCase().includes(query));
                    setMentionOptions(options.slice(0, 6));
                } else {
                    setMentionQuery("");
                    setMentionOptions([]);
                }
            };

            const handleCommentChange = (e) => {
                const value = e.target.value;
                setCommentText(value);
                updateMentionOptions(value);
            };

            const handleMentionPick = (name) => {
                setCommentText((prev) => {
                    const replacement = `@${name}`;
                    return prev.replace(/@([a-z0-9\s]*)$/i, `${replacement} `);
                });
                setMentionQuery("");
                setMentionOptions([]);
            };

            const handleCommentSubmit = (e) => {
                e.preventDefault();
                if (!commentText.trim()) return;

                const newComment = {
                    id: `c${Date.now()}`,
                    text: commentText.trim(),
                    author: currentUser,
                    timestamp: new Date().toISOString()
                };

                const existingComments = entry.comments || [];
                onUpdateEntry(entry.id, { comments: [...existingComments, newComment] });

                setCommentText("");
                setMentionQuery("");
                setMentionOptions([]);
            };

            const handleOpenSubtaskModal = () => {
                if (openSubtaskModal) {
                    openSubtaskModal(entry.id);
                }
            };

            return (
                <>
                    <div className="animate-in fade-in slide-in-from-bottom-4 duration-500">
                    {/* Header */}
                    <div className="flex items-center justify-between mb-8">
                        <div className="flex items-center gap-4">
                            <Button variant="ghost" onClick={onBack} className="rounded-full p-2 hover:bg-ocean-50">
                                <i data-lucide="arrow-left" className="w-6 h-6 text-ocean-600"></i>
                            </Button>
                            <div>
                                <h1 className="text-3xl font-bold text-ocean-900">{entry.title}</h1>
                                <div className="flex items-center gap-2 mt-1">
                                    <Badge variant="outline">{entry.workflowStatus}</Badge>
                                    <span className="text-sm text-graystone-500">Created on {new Date(entry.date).toLocaleDateString()}</span>
                                </div>
                            </div>
                        </div>
                        <select
                            className="px-4 py-3 rounded-xl bg-white border-2 border-ocean-200 text-ocean-900 font-medium hover:border-ocean-400 focus:border-ocean-500 focus:outline-none transition-all cursor-pointer shadow-sm"
                            value={entry.workflowStatus}
                            onChange={(e) => onUpdateEntry(entry.id, { workflowStatus: e.target.value })}
                        >
                            {KANBAN_STATUSES.map(status => (
                                <option key={status} value={status}>{status}</option>
                            ))}
                        </select>
                    </div>

                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        {/* Main Content */}
                        <div className="lg:col-span-2 space-y-6">
                            {/* Description */}
                            <div className="bg-white rounded-3xl p-6 border border-ocean-100 shadow-sm">
                                <div className="flex items-center justify-between mb-3">
                                    <h3 className="text-lg font-bold text-ocean-900">Description</h3>
                                    <button
                                        onClick={() => {
                                            setDescriptionDraft(getCaption());
                                            setDescriptionModalOpen(true);
                                        }}
                                        className="w-8 h-8 flex items-center justify-center rounded-lg hover:bg-ocean-50 transition-colors"
                                    >
                                        <i data-lucide="edit" className="w-5 h-5 text-ocean-600"></i>
                                    </button>
                                </div>
                                <p className="text-graystone-700 leading-relaxed">
                                    {entry.caption || "No description provided."}
                                </p>
                            </div>

                            {/* Documents */}
                            <div className="bg-white rounded-3xl p-6 border border-ocean-100 shadow-sm">
                                <div className="flex items-center justify-between mb-4">
                                    <h3 className="text-lg font-bold text-ocean-900">Documents</h3>
                                    <button
                                        onClick={() => {
                                            setDocumentsDraft(getDocuments());
                                            setNewDocInput("");
                                            setDocumentsModalOpen(true);
                                        }}
                                        className="w-8 h-8 flex items-center justify-center rounded-lg hover:bg-ocean-50 transition-colors"
                                    >
                                        <i data-lucide="plus" className="w-5 h-5 text-ocean-600"></i>
                                    </button>
                                </div>
                                {entry.documents && entry.documents.length > 0 ? (
                                    <div className="grid grid-cols-1 sm:grid-cols-2 gap-3">
                                        {entry.documents.map((doc, i) => (
                                            <div key={i} className="flex items-center gap-3 p-3 rounded-xl border border-graystone-200 hover:border-ocean-300 hover:bg-ocean-50 transition-all cursor-pointer group">
                                                <div className="bg-ocean-100 p-2 rounded-lg text-ocean-600 group-hover:bg-white group-hover:text-ocean-700 transition-colors">
                                                    <i data-lucide="file-text" className="w-5 h-5"></i>
                                                </div>
                                                <div className="flex-1 min-w-0">
                                                    <div className="text-sm font-medium text-graystone-900 truncate">{doc}</div>
                                                    <div className="text-xs text-graystone-500">SharePoint</div>
                                                </div>
                                                <i data-lucide="download" className="w-4 h-4 text-graystone-400 group-hover:text-ocean-600"></i>
                                            </div>
                                        ))}
                                    </div>
                                ) : (
                                    <div className="text-center py-8 text-graystone-500 bg-graystone-50 rounded-xl border border-dashed border-graystone-200">
                                        No documents attached
                                    </div>
                                )}
                            </div>

                            {/* Subtasks */}
                            <div className="bg-white rounded-3xl p-6 border border-ocean-100 shadow-sm">
                                <div className="flex items-center justify-between mb-4">
                                    <div className="flex items-center gap-2">
                                        <h3 className="text-lg font-bold text-ocean-900">Subtasks</h3>
                                        {entry.subtasks && entry.subtasks.length > 0 && (
                                            <Badge variant="secondary">
                                                {entry.subtasks.filter(st => st.completed).length}/{entry.subtasks.length}
                                            </Badge>
                                        )}
                                    </div>
                                    <div className="flex items-center gap-2">
                                        <button
                                            onClick={handleOpenSubtaskModal}
                                            disabled={!openSubtaskModal}
                                            className={cx(
                                                "w-8 h-8 flex items-center justify-center rounded-lg transition-colors",
                                                openSubtaskModal ? "hover:bg-ocean-50" : "cursor-not-allowed opacity-50"
                                            )}
                                            title="Add subtask"
                                        >
                                            <i data-lucide="plus" className="w-5 h-5 text-ocean-600"></i>
                                        </button>
                                        <button
                                            onClick={() => {
                                                if (entry.subtasks && entry.subtasks.length) {
                                                    setActiveSubtask(entry.subtasks[0]);
                                                }
                                            }}
                                            disabled={!entry.subtasks || !entry.subtasks.length}
                                            className={cx(
                                                "w-8 h-8 flex items-center justify-center rounded-lg transition-colors",
                                                entry.subtasks && entry.subtasks.length ? "hover:bg-ocean-50" : "cursor-not-allowed opacity-50"
                                            )}
                                            title="View subtask details"
                                        >
                                            <i data-lucide="info" className="w-5 h-5 text-ocean-600"></i>
                                        </button>
                                    </div>
                                </div>

                                {entry.subtasks && entry.subtasks.length > 0 ? (
                                    <div className="space-y-2">
                                        {entry.subtasks.map((subtask) => {
                                            const viewer = currentUser || 'Guest';
                                            const canToggle = subtask.assignedTo === viewer;

                                            return (
                                                <div
                                                    key={subtask.id}
                                                    className={cx(
                                                        "flex items-center gap-3 p-3 rounded-xl border transition-all",
                                                        subtask.completed
                                                            ? "bg-graystone-50 border-graystone-200"
                                                            : "bg-white border-ocean-200 hover:border-ocean-300"
                                                    )}
                                                    onClick={() => setActiveSubtask(subtask)}
                                                >
                                                    <input
                                                        type="checkbox"
                                                        checked={subtask.completed}
                                                        disabled={!canToggle}
                                                        onChange={() => canToggle && onToggleSubtask(entry.id, subtask.id)}
                                                        className={cx(
                                                            "w-5 h-5 rounded border-2 transition-all",
                                                            canToggle ? "cursor-pointer" : "cursor-not-allowed opacity-50",
                                                            subtask.completed
                                                                ? "bg-ocean-600 border-ocean-600"
                                                                : "border-graystone-300 hover:border-ocean-400"
                                                        )}
                                                    />
                                                    <div className="flex-1 min-w-0">
                                                        <div className={cx(
                                                            "text-sm font-medium",
                                                            subtask.completed
                                                                ? "line-through text-graystone-500"
                                                                : "text-graystone-900"
                                                        )}>
                                                            {subtask.title}
                                                        </div>
                                                    </div>
                                                    <div className="flex items-center gap-2">
                                                        <div className="w-6 h-6 rounded-full bg-ocean-100 flex items-center justify-center text-xs font-bold text-ocean-600 border border-ocean-200" title={subtask.assignedTo}>
                                                            {subtask.assignedTo.charAt(0)}
                                                        </div>
                                                        <span className="text-xs text-graystone-500">{subtask.assignedTo.split(' ')[0]}</span>
                                                        <button
                                                            type="button"
                                                            onClick={(e) => { e.stopPropagation(); setActiveSubtask(subtask); }}
                                                            className="p-1 rounded-full hover:bg-ocean-50 transition-colors"
                                                            title="Open subtask"
                                                        >
                                                            <i data-lucide="external-link" className="w-4 h-4 text-ocean-700"></i>
                                                        </button>
                                                    </div>
                                                </div>
                                            );
                                        })}
                                    </div>
                                ) : (
                                    <div className="text-center py-6 text-graystone-500 bg-graystone-50 rounded-xl border border-dashed border-graystone-200">
                                        No subtasks yet
                                    </div>
                                )}
                            </div>

                            {/* Comments / Activity */}
                            <div className="bg-white rounded-3xl p-6 border border-ocean-100 shadow-sm">
                                <h3 className="text-lg font-bold text-ocean-900 mb-4">Activity & Comments</h3>

                                {/* Existing Comments */}
                                {(entry.comments && entry.comments.length > 0) ? (
                                    <div className="space-y-4 mb-4 max-h-[400px] overflow-y-auto">
                                        {entry.comments.map((comment) => (
                                            <div key={comment.id} className="flex gap-4">
                                                <div className="w-10 h-10 rounded-full bg-aqua-100 flex items-center justify-center text-ocean-700 font-bold text-sm shrink-0">
                                                    {comment.author ? comment.author.charAt(0) : 'U'}
                                                </div>
                                                <div className="flex-1 space-y-1">
                                                    <div className="flex items-center justify-between">
                                                        <span className="text-sm font-bold text-graystone-900">{comment.author || "User"}</span>
                                                        <span className="text-xs text-graystone-500">
                                                            {comment.timestamp ? new Date(comment.timestamp).toLocaleString() : 'Recently'}
                                                        </span>
                                                    </div>
                                                    <div className="text-sm text-graystone-700 bg-graystone-50 p-3 rounded-tr-xl rounded-br-xl rounded-bl-xl">
                                                        {comment.text}
                                                    </div>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                ) : (
                                    <div className="text-sm text-graystone-500 mb-4">No comments yet. Be the first to comment!</div>
                                )}

                                {/* Add Comment Textbox */}
                                <div className="flex gap-3 pt-4 border-t border-graystone-100">
                                    <div className="w-10 h-10 rounded-full bg-ocean-500 flex items-center justify-center text-white font-bold text-sm">
                                        {currentUser ? currentUser.charAt(0) : 'U'}
                                    </div>
                                    <form className="flex-1" onSubmit={handleCommentSubmit}>
                                        <div className="relative">
                                            <textarea
                                                placeholder="Add a comment... use @ to mention"
                                                value={commentText}
                                                onChange={handleCommentChange}
                                                className="w-full px-4 py-3 border-2 border-graystone-200 rounded-xl focus:border-ocean-500 focus:outline-none resize-none transition-colors"
                                                rows="3"
                                            ></textarea>
                                            {mentionOptions.length > 0 && (
                                                <div className="absolute left-0 right-0 mt-1 rounded-xl border border-ocean-100 bg-white shadow-lg z-10">
                                                    {mentionOptions.map((name) => (
                                                        <button
                                                            type="button"
                                                            key={name}
                                                            onClick={() => handleMentionPick(name)}
                                                            className="w-full text-left px-3 py-2 text-sm text-graystone-800 hover:bg-ocean-50 flex items-center gap-2"
                                                        >
                                                            <span className="w-6 h-6 rounded-full bg-ocean-100 text-ocean-700 flex items-center justify-center text-xs font-bold">
                                                                {name.charAt(0)}
                                                            </span>
                                                            <span>{name}</span>
                                                        </button>
                                                    ))}
                                                </div>
                                            )}
                                        </div>
                                        <div className="flex justify-end mt-2">
                                            <button type="submit" className="px-4 py-2 bg-ocean-500 text-white rounded-lg hover:bg-ocean-600 transition-colors font-medium text-sm">
                                                Post Comment
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>

                        {/* Sidebar */}
                        <div className="space-y-6">
                            {/* Metadata Card */}
                            <div className="bg-white rounded-3xl p-6 border border-ocean-100 shadow-sm space-y-4">
                                <h3 className="text-lg font-bold text-ocean-900 mb-2">Details</h3>

                                <div>
                                    <div className="text-xs font-semibold text-graystone-500 uppercase tracking-wider mb-1">Team</div>
                                    <div className="flex items-center gap-2">
                                        <div className="w-2 h-2 rounded-full bg-ocean-500"></div>
                                        <span className="text-sm font-medium text-graystone-900">{entry.team}</span>
                                    </div>
                                </div>

                                <div>
                                    <div className="text-xs font-semibold text-graystone-500 uppercase tracking-wider mb-1">Owner</div>
                                    <div className="flex items-center gap-2">
                                        <div className="w-6 h-6 rounded-full bg-graystone-200 flex items-center justify-center text-xs font-bold text-graystone-600">
                                            {entry.owner ? entry.owner.charAt(0) : '?'}
                                        </div>
                                        <span className="text-sm font-medium text-graystone-900">{entry.owner}</span>
                                    </div>
                                </div>

                                {entry.collaborators && entry.collaborators.length > 0 && (
                                    <div>
                                        <div className="text-xs font-semibold text-graystone-500 uppercase tracking-wider mb-1">Collaborators</div>
                                        <div className="flex flex-col gap-2">
                                            {entry.collaborators.map(collab => (
                                                <div key={collab} className="flex items-center gap-2">
                                                    <div className="w-6 h-6 rounded-full bg-ocean-100 flex items-center justify-center text-xs font-bold text-ocean-600 border border-ocean-200">
                                                        {collab.charAt(0)}
                                                    </div>
                                                    <span className="text-sm font-medium text-graystone-900">{collab}</span>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                )}

                                <div>
                                    <div className="text-xs font-semibold text-graystone-500 uppercase tracking-wider mb-1">Timeline</div>
                                    <div className="flex items-center gap-2">
                                        <i data-lucide="calendar-clock" className="w-4 h-4 text-ocean-500"></i>
                                        <span className="text-sm font-medium text-graystone-900">
                                            {entry.timelineType === 'date' ? new Date(entry.timelineValue).toLocaleDateString() :
                                                entry.timelineType === 'quarter' ? entry.timelineValue :
                                                    entry.timelineType === 'month' ? entry.timelineValue :
                                                        entry.timelineType === 'year' ? entry.timelineValue :
                                                            entry.timelineValue || 'No date'}
                                        </span>
                                    </div>
                                </div>
                            </div>

                            {/* Tags */}
                            <div className="bg-white rounded-3xl p-6 border border-ocean-100 shadow-sm">
                                <h3 className="text-lg font-bold text-ocean-900 mb-3">Tags</h3>
                                <div className="flex flex-wrap gap-2">
                                    {entry.campaign && (
                                        <span className="px-2 py-1 rounded-md bg-purple-50 text-purple-700 text-xs font-medium border border-purple-100">
                                            {entry.campaign}
                                        </span>
                                    )}
                                    {entry.contentPillar && (
                                        <span className="px-2 py-1 rounded-md bg-blue-50 text-blue-700 text-xs font-medium border border-blue-100">
                                            {entry.contentPillar}
                                        </span>
                                    )}
                                    {entry.platforms && entry.platforms.map(p => (
                                        <span key={p} className="px-2 py-1 rounded-md bg-graystone-100 text-graystone-700 text-xs font-medium">
                                            {p}
                                        </span>
                                    ))}
                                </div>
                            </div>

                            {/* Custom Tags */}
                            {entry.tags && entry.tags.length > 0 && (
                                <div className="bg-white rounded-3xl p-6 border border-ocean-100 shadow-sm">
                                    <h3 className="text-lg font-bold text-ocean-900 mb-3">Custom Tags</h3>
                                    <div className="flex flex-wrap gap-2">
                                        {entry.tags.map((tag, i) => (
                                            <span key={i} className="px-2 py-1 rounded-md bg-yellow-50 text-yellow-700 text-xs font-medium border border-yellow-100">
                                                {tag}
                                            </span>
                                        ))}
                                    </div>
                                </div>
                            )}

                            {/* Analytics (if available) */}
                            {entry.analytics && (
                                <div className="bg-gradient-to-br from-ocean-900 to-ocean-800 rounded-3xl p-6 text-white shadow-lg">
                                    <h3 className="text-lg font-bold mb-4 flex items-center gap-2">
                                        <i data-lucide="bar-chart-2" className="w-5 h-5"></i>
                                        Analytics
                                    </h3>
                                    <div className="grid grid-cols-2 gap-4">
                                        <div className="bg-white/10 rounded-xl p-3 backdrop-blur-sm">
                                            <div className="text-xs text-ocean-200 mb-1">Views</div>
                                            <div className="text-xl font-bold">{entry.analytics.views || 0}</div>
                                        </div>
                                        <div className="bg-white/10 rounded-xl p-3 backdrop-blur-sm">
                                            <div className="text-xs text-ocean-200 mb-1">Clicks</div>
                                            <div className="text-xl font-bold">{entry.analytics.clicks || 0}</div>
                                        </div>
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>
                </div>

                {activeSubtask && (
                    <div className="fixed inset-0 flex items-center justify-center bg-black bg-opacity-30 z-50">
                        <div className="bg-white rounded-2xl p-6 w-full max-w-md shadow-xl animate-in fade-in zoom-in-95 duration-200">
                            <div className="flex items-center justify-between mb-3">
                                <h3 className="text-lg font-bold text-ocean-900">Subtask details</h3>
                                <button
                                    onClick={() => setActiveSubtask(null)}
                                    className="w-8 h-8 flex items-center justify-center rounded-full bg-ocean-500 hover:bg-ocean-600 transition-colors"
                                >
                                    <i data-lucide="x" className="w-5 h-5 text-white"></i>
                                </button>
                            </div>
                            <div className="space-y-3">
                                <div>
                                    <div className="text-xs font-semibold text-graystone-500 uppercase tracking-wider mb-1">Title</div>
                                    <div className="text-sm font-medium text-ocean-900">{activeSubtask.title}</div>
                                </div>
                                <div className="grid grid-cols-2 gap-3 text-sm">
                                    <div>
                                        <div className="text-xs font-semibold text-graystone-500 uppercase tracking-wider mb-1">Assignee</div>
                                        <div className="text-graystone-800">{activeSubtask.assignedTo || 'Unassigned'}</div>
                                    </div>
                                    <div>
                                        <div className="text-xs font-semibold text-graystone-500 uppercase tracking-wider mb-1">Deadline</div>
                                        <div className="text-graystone-800">{activeSubtask.deadline || 'None'}</div>
                                    </div>
                                </div>
                                <div>
                                    <div className="text-xs font-semibold text-graystone-500 uppercase tracking-wider mb-1">Context</div>
                                    <div className="text-sm text-graystone-700 whitespace-pre-line bg-graystone-50 border border-graystone-200 rounded-xl px-3 py-2">
                                        {activeSubtask.context || 'No additional context provided.'}
                                    </div>
                                </div>
                                <div className="flex items-center gap-2">
                                    <input type="checkbox" checked={!!activeSubtask.completed} readOnly className="w-4 h-4 rounded border-graystone-300" />
                                    <span className="text-sm text-graystone-700">{activeSubtask.completed ? 'Completed' : 'Open'}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                )}

                {descriptionModalOpen && (
                    <div className="fixed inset-0 flex items-center justify-center bg-black bg-opacity-30 z-50">
                        <div className="bg-white rounded-2xl p-6 w-full max-w-xl shadow-xl animate-in fade-in zoom-in-95 duration-200">
                            <div className="flex items-center justify-between mb-3">
                                <h3 className="text-lg font-bold text-ocean-900">Edit description</h3>
                                <button
                                    onClick={() => {
                                        setDescriptionDraft(getCaption());
                                        setDescriptionModalOpen(false);
                                    }}
                                    className="w-8 h-8 flex items-center justify-center rounded-full bg-ocean-500 hover:bg-ocean-600 transition-colors"
                                >
                                    <i data-lucide="x" className="w-5 h-5 text-white"></i>
                                </button>
                            </div>
                            <p className="text-sm text-graystone-600 mb-3">Keep this concise—the first few lines appear in the task preview.</p>
                            <textarea
                                value={descriptionDraft}
                                onChange={(e) => setDescriptionDraft(e.target.value)}
                                className="w-full rounded-xl border border-graystone-200 px-3 py-2 text-sm shadow-sm focus:border-ocean-500 focus:outline-none focus:ring-2 focus:ring-aqua-200"
                                rows="5"
                                placeholder="Add a short description..."
                            />
                            <div className="flex justify-end gap-3 mt-4">
                                <button
                                    onClick={() => {
                                        setDescriptionDraft(getCaption());
                                        setDescriptionModalOpen(false);
                                    }}
                                    className="px-4 py-2 text-sm font-medium text-graystone-600 hover:text-graystone-800 transition-colors"
                                >
                                    Cancel
                                </button>
                                <button
                                    onClick={handleDescriptionSave}
                                    className="px-4 py-2 bg-ocean-600 text-white text-sm font-medium rounded-lg hover:bg-ocean-700 transition-colors shadow-sm"
                                >
                                    Save
                                </button>
                            </div>
                        </div>
                    </div>
                )}

                {documentsModalOpen && (
                    <div className="fixed inset-0 flex items-center justify-center bg-black bg-opacity-30 z-50">
                        <div className="bg-white rounded-2xl p-6 w-full max-w-xl shadow-xl animate-in fade-in zoom-in-95 duration-200">
                            <div className="flex items-center justify-between mb-3">
                                <h3 className="text-lg font-bold text-ocean-900">Manage documents</h3>
                                <button
                                    onClick={() => {
                                        setDocumentsDraft(getDocuments());
                                        setNewDocInput("");
                                        setDocumentsModalOpen(false);
                                    }}
                                    className="w-8 h-8 flex items-center justify-center rounded-full bg-ocean-500 hover:bg-ocean-600 transition-colors"
                                >
                                    <i data-lucide="x" className="w-5 h-5 text-white"></i>
                                </button>
                            </div>
                            <p className="text-sm text-graystone-600 mb-3">Drop in SharePoint links or filenames so the team can find assets fast.</p>
                            <div className="flex flex-col gap-2 mb-4">
                                <div className="flex items-center gap-2">
                                    <input
                                        value={newDocInput}
                                        onChange={(e) => setNewDocInput(e.target.value)}
                                        onKeyDown={(e) => {
                                            if (e.key === 'Enter') {
                                                e.preventDefault();
                                                addDocumentDraft();
                                            }
                                        }}
                                        placeholder="Paste a SharePoint link or filename"
                                        className="flex-1 rounded-lg border border-graystone-200 px-3 py-2 text-sm shadow-sm focus:border-ocean-500 focus:outline-none focus:ring-2 focus:ring-aqua-200"
                                    />
                                    <button
                                        onClick={addDocumentDraft}
                                        className="px-4 py-2 bg-ocean-600 text-white text-sm font-medium rounded-lg hover:bg-ocean-700 transition-colors shadow-sm"
                                    >
                                        Add
                                    </button>
                                </div>
                                <div className="flex items-center gap-2">
                                    <input
                                        ref={fileInputRef}
                                        type="file"
                                        className="hidden"
                                        multiple
                                        onChange={handleFileSelect}
                                    />
                                    <button
                                        onClick={triggerUpload}
                                        className="px-4 py-2 bg-ocean-50 text-ocean-700 text-sm font-medium rounded-lg hover:bg-ocean-100 transition-colors border border-ocean-100"
                                    >
                                        Upload from device (SharePoint)
                                    </button>
                                    <span className="text-xs text-graystone-500">Files will sync to SharePoint once connected.</span>
                                </div>
                            </div>
                            <div className="space-y-2 max-h-60 overflow-y-auto">
                                {documentsDraft.length > 0 ? (
                                    documentsDraft.map((doc, index) => (
                                        <div
                                            key={`${doc}-${index}`}
                                            className="flex items-center justify-between rounded-xl border border-graystone-200 px-3 py-2 shadow-sm"
                                        >
                                            <div className="flex items-center gap-2 min-w-0">
                                                <i data-lucide="file-text" className="w-4 h-4 text-ocean-600"></i>
                                                <span className="text-sm text-graystone-800 truncate">{doc}</span>
                                            </div>
                                            <button
                                                onClick={() => removeDocumentDraft(index)}
                                                className="p-1 rounded-full hover:bg-graystone-100 transition-colors"
                                            >
                                                <i data-lucide="trash-2" className="w-4 h-4 text-rose-500"></i>
                                            </button>
                                        </div>
                                    ))
                                ) : (
                                    <div className="text-sm text-graystone-500 bg-graystone-50 border border-dashed border-graystone-200 rounded-xl px-3 py-4 text-center">
                                        Nothing attached yet
                                    </div>
                                )}
                            </div>
                            <div className="flex justify-end gap-3 mt-4">
                                <button
                                    onClick={() => {
                                        setDocumentsDraft(getDocuments());
                                        setNewDocInput("");
                                        setDocumentsModalOpen(false);
                                    }}
                                    className="px-4 py-2 text-sm font-medium text-graystone-600 hover:text-graystone-800 transition-colors"
                                >
                                    Cancel
                                </button>
                                <button
                                    onClick={handleDocumentsSave}
                                    className="px-4 py-2 bg-ocean-600 text-white text-sm font-medium rounded-lg hover:bg-ocean-700 transition-colors shadow-sm"
                                >
                                    Save
                                </button>
                            </div>
                        </div>
                    </div>
                )}
                </>
            );
        }

        function AddItemForm({ onSubmit, onBack, availableTags = [] }) {
            const [title, setTitle] = useState("");
            const [description, setDescription] = useState("");
            const [workflowStatus, setWorkflowStatus] = useState("Idea");
            const [team, setTeam] = useState(TEAMS[0]);
            const [owner, setOwner] = useState(USERS[0]);
            const [collaborators, setCollaborators] = useState([]);
            const [documents, setDocuments] = useState([]);
            const [tags, setTags] = useState([]);
            const [tagInput, setTagInput] = useState("");
            const [caption, setCaption] = useState("");
            const [startDate, setStartDate] = useState("");
            const [deadline, setDeadline] = useState("");

            // Timeline State
            const [timelineType, setTimelineType] = useState("date");
            const [dateValue, setDateValue] = useState(new Date().toISOString().slice(0, 10));
            const [monthValue, setMonthValue] = useState(new Date().toISOString().slice(0, 7));
            const [yearValue, setYearValue] = useState(String(new Date().getFullYear()));
            const [quarterValue, setQuarterValue] = useState(String(Math.floor(new Date().getMonth() / 3) + 1));
            const [formError, setFormError] = useState("");

            const handleSubmit = (e) => {
                e.preventDefault();
                setFormError("");

                if (!title.trim()) {
                    setFormError("Title is required");
                    return;
                }

                // Validate timeline fields
                if ((timelineType === "quarter" || timelineType === "year") && !yearValue) {
                    setFormError("Please enter a year for the timeline");
                    return;
                }

                let timelineValue = "";
                if (timelineType === "date") timelineValue = dateValue;
                else if (timelineType === "month") timelineValue = monthValue;
                else if (timelineType === "quarter") timelineValue = `${yearValue}-Q${quarterValue}`;
                else if (timelineType === "year") timelineValue = String(yearValue);

                onSubmit({
                    title,
                    team,
                    owner,
                    collaborators,
                    documents,
                    tags,
                    caption,
                    workflowStatus: "Idea",
                    startDate: startDate || undefined,
                    date: deadline || new Date().toISOString().slice(0, 10),
                    timelineType,
                    timelineValue,
                    status: "active"
                });
            };

            return (
                <div className="max-w-xl mx-auto animate-in fade-in slide-in-from-bottom-4 duration-500">
                    <div className="bg-white rounded-xl shadow-sm border border-ocean-100 p-8">
                        <div className="flex items-center justify-between mb-6">
                            <h2 className="text-2xl font-bold text-ocean-900">Add New Item</h2>
                            <Button variant="ghost" onClick={onBack} className="text-graystone-500 hover:text-ocean-600">
                                <i data-lucide="x" className="w-5 h-5"></i>
                            </Button>
                        </div>
                        <form onSubmit={handleSubmit} className="space-y-8">
                            {/* Form Error */}
                            {formError && (
                                <div className="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg text-sm">
                                    {formError}
                                </div>
                            )}

                            {/* Project Details Section */}
                            <div className="space-y-4">
                                <h3 className="text-lg font-bold text-ocean-900 flex items-center gap-2 border-b border-ocean-100 pb-2">
                                    <i data-lucide="file-text" className="w-5 h-5 text-ocean-500"></i>
                                    Project Details
                                </h3>
                                <div className="space-y-2">
                                    <label className="text-sm font-medium text-graystone-700">Title</label>
                                    <input
                                        value={title}
                                        onChange={e => setTitle(e.target.value)}
                                        className={inputBaseClasses}
                                        placeholder="e.g. Q4 Marketing Campaign"
                                        required
                                    />
                                </div>

                                <div className="grid grid-cols-2 gap-4">
                                    <div className="space-y-2">
                                        <label className="text-sm font-medium text-graystone-700">Team</label>
                                        <select
                                            value={team}
                                            onChange={e => setTeam(e.target.value)}
                                            className={cx(selectBaseClasses, "w-full")}
                                        >
                                            {TEAMS.map(t => <option key={t} value={t}>{t}</option>)}
                                        </select>
                                    </div>
                                    <div className="space-y-2">
                                        <label className="text-sm font-medium text-graystone-700">Owner</label>
                                        <select
                                            value={owner}
                                            onChange={e => setOwner(e.target.value)}
                                            className={cx(selectBaseClasses, "w-full")}
                                        >
                                            {USERS.map(u => <option key={u} value={u}>{u}</option>)}
                                        </select>
                                    </div>
                                </div>
                            </div>

                            {/* Collaboration Section */}
                            <div className="space-y-4">
                                <h3 className="text-lg font-bold text-ocean-900 flex items-center gap-2 border-b border-ocean-100 pb-2">
                                    <i data-lucide="users" className="w-5 h-5 text-ocean-500"></i>
                                    Collaboration
                                </h3>
                                <div className="space-y-2">
                                    <div className="space-y-2">
                                        <label className="text-sm font-medium text-graystone-700">Collaborators</label>
                                        <div className="flex flex-wrap gap-2">
                                            {USERS.map(user => {
                                                const isSelected = collaborators.includes(user);
                                                return (
                                                    <button
                                                        key={user}
                                                        type="button"
                                                        onClick={() => {
                                                            if (isSelected) {
                                                                setCollaborators(collaborators.filter(c => c !== user));
                                                            } else {
                                                                setCollaborators([...collaborators, user]);
                                                            }
                                                        }}
                                                        className={cx(
                                                            "px-3 py-1.5 rounded-full text-xs font-medium transition-all border",
                                                            isSelected
                                                                ? "bg-ocean-100 text-ocean-700 border-ocean-200"
                                                                : "bg-white text-graystone-600 border-graystone-200 hover:border-ocean-300"
                                                        )}
                                                    >
                                                        {isSelected && <span className="mr-1">✓</span>}
                                                        {user}
                                                    </button>
                                                );
                                            })}
                                        </div>
                                        <div className="mt-2">
                                            <label className="text-xs font-medium text-graystone-500 mb-1 block">Teams</label>
                                            <div className="flex flex-wrap gap-2">
                                                {TEAMS.map(team => {
                                                    const isSelected = collaborators.includes(team);
                                                    return (
                                                        <button
                                                            key={team}
                                                            type="button"
                                                            onClick={() => {
                                                                if (isSelected) {
                                                                    setCollaborators(collaborators.filter(c => c !== team));
                                                                } else {
                                                                    setCollaborators([...collaborators, team]);
                                                                }
                                                            }}
                                                            className={cx(
                                                                "px-3 py-1.5 rounded-full text-xs font-medium transition-all border",
                                                                isSelected
                                                                    ? "bg-purple-100 text-purple-700 border-purple-200"
                                                                    : "bg-white text-graystone-600 border-graystone-200 hover:border-purple-300"
                                                            )}
                                                        >
                                                            {isSelected && <span className="mr-1">✓</span>}
                                                            {team}
                                                        </button>
                                                    );
                                                })}
                                            </div>
                                        </div>
                                    </div>

                                    <div className="space-y-2">
                                        <label className="text-sm font-medium text-graystone-700">Tags</label>
                                        <div className="flex gap-2">
                                            <input
                                                type="text"
                                                className="flex-1 rounded-lg border-graystone-300 shadow-sm focus:border-ocean-500 focus:ring-ocean-500 text-sm"
                                                placeholder="Add a tag and press Enter..."
                                                value={tagInput}
                                                onChange={(e) => setTagInput(e.target.value)}
                                                onKeyDown={(e) => {
                                                    if (e.key === 'Enter') {
                                                        e.preventDefault();
                                                        if (tagInput.trim()) {
                                                            setTags([...tags, tagInput.trim()]);
                                                            setTagInput("");
                                                        }
                                                    }
                                                }}
                                                list="tag-suggestions"
                                            />
                                            <datalist id="tag-suggestions">
                                                {availableTags.map(tag => (
                                                    <option key={tag} value={tag} />
                                                ))}
                                            </datalist>
                                            <Button
                                                type="button"
                                                onClick={() => {
                                                    if (tagInput.trim()) {
                                                        setTags([...tags, tagInput.trim()]);
                                                        setTagInput("");
                                                    }
                                                }}
                                            >
                                                Add
                                            </Button>
                                        </div>
                                        {tags.length > 0 && (
                                            <div className="flex flex-wrap gap-2 mt-2">
                                                {tags.map((tag, i) => (
                                                    <span key={i} className="inline-flex items-center gap-1 px-2 py-1 rounded-md bg-graystone-100 text-graystone-700 text-xs font-medium">
                                                        {tag}
                                                        <button
                                                            type="button"
                                                            onClick={() => setTags(tags.filter((_, index) => index !== i))}
                                                            className="text-graystone-400 hover:text-red-500"
                                                        >
                                                            ×
                                                        </button>
                                                    </span>
                                                ))}
                                            </div>
                                        )}
                                    </div>
                                </div>
                            </div>

                            {/* Timeline Section */}
                            <div className="space-y-4">
                                <h3 className="text-lg font-bold text-ocean-900 flex items-center gap-2 border-b border-ocean-100 pb-2">
                                    <i data-lucide="calendar" className="w-5 h-5 text-ocean-500"></i>
                                    Timeline
                                </h3>

                                {/* Start Date and Deadline */}
                                <div className="grid grid-cols-2 gap-4">
                                    <div className="space-y-2">
                                        <label className="text-sm font-medium text-graystone-700">Start Date (Optional)</label>
                                        <input
                                            type="date"
                                            value={startDate}
                                            onChange={e => setStartDate(e.target.value)}
                                            className={inputBaseClasses}
                                        />
                                    </div>
                                    <div className="space-y-2">
                                        <label className="text-sm font-medium text-graystone-700">Deadline (Optional)</label>
                                        <input
                                            type="date"
                                            value={deadline}
                                            onChange={e => setDeadline(e.target.value)}
                                            min={startDate || undefined}
                                            className={inputBaseClasses}
                                        />
                                        {startDate && deadline && new Date(deadline) < new Date(startDate) && (
                                            <p className="text-xs text-red-500 mt-1">Deadline must be after start date</p>
                                        )}
                                    </div>
                                </div>

                                <div className="p-4 bg-ocean-50 rounded-xl space-y-4 border border-ocean-100">
                                    <div className="space-y-2">
                                        <label className="text-sm font-medium text-ocean-900">Timeline Precision</label>
                                        <div className="flex gap-2">
                                            {TIMELINE_TYPES.map(type => (
                                                <button
                                                    key={type.value}
                                                    type="button"
                                                    onClick={() => setTimelineType(type.value)}
                                                    className={cx(
                                                        "flex-1 py-1.5 text-xs rounded-lg border transition-all",
                                                        timelineType === type.value
                                                            ? "bg-white border-ocean-300 text-ocean-900 shadow-sm font-semibold"
                                                            : "border-transparent text-ocean-600 hover:bg-white/50"
                                                    )}
                                                >
                                                    {type.label}
                                                </button>
                                            ))}
                                        </div>
                                    </div>

                                    <div className="space-y-2">
                                        <label className="text-sm font-medium text-ocean-900">
                                            {TIMELINE_TYPES.find(t => t.value === timelineType)?.label} Value
                                        </label>

                                        {timelineType === "date" && (
                                            <input
                                                type="date"
                                                value={dateValue}
                                                onChange={e => setDateValue(e.target.value)}
                                                className={inputBaseClasses}
                                            />
                                        )}

                                        {timelineType === "month" && (
                                            <input
                                                type="month"
                                                value={monthValue}
                                                onChange={e => setMonthValue(e.target.value)}
                                                className={inputBaseClasses}
                                            />
                                        )}

                                        {timelineType === "quarter" && (
                                            <div className="flex gap-2">
                                                <input
                                                    type="number"
                                                    value={yearValue}
                                                    onChange={e => setYearValue(e.target.value)}
                                                    className={inputBaseClasses}
                                                    placeholder="Year"
                                                />
                                                <select
                                                    value={quarterValue}
                                                    onChange={e => setQuarterValue(e.target.value)}
                                                    className={cx(selectBaseClasses, "w-full")}
                                                >
                                                    {[1, 2, 3, 4].map(q => <option key={q} value={q}>Q{q}</option>)}
                                                </select>
                                            </div>
                                        )}

                                        {timelineType === "year" && (
                                            <input
                                                type="number"
                                                value={yearValue}
                                                onChange={e => setYearValue(e.target.value)}
                                                className={inputBaseClasses}
                                                placeholder="Year"
                                            />
                                        )}
                                    </div>
                                </div>
                            </div>

                            {/* Attachments Section */}
                            <div className="space-y-4">
                                <h3 className="text-lg font-bold text-ocean-900 flex items-center gap-2 border-b border-ocean-100 pb-2">
                                    <i data-lucide="paperclip" className="w-5 h-5 text-ocean-500"></i>
                                    Attachments
                                </h3>
                                <div className="space-y-2">
                                    <label className="text-sm font-medium text-graystone-700">Relevant Documents</label>
                                    <div className="border-2 border-dashed border-graystone-200 rounded-xl p-6 text-center hover:bg-graystone-50 transition-colors">
                                        <input
                                            type="file"
                                            multiple
                                            onChange={e => setDocuments(Array.from(e.target.files).map(f => f.name))}
                                            className="hidden"
                                            id="file-upload"
                                        />
                                        <label htmlFor="file-upload" className="cursor-pointer flex flex-col items-center gap-2">
                                            <div className="bg-ocean-50 p-3 rounded-full">
                                                <i data-lucide="upload-cloud" className="w-6 h-6 text-ocean-600"></i>
                                            </div>
                                            <span className="text-sm font-medium text-ocean-700">Click to upload documents</span>
                                            <span className="text-xs text-graystone-500">SharePoint Integration</span>
                                        </label>
                                        {documents.length > 0 && (
                                            <div className="mt-4 flex flex-wrap gap-2 justify-center">
                                                {documents.map((doc, i) => (
                                                    <span key={i} className="inline-flex items-center gap-1 text-xs bg-white border border-graystone-200 px-2 py-1 rounded-md text-graystone-700">
                                                        <i data-lucide="file" className="w-3 h-3"></i>
                                                        {doc}
                                                    </span>
                                                ))}
                                            </div>
                                        )}
                                    </div>
                                </div>
                            </div>

                            {/* Description Section */}
                            <div className="space-y-4">
                                <h3 className="text-lg font-bold text-ocean-900 flex items-center gap-2 border-b border-ocean-100 pb-2">
                                    <i data-lucide="align-left" className="w-5 h-5 text-ocean-500"></i>
                                    Description
                                </h3>
                                <div className="space-y-2">
                                    <label className="text-sm font-medium text-graystone-700">Description / Caption</label>
                                    <textarea
                                        value={caption}
                                        onChange={e => setCaption(e.target.value)}
                                        className={cx(inputBaseClasses, "min-h-[100px]")}
                                        placeholder="Brief description of the task..."
                                    />
                                </div>
                            </div>

                            <div className="pt-4 flex gap-3">
                                <Button type="submit" variant="solid" className="flex-1">Create Item</Button>
                                <Button type="button" variant="ghost" onClick={onBack}>Cancel</Button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        }

        function CalendarScreen({ entries, onBack, openSubtaskModal, onOpen, isEmbedded = false }) {
            const [timelineType, setTimelineType] = useState('quarter'); // 'date', 'week', 'month', 'quarter', 'year'
            const [viewMode, setViewMode] = useState('board'); // 'board', 'timeline'
            const [selectedMonth, setSelectedMonth] = useState(new Date()); // For week view

            const TIMELINE_TYPES = {
                'date': { label: 'By Date', options: [] }, // Dynamic
                'week': { label: 'By Week', options: [] }, // Dynamic based on month
                'month': { label: 'By Month', options: ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'] },
                'quarter': { label: 'By Quarter', options: ['Q1', 'Q2', 'Q3', 'Q4'] },
                'year': { label: 'By Year', options: ['2024', '2025', '2026'] }
            };

            const getWeeksInMonth = (date) => {
                const year = date.getFullYear();
                const month = date.getMonth();
                const firstDay = new Date(year, month, 1);
                const lastDay = new Date(year, month + 1, 0);

                const weeks = [];
                let currentDate = new Date(firstDay);

                // Start from the first Monday of or before the month
                currentDate.setDate(currentDate.getDate() - currentDate.getDay() + (currentDate.getDay() === 0 ? -6 : 1));

                while (currentDate <= lastDay || currentDate.getMonth() === month) {
                    const weekStart = new Date(currentDate);
                    const weekLabel = `Week commencing ${weekStart.getDate()} ${weekStart.toLocaleString('default', { month: 'short' })}`;
                    const weekValue = weekStart.toISOString().slice(0, 10);
                    weeks.push({ label: weekLabel, value: weekValue });

                    currentDate.setDate(currentDate.getDate() + 7);

                    // Stop if we've gone past the month
                    if (currentDate.getMonth() > month && weeks.length > 0) break;
                }

                return weeks;
            };

            const getColumns = () => {
                if (timelineType === 'week') {
                    const weeks = getWeeksInMonth(selectedMonth);
                    return weeks.map(w => w.label);
                }
                return TIMELINE_TYPES[timelineType].options;
            };

            const renderBoardView = () => {
                const weeks = timelineType === 'week' ? getWeeksInMonth(selectedMonth) : [];

                return (
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 overflow-x-auto pb-4">
                        {getColumns().map((column, idx) => {
                            let columnEntries;

                            if (timelineType === 'week') {
                                // For weeks, match based on the week start date
                                const weekData = weeks[idx];
                                columnEntries = entries.filter(e => {
                                    if (e.timelineType !== 'week') return false;
                                    // Check if entry's timelineValue falls within this week
                                    const entryDate = new Date(e.timelineValue);
                                    const weekStart = new Date(weekData.value);
                                    const weekEnd = new Date(weekStart);
                                    weekEnd.setDate(weekEnd.getDate() + 7);
                                    return entryDate >= weekStart && entryDate < weekEnd;
                                });
                            } else {
                                columnEntries = entries.filter(e =>
                                    e.timelineType === timelineType && e.timelineValue === column
                                );
                            }

                            return (
                                <div key={column} className="min-w-[300px] bg-graystone-50 rounded-xl p-4 border border-graystone-200 flex flex-col h-full max-h-[calc(100vh-12rem)]">
                                    <div className="flex items-center justify-between mb-4 sticky top-0 bg-graystone-50 z-10 pb-2 border-b border-graystone-200">
                                        <h3 className="font-bold text-ocean-900">{column}</h3>
                                        <Badge variant="neutral">{columnEntries.length}</Badge>
                                    </div>
                                    <div className="space-y-3 overflow-y-auto flex-1 pr-2">
                                        {columnEntries.map(entry => (
                                            <div key={entry.id} className="bg-white p-3 rounded-lg border border-graystone-200 shadow-sm hover:shadow-md transition-shadow cursor-pointer group">
                                                <div className="flex items-start justify-between mb-2">
                                                    <div className="flex items-start gap-2">
                                                        <h4 className="font-medium text-ocean-900 group-hover:text-ocean-700 heading-font">{entry.title}</h4>
                                                        {onOpen && (
                                                            <button
                                                                onClick={(e) => { e.stopPropagation(); onOpen(entry.id); }}
                                                                className="p-1.5 rounded-full hover:bg-ocean-50 transition-colors"
                                                                title="Open"
                                                            >
                                                                <i data-lucide="external-link" className="w-4 h-4 text-ocean-700"></i>
                                                            </button>
                                                        )}
                                                    </div>
                                                    <Badge variant={entry.workflowStatus === 'Done' ? 'success' : 'default'} className="text-[10px]">
                                                        {entry.workflowStatus}
                                                    </Badge>
                                                </div>
                                                <div className="flex items-center justify-between text-xs text-graystone-500">
                                                    <span>{entry.owner}</span>
                                                    {entry.team && <span className="bg-graystone-100 px-1.5 py-0.5 rounded">{entry.team}</span>}
                                                </div>
                                                <div className="mt-3 pt-3 border-t border-graystone-100 flex justify-end">
                                                    <button
                                                        onClick={(e) => {
                                                            e.stopPropagation();
                                                            openSubtaskModal(entry.id);
                                                        }}
                                                        className="text-xs text-ocean-600 hover:text-ocean-800 flex items-center gap-1"
                                                    >
                                                        <i data-lucide="plus" className="w-3 h-3"></i>
                                                        Add Subtask
                                                    </button>
                                                </div>
                                            </div>
                                        ))}
                                        {columnEntries.length === 0 && (
                                            <div className="text-center py-8 text-graystone-400 text-sm border-2 border-dashed border-graystone-200 rounded-lg">
                                                No items
                                            </div>
                                        )}
                                    </div>
                                </div>
                            );
                        })}


                    </div>
                );
            };

            const renderTimelineView = () => {
                const columns = getColumns();
                return (
                    <div className="bg-white rounded-xl border border-graystone-200 shadow-sm overflow-hidden">
                        <div className="overflow-x-auto">
                            <table className="w-full min-w-[800px]">
                                <thead>
                                    <tr className="bg-graystone-50 border-b border-graystone-200">
                                        <th className="px-4 py-3 text-left text-xs font-bold text-ocean-900 uppercase tracking-wider w-64 sticky left-0 bg-graystone-50 z-20 border-r border-graystone-200">Item</th>
                                        {columns.map(col => (
                                            <th key={col} className="px-4 py-3 text-center text-xs font-bold text-ocean-900 uppercase tracking-wider min-w-[100px] border-r border-graystone-100 last:border-r-0">
                                                {col}
                                            </th>
                                        ))}
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-graystone-100">
                                    {entries.filter(e => e.timelineType === timelineType).map(entry => (
                                        <tr key={entry.id} className="hover:bg-ocean-50/50 transition-colors">
                                            <td className="px-4 py-3 sticky left-0 bg-white z-10 border-r border-graystone-200">
                                                <div className="flex items-center gap-2">
                                                    <div className="font-medium text-sm text-ocean-900 heading-font">{entry.title}</div>
                                                    <i data-lucide="external-link" className="w-4 h-4 text-graystone-300"></i>
                                                </div>
                                                <div className="text-xs text-graystone-500 flex items-center gap-2 mt-1">
                                                    <span>{entry.owner}</span>
                                                    <Badge variant="neutral" className="text-[10px] py-0">{entry.workflowStatus}</Badge>
                                                </div>
                                            </td>
                                            {columns.map(col => {
                                                const isMatch = entry.timelineValue === col;
                                                return (
                                                    <td key={col} className="px-2 py-3 border-r border-graystone-100 last:border-r-0 relative">
                                                        {isMatch && (
                                                            <div className="bg-ocean-100 text-ocean-700 text-xs font-medium px-2 py-1 rounded-md text-center border border-ocean-200 shadow-sm whitespace-nowrap overflow-hidden text-ellipsis">
                                                                {entry.workflowStatus}
                                                            </div>
                                                        )}
                                                    </td>
                                                );
                                            })}
                                        </tr>
                                    ))}
                                    {entries.filter(e => e.timelineType === timelineType).length === 0 && (
                                        <tr>
                                            <td colSpan={columns.length + 1} className="px-4 py-8 text-center text-graystone-400 text-sm">
                                                No items found for this timeline type.
                                            </td>
                                        </tr>
                                    )}
                                </tbody>
                            </table>
                        </div>
                    </div>
                );
            };

            return (
                <div className="h-full flex flex-col">
                    {/* Header - hidden when embedded */}
                    {!isEmbedded && (
                        <div className="bg-gradient-to-r from-ocean-500 to-ocean-600 rounded-2xl p-8 text-white shadow-xl flex items-center justify-between mb-6">
                            <div>
                                <h1 className="text-3xl font-bold mb-2">Project Calendar</h1>
                                <p className="text-ocean-100">Visualize workflows across time</p>
                            </div>
                            <div className="flex items-center gap-4">
                                {/* View Mode Toggle */}
                                <div className="bg-black/20 p-1 rounded-lg border border-white/10 flex items-center">
                                    <button
                                        onClick={() => setViewMode('board')}
                                        className={cx(
                                            "px-3 py-1.5 rounded-md text-sm font-medium transition-all flex items-center gap-2",
                                            viewMode === 'board' ? "bg-white text-ocean-700 shadow-sm" : "text-white/80 hover:text-white hover:bg-white/10"
                                        )}
                                    >
                                        <i data-lucide="layout-grid" className="w-4 h-4"></i>
                                        Board
                                    </button>
                                    <button
                                        onClick={() => setViewMode('timeline')}
                                        className={cx(
                                            "px-3 py-1.5 rounded-md text-sm font-medium transition-all flex items-center gap-2",
                                            viewMode === 'timeline' ? "bg-white text-ocean-700 shadow-sm" : "text-white/80 hover:text-white hover:bg-white/10"
                                        )}
                                    >
                                        <i data-lucide="gantt-chart" className="w-4 h-4"></i>
                                        Timeline
                                    </button>
                                </div>
                                <Button variant="ghost" onClick={onBack} className="text-white hover:bg-white/20 hover:text-white">
                                    <i data-lucide="arrow-left" className="w-4 h-4 mr-2"></i>
                                    Back to Menu
                                </Button>
                            </div>
                        </div>
                    )}

                    <div className="bg-white rounded-xl border border-ocean-100 shadow-sm p-6 flex-1 flex flex-col">

                        {/* Timeline Type Selector */}
                        <div className="flex gap-2 mb-6 overflow-x-auto pb-2">
                            {Object.entries(TIMELINE_TYPES).map(([type, { label }]) => (
                                <button
                                    key={type}
                                    onClick={() => setTimelineType(type)}
                                    className={cx(
                                        "px-4 py-2 rounded-full text-sm font-medium transition-all whitespace-nowrap",
                                        timelineType === type
                                            ? "bg-ocean-600 text-white shadow-md"
                                            : "bg-white text-graystone-600 border border-graystone-200 hover:border-ocean-300 hover:text-ocean-700"
                                    )}
                                >
                                    {label}
                                </button>
                            ))}
                        </div>

                        {/* Month Navigation for Week View */}
                        {timelineType === 'week' && (
                            <div className="flex items-center justify-center gap-4 mb-6 bg-white p-4 rounded-xl shadow-sm border border-ocean-100">
                                <label className="text-sm font-medium text-graystone-700">Select Month:</label>
                                <select
                                    value={`${selectedMonth.getFullYear()}-${String(selectedMonth.getMonth() + 1).padStart(2, '0')}`}
                                    onChange={(e) => {
                                        const [year, month] = e.target.value.split('-');
                                        setSelectedMonth(new Date(parseInt(year), parseInt(month) - 1, 1));
                                    }}
                                    className={cx(selectBaseClasses, "min-w-[200px]")}
                                >
                                    {Array.from({ length: 24 }, (_, i) => {
                                        const date = new Date();
                                        date.setMonth(date.getMonth() - 12 + i);
                                        const year = date.getFullYear();
                                        const month = date.getMonth();
                                        const value = `${year}-${String(month + 1).padStart(2, '0')}`;
                                        const label = date.toLocaleString('default', { month: 'long', year: 'numeric' });
                                        return <option key={value} value={value}>{label}</option>;
                                    })}
                                </select>
                            </div>
                        )}

                        {viewMode === 'board' ? renderBoardView() : renderTimelineView()}
                    </div>
                </div>
            );
        }

        // View Switcher Component
        // FilterBar Component
        function FilterBar({
            title,
            subtitle,
            searchQuery,
            setSearchQuery,
            filterTags,
            setFilterTags,
            filterUsers,
            setFilterUsers,
            filterTeams,
            setFilterTeams,
            availableTags,
            viewMode,
            setViewMode
        }) {
            const [showFilters, setShowFilters] = useState(false);
            const [showTags, setShowTags] = useState(false);
            const [showViewMenu, setShowViewMenu] = useState(false);

            const toggleFilter = (item, currentList, setList) => {
                if (currentList.includes(item)) {
                    setList(currentList.filter(i => i !== item));
                } else {
                    setList([...currentList, item]);
                }
            };

            const activeFiltersCount = filterUsers.length + filterTeams.length;
            const activeTagsCount = filterTags.length;

            return (
                <div className="bg-gradient-to-r from-ocean-500 to-ocean-600 rounded-2xl p-6 text-white shadow-xl mb-6">
                    <div className="flex flex-col lg:flex-row lg:items-center justify-between gap-4">
                        <div>
                            <h1 className="text-2xl font-bold mb-1">{title}</h1>
                            <p className="text-ocean-100 text-sm">{subtitle}</p>
                        </div>

                        <div className="flex flex-wrap items-center gap-3">
                            {/* Search */}
                            <div className="relative group">
                                <i data-lucide="search" className="w-4 h-4 absolute left-3 top-1/2 -translate-y-1/2 text-ocean-200 group-focus-within:text-ocean-600 transition-colors"></i>
                                <input
                                    type="text"
                                    placeholder="Search..."
                                    value={searchQuery}
                                    onChange={(e) => setSearchQuery(e.target.value)}
                                    className="pl-9 pr-4 py-2 bg-black/20 border border-white/10 rounded-lg text-sm text-white placeholder-ocean-200 focus:outline-none focus:bg-white focus:text-ocean-900 focus:placeholder-graystone-400 transition-all w-48 focus:w-64"
                                />
                            </div>

                            {/* Filters Dropdown */}
                            <div className="relative">
                                <button
                                    onClick={() => { setShowFilters(!showFilters); setShowTags(false); setShowViewMenu(false); }}
                                    className={cx(
                                        "px-3 py-2 rounded-lg text-sm font-medium transition-all flex items-center gap-2 border",
                                        showFilters || activeFiltersCount > 0
                                            ? "bg-white text-ocean-700 border-white shadow-sm"
                                            : "bg-black/20 text-white border-white/10 hover:bg-white/10"
                                    )}
                                >
                                    <i data-lucide="filter" className="w-4 h-4"></i>
                                    Filters
                                    {activeFiltersCount > 0 && (
                                        <span className="bg-ocean-600 text-white text-[10px] px-1.5 py-0.5 rounded-full ml-1">
                                            {activeFiltersCount}
                                        </span>
                                    )}
                                </button>

                                {showFilters && (
                                    <div className="absolute top-full right-0 mt-2 w-64 bg-white rounded-xl shadow-xl border border-ocean-100 p-4 z-50 animate-in fade-in zoom-in-95 duration-200">
                                        <div className="space-y-4">
                                            <div>
                                                <h4 className="text-xs font-bold text-graystone-500 uppercase mb-2">Teams</h4>
                                                <div className="space-y-1">
                                                    {TEAMS.map(team => (
                                                        <label key={team} className="flex items-center gap-2 p-1.5 hover:bg-ocean-50 rounded cursor-pointer">
                                                            <input
                                                                type="checkbox"
                                                                checked={filterTeams.includes(team)}
                                                                onChange={() => toggleFilter(team, filterTeams, setFilterTeams)}
                                                                className="rounded border-graystone-300 text-ocean-600 focus:ring-ocean-500"
                                                            />
                                                            <span className="text-sm text-ocean-900">{team}</span>
                                                        </label>
                                                    ))}
                                                </div>
                                            </div>
                                            <div className="border-t border-ocean-50 pt-3">
                                                <h4 className="text-xs font-bold text-graystone-500 uppercase mb-2">Users</h4>
                                                <div className="space-y-1 max-h-40 overflow-y-auto">
                                                    {USERS.map(user => (
                                                        <label key={user} className="flex items-center gap-2 p-1.5 hover:bg-ocean-50 rounded cursor-pointer">
                                                            <input
                                                                type="checkbox"
                                                                checked={filterUsers.includes(user)}
                                                                onChange={() => toggleFilter(user, filterUsers, setFilterUsers)}
                                                                className="rounded border-graystone-300 text-ocean-600 focus:ring-ocean-500"
                                                            />
                                                            <span className="text-sm text-ocean-900">{user}</span>
                                                        </label>
                                                    ))}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                )}
                            </div>

                            {/* Tags Dropdown */}
                            <div className="relative">
                                <button
                                    onClick={() => { setShowTags(!showTags); setShowFilters(false); setShowViewMenu(false); }}
                                    className={cx(
                                        "px-3 py-2 rounded-lg text-sm font-medium transition-all flex items-center gap-2 border",
                                        showTags || activeTagsCount > 0
                                            ? "bg-white text-ocean-700 border-white shadow-sm"
                                            : "bg-black/20 text-white border-white/10 hover:bg-white/10"
                                    )}
                                >
                                    <i data-lucide="tag" className="w-4 h-4"></i>
                                    Tags
                                    {activeTagsCount > 0 && (
                                        <span className="bg-ocean-600 text-white text-[10px] px-1.5 py-0.5 rounded-full ml-1">
                                            {activeTagsCount}
                                        </span>
                                    )}
                                </button>

                                {showTags && (
                                    <div className="absolute top-full right-0 mt-2 w-56 bg-white rounded-xl shadow-xl border border-ocean-100 p-4 z-50 animate-in fade-in zoom-in-95 duration-200">
                                        <h4 className="text-xs font-bold text-graystone-500 uppercase mb-2">Filter by Tags</h4>
                                        <div className="space-y-1 max-h-60 overflow-y-auto">
                                            {availableTags.map(tag => (
                                                <label key={tag} className="flex items-center gap-2 p-1.5 hover:bg-ocean-50 rounded cursor-pointer">
                                                    <input
                                                        type="checkbox"
                                                        checked={filterTags.includes(tag)}
                                                        onChange={() => toggleFilter(tag, filterTags, setFilterTags)}
                                                        className="rounded border-graystone-300 text-ocean-600 focus:ring-ocean-500"
                                                    />
                                                    <span className="text-sm text-ocean-900">{tag}</span>
                                                </label>
                                            ))}
                                            {availableTags.length === 0 && (
                                                <p className="text-xs text-graystone-400 italic p-2">No tags available</p>
                                            )}
                                        </div>
                                    </div>
                                )}
                            </div>

                            {/* View Switcher Dropdown */}
                            <div className="relative">
                                <button
                                    onClick={() => { setShowViewMenu(!showViewMenu); setShowFilters(false); setShowTags(false); }}
                                    className="px-3 py-2 rounded-lg text-sm font-medium transition-all flex items-center gap-2 border bg-black/20 text-white border-white/10 hover:bg-white/10"
                                >
                                    <i data-lucide={
                                        viewMode === 'kanban' ? 'kanban' :
                                            viewMode === 'table' ? 'table' :
                                                viewMode === 'list' ? 'list' :
                                                    viewMode === 'gantt' ? 'bar-chart-2' : 'layout-grid'
                                    } className="w-4 h-4"></i>
                                    <span className="capitalize">Project view</span>
                                    <span className="text-[11px] text-white/80 px-2 py-0.5 rounded-full bg-white/10">
                                        {viewMode === 'kanban' ? 'Board' : viewMode}
                                    </span>
                                    <i data-lucide="chevron-down" className="w-3 h-3 ml-1 opacity-70"></i>
                                </button>

                                {showViewMenu && (
                                    <div className="absolute top-full right-0 mt-2 w-40 bg-white rounded-xl shadow-xl border border-ocean-100 p-1 z-50 animate-in fade-in zoom-in-95 duration-200">
                                        {[
                                            { id: 'kanban', label: 'Board', icon: 'kanban' },
                                            { id: 'table', label: 'Table', icon: 'table' },
                                            { id: 'list', label: 'List', icon: 'list' },
                                            { id: 'gantt', label: 'Gantt', icon: 'bar-chart-2' },
                                            { id: 'calendar', label: 'Calendar', icon: 'calendar' }
                                        ].map(view => (
                                            <button
                                                key={view.id}
                                                onClick={() => { setViewMode(view.id); setShowViewMenu(false); }}
                                                className={cx(
                                                    "w-full text-left px-3 py-2 rounded-lg text-sm font-medium transition-colors flex items-center gap-2",
                                                    viewMode === view.id
                                                        ? "bg-ocean-50 text-ocean-700"
                                                        : "text-graystone-600 hover:bg-graystone-50 hover:text-ocean-900"
                                                )}
                                            >
                                                <i data-lucide={view.icon} className="w-4 h-4"></i>
                                                {view.label}
                                            </button>
                                        ))}
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>

                    {/* Active Filters Chips */}
                    {
                        (activeFiltersCount > 0 || activeTagsCount > 0) && (
                            <div className="flex flex-wrap gap-2 mt-4 pt-4 border-t border-white/10">
                                {filterTeams.map(team => (
                                    <button
                                        key={`team-${team}`}
                                        onClick={() => toggleFilter(team, filterTeams, setFilterTeams)}
                                        className="flex items-center gap-1.5 px-2.5 py-1 rounded-full bg-white/20 hover:bg-white/30 text-white text-xs font-medium transition-colors border border-white/10"
                                    >
                                        <span>{team}</span>
                                        <i data-lucide="x" className="w-3 h-3 opacity-70 hover:opacity-100"></i>
                                    </button>
                                ))}
                                {filterUsers.map(user => (
                                    <button
                                        key={`user-${user}`}
                                        onClick={() => toggleFilter(user, filterUsers, setFilterUsers)}
                                        className="flex items-center gap-1.5 px-2.5 py-1 rounded-full bg-white/20 hover:bg-white/30 text-white text-xs font-medium transition-colors border border-white/10"
                                    >
                                        <span>{user}</span>
                                        <i data-lucide="x" className="w-3 h-3 opacity-70 hover:opacity-100"></i>
                                    </button>
                                ))}
                                {filterTags.map(tag => (
                                    <button
                                        key={`tag-${tag}`}
                                        onClick={() => toggleFilter(tag, filterTags, setFilterTags)}
                                        className="flex items-center gap-1.5 px-2.5 py-1 rounded-full bg-white/20 hover:bg-white/30 text-white text-xs font-medium transition-colors border border-white/10"
                                    >
                                        <i data-lucide="tag" className="w-3 h-3 opacity-70"></i>
                                        <span>{tag}</span>
                                        <i data-lucide="x" className="w-3 h-3 opacity-70 hover:opacity-100"></i>
                                    </button>
                                ))}
                            </div>
                        )
                    }
                </div >
            );
        }

        // View Switcher Component
        function ViewSwitcher({ currentView, onViewChange, variant = 'light' }) {
            const containerClass = variant === 'dark'
                ? "flex bg-black/20 p-1 rounded-lg border border-white/10"
                : "flex bg-graystone-100 p-1 rounded-lg";

            const activeClass = variant === 'dark'
                ? "bg-white text-ocean-700 shadow-sm"
                : "bg-white text-ocean-700 shadow-sm";

            const inactiveClass = variant === 'dark'
                ? "text-white/80 hover:text-white hover:bg-white/10"
                : "text-graystone-600 hover:text-ocean-700";

            return (
                <div className={containerClass}>
                    <button
                        onClick={() => onViewChange('kanban')}
                        className={cx(
                            "px-3 py-1.5 rounded-md text-sm font-medium transition-all flex items-center gap-2",
                            currentView === 'kanban' ? activeClass : inactiveClass
                        )}
                    >
                        <i data-lucide="kanban" className="w-4 h-4"></i>
                        Board
                    </button>
                    <button
                        onClick={() => onViewChange('table')}
                        className={cx(
                            "px-3 py-1.5 rounded-md text-sm font-medium transition-all flex items-center gap-2",
                            currentView === 'table' ? activeClass : inactiveClass
                        )}
                    >
                        <i data-lucide="table" className="w-4 h-4"></i>
                        Table
                    </button>
                    <button
                        onClick={() => onViewChange('list')}
                        className={cx(
                            "px-3 py-1.5 rounded-md text-sm font-medium transition-all flex items-center gap-2",
                            currentView === 'list' ? activeClass : inactiveClass
                        )}
                    >
                        <i data-lucide="list" className="w-4 h-4"></i>
                        List
                    </button>
                    <button
                        onClick={() => onViewChange('gantt')}
                        className={cx(
                            "px-3 py-1.5 rounded-md text-sm font-medium transition-all flex items-center gap-2",
                            currentView === 'gantt' ? activeClass : inactiveClass
                        )}
                    >
                        <i data-lucide="bar-chart-2" className="w-4 h-4"></i>
                        Gantt
                    </button>
                </div>
            );
        }

        // Table View Component
        function TableView({ entries, onOpen }) {
            if (entries.length === 0) {
                return (
                    <div className="bg-white rounded-xl border border-graystone-200 shadow-sm p-12 text-center">
                        <i data-lucide="table" className="w-12 h-12 text-graystone-300 mx-auto mb-3"></i>
                        <div className="text-sm text-graystone-500">No items to display</div>
                    </div>
                );
            }

            return (
                <div className="bg-white rounded-xl border border-graystone-200 shadow-sm overflow-hidden max-w-full">
                    <div className="overflow-x-auto">
                        <table className="w-full min-w-[800px]">
                            <thead className="bg-graystone-50 border-b border-graystone-200">
                                <tr>
                                    <th className="px-6 py-3 text-left text-xs font-bold text-ocean-900 uppercase tracking-wider">Title</th>
                                    <th className="px-6 py-3 text-left text-xs font-bold text-ocean-900 uppercase tracking-wider">Status</th>
                                    <th className="px-6 py-3 text-left text-xs font-bold text-ocean-900 uppercase tracking-wider">Owner</th>
                                    <th className="px-6 py-3 text-left text-xs font-bold text-ocean-900 uppercase tracking-wider">Team</th>
                                    <th className="px-6 py-3 text-left text-xs font-bold text-ocean-900 uppercase tracking-wider">Deadline</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-graystone-100">
                                {entries.map(entry => (
                                    <tr key={entry.id} onClick={() => onOpen(entry.id)} className="hover:bg-ocean-50 cursor-pointer transition-colors">
                                        <td className="px-6 py-4 whitespace-nowrap">
                                            <div className="flex items-start gap-2">
                                                <div className="font-medium text-ocean-900 heading-font">{entry.title}</div>
                                                <i data-lucide="external-link" className="w-4 h-4 text-graystone-300"></i>
                                            </div>
                                            <div className="text-xs text-graystone-500 truncate max-w-[200px]">{entry.caption}</div>
                                        </td>
                                        <td className="px-6 py-4 whitespace-nowrap">
                                            <Badge variant={entry.workflowStatus === 'Done' ? 'success' : 'default'}>{entry.workflowStatus}</Badge>
                                        </td>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm text-graystone-700">{entry.owner}</td>
                                        <td className="px-6 py-4 whitespace-nowrap">
                                            {entry.team && <span className="bg-graystone-100 px-2 py-1 rounded text-xs font-medium text-graystone-700">{entry.team}</span>}
                                        </td>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm text-graystone-700">
                                            {entry.timelineValue}
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        }

        // List View Component
        function ListView({ entries, onOpen }) {
            if (entries.length === 0) {
                return (
                    <div className="bg-white rounded-xl border border-graystone-200 shadow-sm p-12 text-center">
                        <i data-lucide="list" className="w-12 h-12 text-graystone-300 mx-auto mb-3"></i>
                        <div className="text-sm text-graystone-500">No items to display</div>
                    </div>
                );
            }

            return (
                <div className="space-y-2">
                    {entries.map(entry => (
                        <div key={entry.id} onClick={() => onOpen(entry.id)} className="bg-white p-4 rounded-xl border border-graystone-200 shadow-sm hover:shadow-md transition-all cursor-pointer flex items-center justify-between group">
                            <div className="flex items-center gap-4">
                                <div className={cx(
                                    "w-2 h-12 rounded-full",
                                    entry.workflowStatus === 'Done' ? "bg-green-500" : "bg-ocean-500"
                                )}></div>
                                <div>
                                    <h4 className="font-bold text-ocean-900 group-hover:text-ocean-700 heading-font">{entry.title}</h4>
                                    <div className="flex items-center gap-2 text-xs text-graystone-500 mt-1">
                                        <span>{entry.owner}</span>
                                        <span>•</span>
                                        <span>{entry.team}</span>
                                        <span>•</span>
                                        <span>{entry.timelineValue}</span>
                                    </div>
                                </div>
                            </div>
                            <div className="flex items-center gap-4">
                                <div className="flex -space-x-2">
                                    {entry.collaborators && entry.collaborators.map((collab, i) => (
                                        <div key={i} className="w-8 h-8 rounded-full bg-ocean-100 border-2 border-white flex items-center justify-center text-xs font-bold text-ocean-700" title={collab}>
                                            {collab.charAt(0)}
                                        </div>
                                    ))}
                                </div>
                                <Badge variant="neutral">{entry.workflowStatus}</Badge>
                                <i data-lucide="external-link" className="w-5 h-5 text-graystone-300 group-hover:text-ocean-500"></i>
                            </div>
                        </div>
                    ))}
                </div>
            );
        }

        // Gantt View Component
        function GanttView({ entries, onOpen }) {
            // Filter entries with valid dates
            const validEntries = entries.filter(entry => {
                const dateStr = entry.date || entry.timelineValue;
                if (!dateStr) return false;
                const d = new Date(dateStr);
                return !isNaN(d.getTime());
            });

            // Empty state
            if (validEntries.length === 0) {
                return (
                    <div className="bg-white rounded-xl border border-graystone-200 shadow-sm p-12 text-center">
                        <i data-lucide="calendar-x" className="w-12 h-12 text-graystone-300 mx-auto mb-3"></i>
                        <div className="text-sm text-graystone-500">No items with valid dates to display</div>
                    </div>
                );
            }

            // Calculate date range for valid entries
            const allDates = validEntries.flatMap(entry => {
                const deadline = new Date(entry.date || entry.timelineValue);
                const start = entry.startDate ? new Date(entry.startDate) : new Date(deadline.getTime() - 7 * 24 * 60 * 60 * 1000);
                return [start, deadline];
            }).filter(d => !isNaN(d.getTime()));

            const minDate = new Date(Math.min(...allDates));
            const maxDate = new Date(Math.max(...allDates));
            const totalDays = Math.ceil((maxDate - minDate) / (1000 * 60 * 60 * 24)) || 1;

            const sortedEntries = [...validEntries].sort((a, b) => {
                const aStart = a.startDate ? new Date(a.startDate) : new Date(new Date(a.date || a.timelineValue).getTime() - 7 * 24 * 60 * 60 * 1000);
                const bStart = b.startDate ? new Date(b.startDate) : new Date(new Date(b.date || b.timelineValue).getTime() - 7 * 24 * 60 * 60 * 1000);
                return aStart - bStart;
            });

            return (
                <div className="bg-white rounded-xl border border-graystone-200 shadow-sm overflow-x-auto max-w-full">
                    <div className="min-w-[800px] p-6">
                        <div className="space-y-6">
                            {sortedEntries.map(entry => {
                                const deadline = new Date(entry.date || entry.timelineValue);
                                const start = new Date(entry.startDate || deadline.getTime() - 7 * 24 * 60 * 60 * 1000);

                                const daysFromStart = Math.ceil((start - minDate) / (1000 * 60 * 60 * 24));
                                const duration = Math.ceil((deadline - start) / (1000 * 60 * 60 * 24)) || 1;

                                const leftPercent = (daysFromStart / totalDays) * 100;
                                const widthPercent = (duration / totalDays) * 100;

                                return (
                                    <div key={entry.id} className="relative">
                                        <div className="flex items-center justify-between mb-2">
                                            <div className="font-medium text-sm text-ocean-900 w-48 truncate heading-font" title={entry.title}>{entry.title}</div>
                                            <div className="text-xs text-graystone-500">
                                                {entry.startDate ? `${entry.startDate} → ${entry.date || entry.timelineValue}` : entry.timelineValue}
                                            </div>
                                        </div>
                                        <div className="h-8 bg-graystone-50 rounded-full relative overflow-hidden">
                                            <div
                                                className={cx(
                                                    "absolute top-0 bottom-0 rounded-full flex items-center px-3 text-xs font-medium text-white transition-all hover:opacity-90 cursor-pointer",
                                                    entry.workflowStatus === 'Done' ? "bg-green-500" : "bg-ocean-500"
                                                )}
                                                style={{
                                                    width: `${Math.max(widthPercent, 5)}%`,
                                                    left: `${leftPercent}%`
                                                }}
                                                onClick={() => onOpen(entry.id)}
                                                title={`${duration} day${duration !== 1 ? 's' : ''}`}
                                            >
                                                <span className="truncate">{entry.workflowStatus}</span>
                                            </div>
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    </div>
                </div>
            );
        }

        // Main App
        function App() {
            // --- STATE REPLACEMENT START ---
            const [currentUser, setCurrentUser] = useState("Loading...");
            const [entries, setEntries] = useState([]); // Start empty, load from SharePoint
            const [managers, setManagers] = useState(MANAGERS);
            const [loading, setLoading] = useState(true);
            const [saving, setSaving] = useState(false);
            const [saveError, setSaveError] = useState("");

            // Authentication State
            const [authUser, setAuthUser] = useState(null);
            const [userEmail, setUserEmail] = useState("");
            const [authChecked, setAuthChecked] = useState(!AUTH_CONFIG.AUTH_ENABLED);

            // Check authentication on mount
            useEffect(() => {
                if (!AUTH_CONFIG.AUTH_ENABLED) return;

                async function checkAuth() {
                    // Skip auth on file:// protocol (local testing)
                    if (window.location.protocol === 'file:') {
                        console.log("Local testing mode: Skipping authentication");
                        setAuthChecked(true);
                        setAuthUser({ localTest: true }); // Fake user for local testing
                        setUserEmail("daniel.davis@populationmatters.org"); // Default test email
                        setCurrentUser("Dan Davis"); // Default test user
                        return;
                    }

                    const clerk = await initClerk();
                    if (!clerk) {
                        // Clerk failed to load - show login screen anyway
                        console.warn("Clerk unavailable - authentication may not work");
                        setAuthChecked(true);
                        return;
                    }

                    if (clerk.user) {
                        setAuthUser(clerk.user);
                        setUserEmail(clerk.user.primaryEmailAddress?.emailAddress || "");
                        setCurrentUser(clerk.user.fullName || clerk.user.firstName || "User");
                    }
                    setAuthChecked(true);
                }
                checkAuth();
            }, []);

            // Handle auth change (login/logout)
            const handleAuthChange = (user) => {
                if (user) {
                    setAuthUser(user);
                    const email = user.primaryEmailAddress?.emailAddress || "";
                    setUserEmail(email);

                    // Try to match to a pre-seeded profile
                    const preseededProfile = getPreseededProfile(email);
                    if (preseededProfile) {
                        // Use the pre-seeded name and team
                        setCurrentUser(preseededProfile.name);
                        console.log(`Matched user ${email} to pre-seeded profile: ${preseededProfile.name}`);
                    } else {
                        // Fall back to Clerk user info
                        setCurrentUser(user.fullName || user.firstName || "User");
                    }
                } else {
                    setAuthUser(null);
                    setUserEmail("");
                }
            };

            // Handle sign out
            const handleSignOut = async () => {
                // In local test mode, just reset to test user
                if (authUser?.localTest) {
                    console.log("Local test mode: Sign out simulated");
                    return;
                }

                const clerk = await initClerk();
                if (clerk) {
                    await clerk.signOut();
                    setAuthUser(null);
                    setUserEmail("");
                    setCurrentUser("Loading...");
                }
            };

            // Load Data on Startup
            useEffect(() => {
                async function init() {
                    // Local testing mode - use mock data
                    if (window.location.protocol === 'file:') {
                        console.log("Local testing mode: Loading mock data");
                        setEntries([
                            { id: 1, title: "Website Redesign", caption: "Complete overhaul of main site", workflowStatus: "In Progress", team: "Advocacy & Influence", timelineValue: "2025-Q1", owner: "Dan Davis", collaborators: ["Francesca Harrison"], tags: ["Priority"], subtasks: [{ id: 1, title: "Design mockups", completed: true, assignedTo: "Francesca Harrison" }, { id: 2, title: "Implement homepage", completed: false, assignedTo: "Dan Davis" }] },
                            { id: 2, title: "Annual Report 2024", caption: "Compile and publish annual report", workflowStatus: "Ready for Review", team: "Research", timelineValue: "2025-Q1", owner: "Emma Lewendon-Strutt", collaborators: ["Josh Hill"], tags: ["Report"] },
                            { id: 3, title: "Social Media Campaign", caption: "Q1 awareness campaign", workflowStatus: "In Progress", team: "Advocacy & Influence", timelineValue: "2025-Q1", owner: "Francesca Harrison", collaborators: [], tags: ["Marketing"] },
                            { id: 4, title: "Donor Database Update", caption: "Clean and update donor records", workflowStatus: "Idea", team: "Fundraising", timelineValue: "2025-Q2", owner: "Madeleine Hewitt", collaborators: [], tags: [] },
                            { id: 5, title: "Policy Brief: Climate", caption: "Research paper on population and climate", workflowStatus: "Draft", team: "Research", timelineValue: "2025-Q1", owner: "Josh Hill", collaborators: ["Emma Lewendon-Strutt"], tags: ["Research", "Priority"] },
                            { id: 6, title: "Newsletter March", caption: "Monthly newsletter", workflowStatus: "Done", team: "Advocacy & Influence", timelineValue: "2025-01", owner: "Shweta Shirodkar", collaborators: [], tags: ["Newsletter"] },
                            { id: 7, title: "Board Meeting Prep", caption: "Prepare materials for Q1 board meeting", workflowStatus: "In Progress", team: "Advocacy & Influence", timelineValue: "2025-Q1", owner: "Jameen Kaur", collaborators: ["Dan Davis"], tags: ["Meeting"] },
                            { id: 8, title: "Grant Application", caption: "Submit grant proposal to foundation", workflowStatus: "Ready for Review", team: "Fundraising", timelineValue: "2025-02", owner: "Madeleine Hewitt", collaborators: ["Shweta Shirodkar"], tags: ["Funding", "Priority"], date: "2025-02-15" }
                        ]);
                        setLoading(false);
                        return;
                    }

                    // 1. Get User (from SharePoint if auth not enabled, otherwise from Clerk)
                    if (!AUTH_CONFIG.AUTH_ENABLED) {
                        const user = await SP_API.getCurrentUser();
                        setCurrentUser(user);
                    }

                    // 2. Get Workflow Items
                    try {
                        const spItems = await SP_API.fetchList('WorkflowItems');
                        const mappedEntries = spItems.map(item => {
                            const extra = item.JSON_Data ? JSON.parse(item.JSON_Data) : {};
                            return {
                                id: item.ID,
                                title: item.Title,
                                caption: item.caption,
                                workflowStatus: item.workflowStatus,
                                team: item.team,
                                timelineValue: item.timelineValue,
                                owner: item.owner?.Title || "Unassigned",
                                collaborators: item.collaborators?.results ? item.collaborators.results.map(c => c.Title) : [],
                                ...extra // Unpack tags, subtasks, documents
                            };
                        });
                        setEntries(mappedEntries);
                    } catch (e) { console.error("Could not load WorkflowItems", e); }

                    // 3. Get Managers list (if available)
                    try {
                        const mgrItems = await SP_API.fetchManagers();
                        const mappedManagers = mgrItems.map((m) => {
                            const emailValue = (m.Email && m.Email.EMail) || m.Email || "";
                            const nameValue = m.Title || (m.Email && m.Email.Title) || emailValue || "";
                            return {
                                name: nameValue,
                                email: emailValue || nameValue,
                                team: m.Team || "",
                                reports: m.Reports?.results ? m.Reports.results.map((r) => r.Title) : []
                            };
                        }).filter((m) => m.name);
                        if (mappedManagers.length) setManagers(mappedManagers);
                    } catch (e) {
                        console.warn("Could not load Managers list; using defaults", e);
                    }

                    setLoading(false);
                }
                init();
            }, []);
            // --- STATE REPLACEMENT END ---

            const [currentView, setCurrentView] = useState("dashboard"); // dashboard, personal, add-item, teams, team-board, org, calendar, item-dashboard, todo, manager-hub
            const [selectedTeam, setSelectedTeam] = useState(null);
            const [selectedItemId, setSelectedItemId] = useState(null);
            const [todos, setTodos] = useState([]);

            // Search & Filter State
            const [searchQuery, setSearchQuery] = useState("");
            const [filterTags, setFilterTags] = useState([]);
            const [filterUsers, setFilterUsers] = useState([]);
            const [filterTeams, setFilterTeams] = useState([]);
            const [viewMode, setViewMode] = useState('kanban'); // 'kanban', 'table', 'list', 'gantt', 'mindmap'

            // Subtask Modal State
            const [showSubtaskModal, setShowSubtaskModal] = useState(false);
            const [modalEntryId, setModalEntryId] = useState(null);
            const [newSubtaskTitle, setNewSubtaskTitle] = useState('');
            const [newSubtaskDeadline, setNewSubtaskDeadline] = useState('');
            const [newSubtaskOwner, setNewSubtaskOwner] = useState('');
            const [newSubtaskContext, setNewSubtaskContext] = useState('');

            // Add Item Choice Modal State
            const [showAddItemModal, setShowAddItemModal] = useState(false);

            // Stats Modal (Personal view)
            const [showStatsModal, setShowStatsModal] = useState(false);
            const [statsModalTitle, setStatsModalTitle] = useState('');
            const [statsModalItems, setStatsModalItems] = useState([]);

            // Persist an entry back to SharePoint, packing extra data into JSON_Data
            const persistEntryToSharePoint = async (entry) => {
                try {
                    const {
                        id,
                        title,
                        caption,
                        workflowStatus,
                        team,
                        timelineValue,
                        owner,
                        collaborators,
                        ...extra
                    } = entry;
                    const payload = {
                        __metadata: { "type": "SP.Data.WorkflowItemsListItem" },
                        Title: title,
                        caption: caption,
                        workflowStatus: workflowStatus,
                        team: team,
                        timelineValue: timelineValue,
                        JSON_Data: JSON.stringify({
                            owner,
                            collaborators,
                            ...extra
                        })
                    };
                    await SP_API.updateItem('WorkflowItems', id, payload);
                } catch (e) {
                    console.error("Failed to persist entry to SharePoint", e);
                }
            };

            // Re-initialize Lucide icons whenever the view changes
            useEffect(() => {
                lucide.createIcons();
            }, [currentView, viewMode, showSubtaskModal, showAddItemModal, showStatsModal]);

            const openSubtaskModal = (entryId) => {
                setModalEntryId(entryId);
                setShowSubtaskModal(true);
            };

            const closeSubtaskModal = () => {
                setShowSubtaskModal(false);
                setModalEntryId(null);
                setNewSubtaskTitle('');
                setNewSubtaskDeadline('');
                setNewSubtaskOwner('');
                setNewSubtaskContext('');
            };

            const handleUpdateEntry = (entryId, updates) => {
                let updatedEntry = null;
                setEntries((prev) =>
                    prev.map((entry) => {
                        if (entry.id !== entryId) return entry;
                        const patch = typeof updates === 'function' ? updates(entry) : updates;
                        if (!patch || typeof patch !== 'object') return entry;
                        updatedEntry = { ...entry, ...patch };
                        return updatedEntry;
                    })
                );
                if (updatedEntry) {
                    persistEntryToSharePoint(updatedEntry);
                }
            };

            const handleAddSubtask = (entryId) => {
                if (!newSubtaskTitle.trim()) return;

                // Validate owner - don't allow "Loading..." as assignee
                const assignee = newSubtaskOwner || (currentUser !== "Loading..." ? currentUser : USERS[0]);

                const newSubtask = {
                    id: `st${Date.now()}`,
                    title: newSubtaskTitle,
                    deadline: newSubtaskDeadline,
                    assignedTo: assignee,
                    completed: false,
                    context: newSubtaskContext
                };
                handleUpdateEntry(entryId, (entry) => {
                    const updatedSubtasks = entry.subtasks ? [...entry.subtasks, newSubtask] : [newSubtask];
                    return { ...entry, subtasks: updatedSubtasks };
                });
                closeSubtaskModal();
            };

            // Derived State: Available Tags
            const availableTags = Array.from(new Set(entries.flatMap(e => e.tags || []))).sort();

            // Filter Logic
            const filterEntries = (items) => {
                return items.filter(entry => {
                    const matchesSearch = searchQuery === "" ||
                        entry.title.toLowerCase().includes(searchQuery.toLowerCase()) ||
                        entry.owner.toLowerCase().includes(searchQuery.toLowerCase()) ||
                        (entry.tags && entry.tags.some(t => t.toLowerCase().includes(searchQuery.toLowerCase())));

                    const matchesTags = filterTags.length === 0 || (entry.tags && entry.tags.some(t => filterTags.includes(t)));

                    const matchesUsers = filterUsers.length === 0 ||
                        filterUsers.some(u => entry.owner === u || (entry.collaborators && entry.collaborators.includes(u)));

                    const matchesTeams = filterTeams.length === 0 || filterTeams.includes(entry.team);

                    return matchesSearch && matchesTags && matchesUsers && matchesTeams;
                });
            };

            const handleNavigate = (view) => {
                // Intercept add-item navigation to show modal
                if (view === 'add-item') {
                    setShowAddItemModal(true);
                    return;
                }

                // Clear filters on all major view changes to prevent unexpected filtering
                const shouldClearFilters = ['dashboard', 'personal', 'teams', 'org', 'calendar', 'manager-hub'].includes(view);
                if (shouldClearFilters) {
                    setSearchQuery("");
                    setFilterTags([]);
                    setFilterUsers([]);
                    setFilterTeams([]);
                }

                setCurrentView(view);
                if (view === 'dashboard') {
                    setSelectedTeam(null);
                    setSelectedItemId(null);
                    setViewMode('kanban');
                }
            };

            const handleTeamSelect = (team) => {
                setSelectedTeam(team);
                setCurrentView("team-board");
            };

            const handleAddItem = async (newItem) => {
                setSaving(true);
                setSaveError("");

                try {
                    // 1. Separate standard columns from complex data
                    const { title, caption, workflowStatus, team, timelineValue, ...complexData } = newItem;

                    // 2. Send to SharePoint
                    const payload = {
                        __metadata: { "type": "SP.Data.WorkflowItemsListItem" },
                        Title: title,
                        caption: caption,
                        workflowStatus: "Idea",
                        team: team,
                        timelineValue: timelineValue,
                        JSON_Data: JSON.stringify(complexData)
                    };

                    await SP_API.saveItem('WorkflowItems', payload);

                    // 3. Refresh Page to see new item (after save completes)
                    window.location.reload();
                } catch (error) {
                    console.error("Failed to save item:", error);
                    setSaveError("Failed to save item. Please try again.");
                    setSaving(false);
                }
            };

            const handleUpdateStatus = async (id, newStatus) => {
                // 1. Optimistic Update (Instant UI change)
                setEntries(entries.map(e => e.id === id ? { ...e, workflowStatus: newStatus } : e));

                // 2. Send to SharePoint
                await SP_API.updateItem('WorkflowItems', id, {
                    __metadata: { "type": "SP.Data.WorkflowItemsListItem" },
                    workflowStatus: newStatus
                });
            };

            const handleOpenEntry = (id) => {
                setSelectedItemId(id);
                setCurrentView("item-dashboard");
            };

            const handleToggleSubtask = (entryId, subtaskId) => {
                handleUpdateEntry(entryId, (entry) => {
                    if (!entry.subtasks) return entry;
                    const subtasks = entry.subtasks.map((st) =>
                        st.id === subtaskId ? { ...st, completed: !st.completed } : st
                    );
                    return { ...entry, subtasks };
                });
            };

            const handleAddTodo = (newTodo) => {
                setTodos([...todos, { ...newTodo, id: Date.now() }]);
            };

            const handleToggleTodo = (todoId) => {
                setTodos(todos.map(t => t.id === todoId ? { ...t, completed: !t.completed } : t));
            };

            const openStatsModal = (title, items) => {
                setStatsModalTitle(title);
                setStatsModalItems(items || []);
                setShowStatsModal(true);
            };

            const closeStatsModal = () => {
                setShowStatsModal(false);
                setStatsModalItems([]);
                setStatsModalTitle('');
            };

            // View Logic
            const renderContent = () => {
                switch (currentView) {
                    case 'dashboard':
                        return <Dashboard entries={entries} currentUser={currentUser} onOpenEntry={handleOpenEntry} />;

                    case "add-item":
                        return <AddItemForm onSubmit={handleAddItem} onBack={() => handleNavigate('dashboard')} availableTags={availableTags} />;

                    case 'project-explorer':
                        return (
                            <ProjectExplorer
                                entries={entries}
                                onOpen={handleOpenEntry}
                                onUpdateStatus={handleUpdateStatus}
                                openSubtaskModal={openSubtaskModal}
                                currentUser={currentUser}
                                searchQuery={searchQuery}
                                setSearchQuery={setSearchQuery}
                                filterTags={filterTags}
                                setFilterTags={setFilterTags}
                                filterUsers={filterUsers}
                                setFilterUsers={setFilterUsers}
                                filterTeams={filterTeams}
                                setFilterTeams={setFilterTeams}
                                availableTags={availableTags}
                                filterEntries={filterEntries}
                                viewMode={viewMode}
                                setViewMode={setViewMode}
                            />
                        );

                    case 'manager-hub':
                        // Only managers and admins can access Manager Hub
                        if (!isManager(userEmail) && !isAdmin(userEmail)) {
                            return (
                                <div className="flex items-center justify-center h-64">
                                    <div className="text-center">
                                        <i data-lucide="shield-alert" className="w-16 h-16 text-amber-500 mx-auto mb-4"></i>
                                        <h2 className="text-xl font-bold text-ocean-900 mb-2">Access Restricted</h2>
                                        <p className="text-graystone-600 mb-4">You don't have permission to access Manager Hub.</p>
                                        <button
                                            onClick={() => setCurrentView('dashboard')}
                                            className="px-4 py-2 bg-ocean-500 text-white rounded-lg hover:bg-ocean-600 transition"
                                        >
                                            Return to Dashboard
                                        </button>
                                    </div>
                                </div>
                            );
                        }
                        return <ManagerHub managers={managers} teams={TEAMS} entries={entries} currentUser={currentUser} openStatsModal={openStatsModal} onOpen={handleOpenEntry} onUpdateStatus={handleUpdateStatus} openSubtaskModal={openSubtaskModal} />;

                    case 'personal': {
                        const myOwnedEntries = entries.filter(e => e.owner === currentUser);
                        const personalEntries = filterEntries(myOwnedEntries);
                        const collaboratingEntries = filterEntries(
                            entries.filter(e =>
                                e.owner !== currentUser &&
                                Array.isArray(e.collaborators) &&
                                e.collaborators.includes(currentUser)
                            )
                        );

                        const parseDate = (value) => {
                            if (!value) return null;
                            const d = new Date(value);
                            return isNaN(d) ? null : d;
                        };

                        const now = new Date();
                        const horizon = new Date(now.getTime() + 14 * 24 * 60 * 60 * 1000);

                        const datedEntries = personalEntries
                            .map((entry) => ({ entry, date: parseDate(entry.date || entry.timelineValue) }))
                            .filter(({ date }) => date);

                        const dueSoon = datedEntries
                            .filter(({ date }) => date >= now && date <= horizon)
                            .sort((a, b) => a.date - b.date)
                            .slice(0, 5)
                            .map(({ entry }) => entry);

                        const overdue = datedEntries
                            .filter(({ date }) => date < now)
                            .sort((a, b) => a.date - b.date)
                            .slice(0, 5)
                            .map(({ entry }) => entry);

                        const activeEntries = personalEntries.filter((e) => (e.workflowStatus || "").toLowerCase() !== "done");
                        const completedEntries = personalEntries.filter((e) => (e.workflowStatus || "").toLowerCase() === "done");
                        const completionRate = personalEntries.length ? Math.round((completedEntries.length / personalEntries.length) * 100) : 0;

                        const mySubtasks = entries
                            .flatMap((entry) => Array.isArray(entry.subtasks)
                                ? entry.subtasks.map((st) => ({
                                    ...st,
                                    parentId: entry.id,
                                    parentTitle: entry.title || "Untitled"
                                }))
                                : []
                            )
                            .filter((st) => st.assignedTo === currentUser);

                        const openSubtasks = mySubtasks.filter((st) => !st.completed);
                        const prioritizedSubtasks = [...openSubtasks]
                            .sort((a, b) => {
                                const da = parseDate(a.deadline);
                                const db = parseDate(b.deadline);
                                if (da && db) return da - db;
                                if (da) return -1;
                                if (db) return 1;
                                return (a.title || "").localeCompare(b.title || "");
                            })
                            .slice(0, 5);

                        const statusCounts = personalEntries.reduce((acc, entry) => {
                            const key = entry.workflowStatus || "Unspecified";
                            acc[key] = (acc[key] || 0) + 1;
                            return acc;
                        }, {});
                        const maxStatusCount = Math.max(1, ...(Object.values(statusCounts).length ? Object.values(statusCounts) : [0]));

                        return (
                            <div className="flex flex-col animate-in fade-in duration-500 space-y-6">
                                <div className="bg-gradient-to-r from-ocean-500 to-ocean-600 rounded-2xl p-6 text-white shadow-xl flex flex-col gap-4">
                                    <div className="flex flex-col gap-1">
                                        <h2 className="text-2xl font-bold">Your Projects Hub</h2>
                                        <p className="text-ocean-100 text-sm">Track what you own, see what's next, and unblock progress.</p>
                                    </div>
                                    <div className="flex flex-col lg:flex-row lg:items-center gap-3">
                                        <div className="relative group flex-1 max-w-xl">
                                            <i data-lucide="search" className="w-4 h-4 absolute left-3 top-1/2 -translate-y-1/2 text-ocean-200 group-focus-within:text-ocean-600 transition-colors"></i>
                                            <input
                                                type="text"
                                                placeholder="Search your projects..."
                                                value={searchQuery}
                                                onChange={(e) => setSearchQuery(e.target.value)}
                                                className="w-full pl-9 pr-4 py-2 bg-black/20 border border-white/15 rounded-lg text-sm text-white placeholder-ocean-200 focus:outline-none focus:bg-white focus:text-ocean-900 focus:placeholder-graystone-400 transition-all"
                                            />
                                        </div>
                                    </div>
                                </div>

                                <div className="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-5 gap-4">
                                    <button
                                        type="button"
                                        onClick={() => openStatsModal("Owned projects", personalEntries)}
                                        className="bg-white rounded-xl border border-ocean-100 shadow-sm p-5 text-left transition hover:shadow-md hover:-translate-y-0.5 group"
                                    >
                                        <div className="text-xs font-semibold text-graystone-600 uppercase mb-1">Owned projects</div>
                                        <div className="relative inline-flex items-center justify-center">
                                            <div
                                                className="absolute rounded-full transition-all duration-300 scale-0 opacity-0 group-hover:scale-100 group-hover:opacity-100"
                                                style={{ backgroundColor: '#0CFFFF', width: '43px', height: '43px' }}
                                            ></div>
                                            <div className="text-3xl font-bold text-ocean-900 relative z-10">{personalEntries.length}</div>
                                        </div>
                                        <div className="text-xs text-graystone-500 mt-1">Only items where you are the owner</div>
                                    </button>
                                    <button
                                        type="button"
                                        onClick={() => openStatsModal("Collaborating", collaboratingEntries)}
                                        className="bg-white rounded-xl border border-ocean-100 shadow-sm p-5 text-left transition hover:shadow-md hover:-translate-y-0.5 group"
                                    >
                                        <div className="text-xs font-semibold text-graystone-600 uppercase mb-1">Collaborating</div>
                                        <div className="relative inline-flex items-center justify-center">
                                            <div
                                                className="absolute rounded-full transition-all duration-300 scale-0 opacity-0 group-hover:scale-100 group-hover:opacity-100"
                                                style={{ backgroundColor: '#0CFFFF', width: '43px', height: '43px' }}
                                            ></div>
                                            <div className="text-3xl font-bold text-ocean-900 relative z-10">{collaboratingEntries.length}</div>
                                        </div>
                                        <div className="text-xs text-graystone-500 mt-1">You’re a collaborator (not owner)</div>
                                    </button>
                                    <button
                                        type="button"
                                        onClick={() => openStatsModal("In motion", activeEntries)}
                                        className="bg-white rounded-xl border border-ocean-100 shadow-sm p-5 text-left transition hover:shadow-md hover:-translate-y-0.5 group"
                                    >
                                        <div className="flex items-center justify-between">
                                            <div>
                                                <div className="text-xs font-semibold text-graystone-600 uppercase mb-1">In motion</div>
                                                <div className="relative inline-flex items-center justify-center">
                                                    <div
                                                        className="absolute rounded-full transition-all duration-300 scale-0 opacity-0 group-hover:scale-100 group-hover:opacity-100"
                                                        style={{ backgroundColor: '#0CFFFF', width: '43px', height: '43px' }}
                                                    ></div>
                                                    <div className="text-3xl font-bold text-ocean-900 relative z-10">{activeEntries.length}</div>
                                                </div>
                                            </div>
                                            <Badge variant="secondary">{completionRate}% done</Badge>
                                        </div>
                                        <div className="w-full h-2 bg-graystone-100 rounded-full mt-3 overflow-hidden">
                                            <div className="h-full bg-ocean-500 rounded-full transition-all" style={{ width: `${completionRate}%` }}></div>
                                        </div>
                                    </button>
                                    <button
                                        type="button"
                                        onClick={() => openStatsModal("Due next 14 days", dueSoon)}
                                        className="bg-white rounded-xl border border-ocean-100 shadow-sm p-5 text-left transition hover:shadow-md hover:-translate-y-0.5 group"
                                    >
                                        <div className="text-xs font-semibold text-graystone-600 uppercase mb-1">Due next 14 days</div>
                                        <div className="relative inline-flex items-center justify-center">
                                            <div
                                                className="absolute rounded-full transition-all duration-300 scale-0 opacity-0 group-hover:scale-100 group-hover:opacity-100"
                                                style={{ backgroundColor: '#0CFFFF', width: '43px', height: '43px' }}
                                            ></div>
                                            <div className="text-3xl font-bold text-ocean-900 relative z-10">{dueSoon.length}</div>
                                        </div>
                                        <div className="text-xs text-graystone-500 mt-1">Based on deadline/timeline</div>
                                    </button>
                                    <button
                                        type="button"
                                        onClick={() => openStatsModal("Overdue", overdue)}
                                        className="bg-white rounded-xl border border-ocean-100 shadow-sm p-5 text-left transition hover:shadow-md hover:-translate-y-0.5 group"
                                    >
                                        <div className="text-xs font-semibold text-graystone-600 uppercase mb-1">Overdue</div>
                                        <div className="relative inline-flex items-center justify-center">
                                            <div
                                                className="absolute rounded-full transition-all duration-300 scale-0 opacity-0 group-hover:scale-100 group-hover:opacity-100"
                                                style={{ backgroundColor: '#0CFFFF', width: '43px', height: '43px' }}
                                            ></div>
                                            <div className="text-3xl font-bold text-ocean-900 relative z-10">{overdue.length}</div>
                                        </div>
                                        <div className="text-xs text-graystone-500 mt-1">Past the date</div>
                                    </button>
                                </div>

                                <div className="space-y-6">
                                    <div className="bg-white rounded-xl border border-ocean-100 shadow-sm p-6">
                                        <div className="flex items-center justify-between mb-4">
                                            <div>
                                                <h3 className="font-heading text-lg text-ocean-900 tracking-wide">Project view</h3>
                                                <p className="text-xs text-graystone-600">Switch how you want to see your owned work.</p>
                                            </div>
                                            <ViewSwitcher currentView={viewMode} onViewChange={setViewMode} />
                                        </div>

                                        {viewMode === 'kanban' && (
                                            <KanbanBoard
                                                statuses={KANBAN_STATUSES}
                                                entries={personalEntries}
                                                onOpen={handleOpenEntry}
                                                onUpdateStatus={handleUpdateStatus}
                                                openSubtaskModal={openSubtaskModal}
                                                currentUser={currentUser}
                                            />
                                        )}
                                        {viewMode === 'table' && (
                                            <TableView
                                                entries={personalEntries}
                                                onOpen={handleOpenEntry}
                                            />
                                        )}
                                        {viewMode === 'list' && (
                                            <ListView
                                                entries={personalEntries}
                                                onOpen={handleOpenEntry}
                                            />
                                        )}
                                        {viewMode === 'gantt' && (
                                            <GanttView
                                                entries={personalEntries}
                                                onOpen={handleOpenEntry}
                                            />
                                        )}
                                    </div>

                                    <div className="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-4">
                                        <div className="bg-white rounded-xl border border-ocean-100 shadow-sm p-5">
                                            <div className="flex items-center justify-between mb-3">
                                                <h3 className="font-heading text-lg text-ocean-900 tracking-wide flex items-center gap-2">
                                                    <i data-lucide="calendar" className="w-5 h-5"></i>
                                                    Upcoming (14 days)
                                                </h3>
                                                <Badge variant="secondary">{dueSoon.length}</Badge>
                                            </div>
                                            <div className="space-y-3">
                                                {dueSoon.length ? dueSoon.map(item => (
                                                    <button
                                                        key={item.id}
                                                        onClick={() => handleOpenEntry(item.id)}
                                                        className="w-full text-left p-3 rounded-lg border border-ocean-100 hover:border-ocean-400 hover:bg-ocean-50 transition-all group"
                                                    >
                                                        <div className="flex items-center justify-between">
                                                            <span className="font-medium text-ocean-900 heading-font truncate">{item.title}</span>
                                                            <i data-lucide="external-link" className="w-4 h-4 text-graystone-300 group-hover:text-ocean-500"></i>
                                                        </div>
                                                        <div className="text-xs text-graystone-600 mt-1 flex items-center gap-2">
                                                            <i data-lucide="clock" className="w-3 h-3"></i>
                                                            <span>{item.date || item.timelineValue}</span>
                                                        </div>
                                                    </button>
                                                )) : (
                                                    <div className="text-sm text-graystone-500 text-center py-6">Nothing due soon</div>
                                                )}
                                            </div>
                                        </div>

                                        <div className="bg-white rounded-xl border border-ocean-100 shadow-sm p-5">
                                            <div className="flex items-center justify-between mb-3">
                                                <h3 className="font-heading text-lg text-ocean-900 tracking-wide flex items-center gap-2">
                                                    <i data-lucide="alert-circle" className="w-5 h-5 text-ocean-600"></i>
                                                    Overdue
                                                </h3>
                                                <Badge variant="secondary">{overdue.length}</Badge>
                                            </div>
                                            <div className="space-y-3">
                                                {overdue.length ? overdue.map(item => (
                                                    <button
                                                        key={item.id}
                                                        onClick={() => handleOpenEntry(item.id)}
                                                        className="w-full text-left p-3 rounded-lg border border-ocean-100 hover:border-ocean-300 hover:bg-ocean-50 transition-all group"
                                                    >
                                                        <div className="flex items-center justify-between">
                                                            <span className="font-medium text-ocean-900 heading-font truncate">{item.title}</span>
                                                            <i data-lucide="external-link" className="w-4 h-4 text-graystone-300 group-hover:text-ocean-500"></i>
                                                        </div>
                                                        <div className="text-xs text-ocean-700 mt-1 flex items-center gap-2">
                                                            <i data-lucide="calendar-x" className="w-3 h-3 text-ocean-700"></i>
                                                            <span>{item.date || item.timelineValue}</span>
                                                        </div>
                                                    </button>
                                                )) : (
                                                    <div className="text-sm text-graystone-500 text-center py-6">No overdue work</div>
                                                )}
                                            </div>
                                        </div>

                                        <div className="bg-white rounded-xl border border-ocean-100 shadow-sm p-5">
                                            <div className="flex items-center justify-between mb-3">
                                                <h3 className="font-heading text-lg text-ocean-900 tracking-wide flex items-center gap-2">
                                                    <i data-lucide="list-checks" className="w-5 h-5"></i>
                                                    Your subtasks
                                                </h3>
                                                <Badge variant="secondary">{openSubtasks.length} open</Badge>
                                            </div>
                                            <div className="space-y-3">
                                                {prioritizedSubtasks.length ? prioritizedSubtasks.map((subtask) => (
                                                    <button
                                                        key={subtask.id}
                                                        onClick={() => handleOpenEntry(subtask.parentId)}
                                                        className="w-full text-left p-3 rounded-lg border border-ocean-100 hover:border-ocean-400 hover:bg-ocean-50 transition-all group"
                                                    >
                                                        <div className="flex items-center justify-between">
                                                            <span className="font-medium text-ocean-900 heading-font truncate">{subtask.title}</span>
                                                            <i data-lucide="external-link" className="w-4 h-4 text-graystone-300 group-hover:text-ocean-500"></i>
                                                        </div>
                                                        <div className="text-xs text-graystone-600 mt-1 flex items-center gap-2">
                                                            <i data-lucide="folder" className="w-3 h-3"></i>
                                                            <span className="truncate">{subtask.parentTitle}</span>
                                                        </div>
                                                        {subtask.deadline && (
                                                            <div className="text-xs text-ocean-700 mt-1 flex items-center gap-2">
                                                                <i data-lucide="calendar" className="w-3 h-3"></i>
                                                                <span>{subtask.deadline}</span>
                                                            </div>
                                                        )}
                                                    </button>
                                                )) : (
                                                    <div className="text-sm text-graystone-500 text-center py-6">No open subtasks assigned to you</div>
                                                )}
                                            </div>
                                            {mySubtasks.length > prioritizedSubtasks.length && (
                                                <div className="text-[11px] text-graystone-500 mt-3 text-right">
                                                    {mySubtasks.length - prioritizedSubtasks.length} more subtask{(mySubtasks.length - prioritizedSubtasks.length) === 1 ? "" : "s"} not shown
                                                </div>
                                            )}
                                        </div>

                                        <div className="bg-white rounded-xl border border-ocean-100 shadow-sm p-5">
                                            <div className="flex items-center justify-between mb-3">
                                                <h3 className="font-heading text-lg text-ocean-900 tracking-wide flex items-center gap-2">
                                                    <i data-lucide="pie-chart" className="w-5 h-5"></i>
                                                    Status breakdown
                                                </h3>
                                                <Badge variant="secondary">{personalEntries.length}</Badge>
                                            </div>
                                            {personalEntries.length ? (
                                                <div className="space-y-2">
                                                    {Object.entries(statusCounts).sort((a, b) => b[1] - a[1]).map(([status, count]) => (
                                                        <div key={status}>
                                                            <div className="flex items-center justify-between text-xs text-graystone-600 mb-1">
                                                                <span className="font-semibold text-graystone-800">{status}</span>
                                                                <span>{count}</span>
                                                            </div>
                                                            <div className="h-2 bg-graystone-100 rounded-full overflow-hidden">
                                                                <div
                                                                    className="h-full bg-ocean-500 rounded-full"
                                                                    style={{ width: `${(count / maxStatusCount) * 100}%` }}
                                                                ></div>
                                                            </div>
                                                        </div>
                                                    ))}
                                                </div>
                                            ) : (
                                                <div className="text-sm text-graystone-500 text-center py-6">No items yet</div>
                                            )}
                                        </div>
                                    </div>
                                </div>

                            </div>
                        );
                    }

                    case 'todo':
                        return (
                            <ToDoList
                                todos={todos}
                                onAddTodo={handleAddTodo}
                                onToggleTodo={handleToggleTodo}
                                currentUser={currentUser}
                                onBack={() => handleNavigate('dashboard')}
                            />
                        );

                    case 'item-dashboard':
                        const selectedItem = entries.find(e => e.id === selectedItemId);
                        return (
                            <ItemDashboard
                                entry={selectedItem}
                                onBack={() => handleNavigate('dashboard')}
                                onToggleSubtask={handleToggleSubtask}
                                onUpdateEntry={handleUpdateEntry}
                                openSubtaskModal={openSubtaskModal}
                                currentUser={currentUser}
                            />
                        );

                    case 'admin':
                        // Only admins can access Admin Console
                        if (!isAdmin(userEmail)) {
                            return (
                                <div className="flex items-center justify-center h-64">
                                    <div className="text-center">
                                        <i data-lucide="shield-x" className="w-16 h-16 text-red-500 mx-auto mb-4"></i>
                                        <h2 className="text-xl font-bold text-ocean-900 mb-2">Admin Access Required</h2>
                                        <p className="text-graystone-600 mb-4">You must be an administrator to access this area.</p>
                                        <button
                                            onClick={() => setCurrentView('dashboard')}
                                            className="px-4 py-2 bg-ocean-500 text-white rounded-lg hover:bg-ocean-600 transition"
                                        >
                                            Return to Dashboard
                                        </button>
                                    </div>
                                </div>
                            );
                        }
                        return (
                            <AdminConsole
                                onBack={() => handleNavigate('dashboard')}
                                currentUserEmail={userEmail}
                            />
                        );

                    default:
                        // Default to dashboard instead of menu
                        return <Dashboard entries={entries} currentUser={currentUser} onOpenEntry={handleOpenEntry} />;
                }
            };


            // Show loading while checking auth
            if (!authChecked) {
                return (
                    <div className="min-h-screen flex items-center justify-center" style={{ backgroundColor: '#cfebf8' }}>
                        <div className="text-center">
                            <div className="w-12 h-12 border-4 border-ocean-200 border-t-ocean-600 rounded-full animate-spin mx-auto mb-4"></div>
                            <div className="text-ocean-700">Loading...</div>
                        </div>
                    </div>
                );
            }

            // Show login screen if auth is enabled and user not authenticated
            if (AUTH_CONFIG.AUTH_ENABLED && !authUser) {
                return <LoginScreen onAuthChange={handleAuthChange} />;
            }

            return (
                <div className="flex h-screen overflow-hidden" style={{ backgroundColor: '#cfebf8' }}>
                    {/* Sidebar */}
                    <Sidebar
                        currentView={currentView}
                        onNavigate={handleNavigate}
                        currentUser={currentUser}
                        userEmail={userEmail}
                        onSignOut={handleSignOut}
                    />

                    {/* Main Content Area */}
                    <div className="flex-1 overflow-y-auto ml-64" style={{ backgroundColor: '#cfebf8' }}>
                        <div className="container mx-auto p-8 max-w-7xl">
                            {renderContent()}
                        </div>
                    </div>

                    {/* Stats Modal - Global */}
                    {showStatsModal && (
                        <div className="fixed inset-0 flex items-center justify-center bg-black bg-opacity-30 z-50">
                            <div className="bg-white rounded-2xl p-6 w-full max-w-2xl max-h-[80vh] overflow-hidden shadow-xl animate-in fade-in zoom-in-95 duration-200">
                                <div className="flex items-center justify-between mb-4">
                                    <div>
                                        <h3 className="font-heading text-2xl text-ocean-900 tracking-wide">{statsModalTitle}</h3>
                                        <p className="text-xs text-graystone-600">{statsModalItems.length} item{statsModalItems.length === 1 ? "" : "s"}</p>
                                    </div>
                                    <button
                                        onClick={closeStatsModal}
                                        className="w-8 h-8 flex items-center justify-center rounded-full bg-ocean-500 hover:bg-ocean-600 transition-colors"
                                    >
                                        <i data-lucide="x" className="w-5 h-5 text-white"></i>
                                    </button>
                                </div>

                                <div className="overflow-y-auto max-h-[60vh] space-y-2">
                                    {statsModalItems.length ? (
                                        statsModalItems.map((item) => (
                                            <button
                                                key={item.id || item.title}
                                                onClick={() => {
                                                    closeStatsModal();
                                                    if (item.kind === "subtask" && item.parentId) {
                                                        handleOpenEntry(item.parentId);
                                                    } else if (item.id) {
                                                        handleOpenEntry(item.id);
                                                    }
                                                }}
                                                className="w-full flex items-center justify-between p-4 rounded-xl border border-ocean-100 hover:border-ocean-500 hover:bg-ocean-50 transition-all group text-left"
                                            >
                                                <div className="flex-1 min-w-0">
                                                    <div className="font-medium text-sm text-ocean-900 truncate mb-1 heading-font">
                                                        {item.title || "Untitled"}{item.kind === "subtask" ? " (Subtask)" : ""}
                                                    </div>
                                                    <div className="flex items-center gap-3 text-xs text-graystone-600 flex-wrap">
                                                        {item.kind === "subtask" && item.parentTitle && (
                                                            <span className="flex items-center gap-1">
                                                                <i data-lucide="folder" className="w-3 h-3"></i>
                                                                {item.parentTitle}
                                                            </span>
                                                        )}
                                                        {item.owner && (
                                                            <span className="flex items-center gap-1">
                                                                <i data-lucide="user" className="w-3 h-3"></i>
                                                                {item.owner}
                                                            </span>
                                                        )}
                                                        {item.team && (
                                                            <span className="flex items-center gap-1">
                                                                <i data-lucide="users" className="w-3 h-3"></i>
                                                                {item.team}
                                                            </span>
                                                        )}
                                                        {(item.date || item.timelineValue) && (
                                                            <span className="flex items-center gap-1">
                                                                <i data-lucide="calendar" className="w-3 h-3"></i>
                                                                {item.date || item.timelineValue}
                                                            </span>
                                                        )}
                                                        {item.deadline && (
                                                            <span className="flex items-center gap-1">
                                                                <i data-lucide="calendar" className="w-3 h-3"></i>
                                                                {item.deadline}
                                                            </span>
                                                        )}
                                                    </div>
                                                </div>
                                                <div className="flex items-center gap-2 ml-4">
                                                    {item.workflowStatus && (
                                                        <Badge variant="secondary" className="text-[10px]">
                                                            {item.workflowStatus}
                                                        </Badge>
                                                    )}
                                                    <i data-lucide="external-link" className="w-5 h-5 text-graystone-300 group-hover:text-ocean-500"></i>
                                                </div>
                                            </button>
                                        ))
                                    ) : (
                                        <div className="text-center py-12 text-graystone-400">
                                            <i data-lucide="inbox" className="w-12 h-12 mx-auto mb-3 opacity-50"></i>
                                            <p className="text-sm">No items to show</p>
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Subtask Creation Modal - Global */}
                    {showSubtaskModal && (
                        <div className="fixed inset-0 flex items-center justify-center bg-black bg-opacity-30 z-50">
                            <div className="bg-white rounded-2xl p-6 w-full max-w-md shadow-lg animate-in fade-in zoom-in-95 duration-200">
                                <div className="flex items-center justify-between mb-4">
                                    <h3 className="text-lg font-bold text-ocean-900">Create Subtask</h3>
                                    <button
                                        onClick={closeSubtaskModal}
                                        className="w-8 h-8 flex items-center justify-center rounded-full bg-ocean-500 hover:bg-ocean-600 transition-colors"
                                    >
                                        <i data-lucide="x" className="w-5 h-5 text-white"></i>
                                    </button>
                                </div>
                                <div className="space-y-4">
                                    <div>
                                        <label className="text-sm font-medium text-graystone-700 mb-1 block">Title</label>
                                        <input
                                            type="text"
                                            placeholder="What needs to be done?"
                                            value={newSubtaskTitle}
                                            onChange={e => setNewSubtaskTitle(e.target.value)}
                                            className={inputBaseClasses}
                                            autoFocus
                                        />
                                    </div>
                                    <div className="grid grid-cols-2 gap-4">
                                        <div>
                                            <label className="text-sm font-medium text-graystone-700 mb-1 block">Deadline</label>
                                            <input
                                                type="date"
                                                value={newSubtaskDeadline}
                                                onChange={e => setNewSubtaskDeadline(e.target.value)}
                                                className={inputBaseClasses}
                                            />
                                        </div>
                                        <div>
                                            <label className="text-sm font-medium text-graystone-700 mb-1 block">Assign To</label>
                                            <select
                                                value={newSubtaskOwner}
                                                onChange={e => setNewSubtaskOwner(e.target.value)}
                                                className={cx(selectBaseClasses, "w-full")}
                                            >
                                                <option value="">Select User...</option>
                                                {USERS.map(u => <option key={u} value={u}>{u}</option>)}
                                            </select>
                                        </div>
                                    </div>
                                    <div>
                                        <label className="text-sm font-medium text-graystone-700 mb-1 block">Context / Notes</label>
                                        <textarea
                                            placeholder="Add any extra details..."
                                            value={newSubtaskContext}
                                            onChange={e => setNewSubtaskContext(e.target.value)}
                                            className={cx(inputBaseClasses, "min-h-[80px]")}
                                        />
                                    </div>
                                    <div className="flex justify-end space-x-3 pt-2">
                                        <button onClick={closeSubtaskModal} className="px-4 py-2 text-sm font-medium text-graystone-600 hover:text-graystone-800 transition-colors">Cancel</button>
                                        <button
                                            onClick={() => handleAddSubtask(modalEntryId)}
                                            disabled={!newSubtaskTitle.trim()}
                                            className="px-4 py-2 bg-ocean-600 text-white text-sm font-medium rounded-lg hover:bg-ocean-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors shadow-sm"
                                        >
                                            Create Subtask
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Add Item Choice Modal */}
                    {showAddItemModal && (
                        <div className="fixed inset-0 flex items-center justify-center bg-black bg-opacity-30 z-50">
                            <div className="bg-white rounded-2xl p-8 w-full max-w-md shadow-xl animate-in fade-in zoom-in-95 duration-200">
                                <div className="flex items-center justify-between mb-2">
                                    <h3 className="font-heading text-2xl text-ocean-900 tracking-wide">What would you like to create?</h3>
                                    <button
                                        onClick={() => setShowAddItemModal(false)}
                                        className="w-8 h-8 flex items-center justify-center rounded-full bg-ocean-500 hover:bg-ocean-600 transition-colors"
                                    >
                                        <i data-lucide="x" className="w-5 h-5 text-white"></i>
                                    </button>
                                </div>
                                <p className="text-sm text-graystone-600 mb-6">Choose the type of item you want to add</p>

                                <div className="space-y-3">
                                    {/* To-Do Option */}
                                    <button
                                        onClick={() => {
                                            setShowAddItemModal(false);
                                            setCurrentView('todo');
                                        }}
                                        className="w-full flex items-center gap-4 p-4 rounded-xl border-2 border-ocean-100 hover:border-ocean-500 hover:bg-ocean-50 transition-all group"
                                    >
                                        <div className="w-12 h-12 bg-ocean-500 rounded-xl flex items-center justify-center group-hover:scale-110 transition-transform">
                                            <i data-lucide="check-square" className="w-6 h-6 text-white"></i>
                                        </div>
                                        <div className="flex-1 text-left">
                                            <div className="font-heading text-base text-ocean-900 tracking-wide">To-Do Item</div>
                                            <div className="text-xs text-graystone-600">Quick task or reminder</div>
                                        </div>
                                        <i data-lucide="chevron-right" className="w-5 h-5 text-graystone-400 group-hover:text-ocean-500"></i>
                                    </button>

                                    {/* Project Option */}
                                    <button
                                        onClick={() => {
                                            setShowAddItemModal(false);
                                            setCurrentView('add-item');
                                        }}
                                        className="w-full flex items-center gap-4 p-4 rounded-xl border-2 border-ocean-100 hover:border-ocean-500 hover:bg-ocean-50 transition-all group"
                                    >
                                        <div className="w-12 h-12 bg-ocean-500 rounded-xl flex items-center justify-center group-hover:scale-110 transition-transform">
                                            <i data-lucide="folder-plus" className="w-6 h-6 text-white"></i>
                                        </div>
                                        <div className="flex-1 text-left">
                                            <div className="font-heading text-base text-ocean-900 tracking-wide">New Project</div>
                                            <div className="text-xs text-graystone-600">Full project with details</div>
                                        </div>
                                        <i data-lucide="chevron-right" className="w-5 h-5 text-graystone-400 group-hover:text-ocean-500"></i>
                                    </button>
                                </div>

                                <button
                                    onClick={() => setShowAddItemModal(false)}
                                    className="w-full mt-4 px-4 py-2 text-sm font-medium text-graystone-600 hover:text-graystone-800 transition-colors"
                                >
                                    Cancel
                                </button>
                            </div>
                        </div>
                    )}

                    {/* Saving Overlay */}
                    {saving && (
                        <div className="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-[100]">
                            <div className="bg-white rounded-2xl p-8 shadow-xl text-center">
                                <div className="w-12 h-12 border-4 border-ocean-200 border-t-ocean-600 rounded-full animate-spin mx-auto mb-4"></div>
                                <div className="text-lg font-medium text-ocean-900">Saving...</div>
                                <div className="text-sm text-graystone-500 mt-1">Please wait</div>
                            </div>
                        </div>
                    )}

                    {/* Error Toast */}
                    {saveError && (
                        <div className="fixed bottom-6 right-6 z-[100] animate-in slide-in-from-bottom-4 duration-300">
                            <div className="bg-red-50 border border-red-200 text-red-700 px-6 py-4 rounded-xl shadow-lg flex items-center gap-3">
                                <i data-lucide="alert-circle" className="w-5 h-5"></i>
                                <span>{saveError}</span>
                                <button
                                    onClick={() => setSaveError("")}
                                    className="ml-2 text-red-500 hover:text-red-700"
                                >
                                    <i data-lucide="x" className="w-4 h-4"></i>
                                </button>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById("root"));
        root.render(<App />);

        // Initialize Lucide icons after initial render
        setTimeout(() => lucide.createIcons(), 0);
    </script>
</body>

</html>
